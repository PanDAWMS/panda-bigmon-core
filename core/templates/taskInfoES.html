{% extends "_base_core.html" %}

{% load staticfiles %}
{% block page_title %} {{ jeditaskid }} ES task {% endblock %}
{% block title %} <a class="menu-link" href="{% url 'index' %}">{{ viewParams.MON_VO }} PanDA monitor</a>{% endblock %}
{% block extra_js %}
<script  type="text/javascript" src="/static/js/d3jsplot.js"></script>
<link rel="stylesheet" type="text/css" href="/static/js/datatables/datatables.min.css"/>
<script type="text/javascript" src="/static/js/datatables/datatables.min.js"></script>
<script type="text/javascript" src="/static/js/datatables/dataTables.rowsGroup.js"></script>

<script>
function toggleDetailDisplay(className) {
   el = document.getElementsByClassName(className);
   for (i=0; i<el.length; i++) {
     el[i].style.display = (el[i].style.display=="none") ? "" : "none";
   }
}

function toggleRowsDisplay(className) {
   el = document.getElementsByClassName(className)
   for (i=0; i<el.length; i++) {
     el[i].style.display = (el[i].style.display=="none") ? "" : "none";
   }
}

function killtasks(taskID, action) {
    var message = ''
    if (action == 0)
        message = 'Are you sure you want to FINISH this task?'
    else
        message = 'Are you sure you want to ABORT this task?'
    if (confirm(message)) {
        $.ajax({
            url: {% url 'killtasks' %},
            data: {'task': taskID, 'action': action},
            async: true
        })
            .done(function (response) {
                var parcedResponse = $.parseJSON(response);
                alert(parcedResponse.detail);
                location.reload();
            });
    } else {
        // Do nothing!
    }
}

function loadErrorSummaryData(jeditaskid, mode, tk) {

   $('#div-error-sum').html("<img src='{% static "images/load.gif" %}'>  ");
   $.ajax({
       url: {% url 'eventsErrorSummary' %},
       data: {'jeditaskid' : jeditaskid, 'mode': mode , 'tk': tk },
       async: true
   })
   .done(function (response) {
       $('#div-error-sum').html(response);
   });
}

function buildNeventsPlot(idname, classname) {
    if ( !document.getElementById(idname).innerHTML ) {
        var nevents = {{ plotsDict.nevents|safe }};
        if (nevents.length > 0) {pandamonplotHist(nevents, "#plot0", "Number of events histogram (finished non-merge jobs)");}
        toggleDetailDisplay(classname)
    }
    else {
        toggleDetailDisplay(classname)
    }
}

function buildPlots(classname) {

   el = document.getElementsByClassName(classname);
   var flag = 0;
   for (i=0; i<el.length; i++) {
     flag = (el[i].innerHTML) ? flag : flag+1;
   }
    if (flag > 0) {
        $("#jobsconsumptionplots").html("<img src='{% static "images/load.gif" %}'>  ");
        var values1 = {{ plotsDict.maxpss|safe }};
        var values2 = {{ plotsDict.walltime|safe }};
        var values3 = {{ plotsDict.maxpssf|safe }};
        var values4 = {{ plotsDict.walltimef|safe }};
        var values5 = {{ plotsDict.maxpsspercore|safe }};
        var values6 = {{ plotsDict.maxpsspercoref|safe }};
        var values7 = {{ plotsDict.hs06s|safe }};
        var values8 = {{ plotsDict.hs06sf|safe }};
        var values9 = {{ plotsDict.walltimeperevent|safe }};
        if (values1.length > 0) {pandamonplotHist(values1,  "#plot1", "Maximum PSS histogram");}
        if (values3.length > 0) {pandamonplotHist(values3,  "#plot3", "Maximum PSS histogram (failed jobs)");}
        if (values2.length > 0) {pandamonplotHist(values2,  "#plot2", "Walltime histogram");}
        if (values4.length > 0) {pandamonplotHist(values4,  "#plot4", "Walltime histogram (failed jobs)");}
        if (values5.length > 0) {pandamonplotHist(values5,  "#plot5", "Maximum PSS per core histogram");}
        if (values6.length > 0) {pandamonplotHist(values6,  "#plot6", "Maximum PSS per core histogram (failed jobs)");}
        if (values7.length > 0) {pandamonplotHist(values7,  "#plot7", "HS06s histogram");}
        if (values8.length > 0) {pandamonplotHist(values8,  "#plot8", "HS06s histogram (failed jobs)");}
        if (values9.length > 0) {pandamonplotHist(values9,  "#plot9", "Walltime per event histogram");}
        $("#jobsconsumptionplots").html("");
        toggleDetailDisplay(classname);
    }
    else {
       toggleDetailDisplay(classname);
    }
}

</script>
{% endblock %}

{% block subtitle %}PanDA Event Service task {{ jeditaskid }} at {{ task.site }} {% endblock %}


{% block body %}

{% if columns %}

<table>
<tr bgcolor='lightcyan'><th colspan=20> Event Service Task {{ jeditaskid }} at site <a href="{% url 'siteInfo' task.site %}">{{ task.site }}</a> </th></tr>
<tr bgcolor='lightcyan'>
	<th>Task ID</th>
    {% if task.deftreqid %} <th> Request </th> {% endif %}
	{% if task.reqid != task.jeditaskid and not task.deftreqid %}<th>Jobset</th>{% endif %}
	<th>Type</th>
	<th>Processing type</th>
	<th>Transform</th>
	<th>User</th>
	{% if task.campaign %} <th> Campaign </th> {% endif %}
	<th>Task status </th>{% if task.superstatus %} {% if task.superstatus != task.status %}<th> Detailed JEDI status </th>{% endif %} {% endif %}
{% if task.dsinfo %}
    <th> Nevents | <span class='finished'>used</span> </th>
    <th style="white-space: nowrap">HS06*sec<br> Expected<br> Total<br><span class='done'>done</span><br> <span class='failed'>failed</span></th>
    <th> Ninputfiles | <span class='finished'>finished</span> | <span class='failed'>failed</span> </th>
{% endif %}
	<th>Created</th>
	<th>Modified</th>
	<th>Cores</th>
	<th>Priority</th>
	{% if task.ticketid %} <th>Tracker</th> {% endif %}
</tr>
	<tr>
		<td><a href="{% url 'taskInfo' task.jeditaskid %}">{{ task.jeditaskid }}</a></td>
        {% if task.deftreqid %} <td> <a href="https://prodtask-dev.cern.ch/prodtask/inputlist_with_request/{{task.deftreqid}}/">{{task.deftreqid}}</a> </td> {% endif %}
		{% if task.reqid != task.jeditaskid and not task.deftreqid %}<td>{{ task.reqid }}</td>{% endif %}
		<td>{{ task.tasktype }}</td>
		<td>{% if task.processingtype %} {{ task.processingtype }} {% endif %} </td>
		<td> {{ task.transpath }} </td>
		<td><a href="{% url 'taskList' %}?username={{ task.username }}">{{ task.username }}</a></td>
		{% if task.campaign %} <td><a href='/tasks/?campaign={{ task.campaign }}'>{{ task.campaign }}</a></td> {% endif %}
		<td class='{{task.status}}_fill'>{% if task.superstatus %}<b><a href="https://twiki.cern.ch/twiki/bin/view/PanDA/PandaJEDI#Transition_of_task_status" class="{{ task.superstatus }}_tooltip">{{ task.superstatus }}</a></b> {% if task.superstatus != task.status %}<td class='{{task.status}}'><a href="https://twiki.cern.ch/twiki/bin/view/PanDA/PandaJEDI#Transition_of_task_status" class="{{ task.status }}_tooltip">{{ task.status }}</a></td>{% endif %} {% else %}<a href="https://twiki.cern.ch/twiki/bin/view/PanDA/PandaJEDI#Transition_of_task_status" class="{{ task.superstatus }}_tooltip">{{ task.status }}</a>{% endif %}</td>

{% if task.dsinfo %}
        <td> {{task.totev}} |
            <span class='finished'>{{task.totevproc}} ({{task.pctfinished}}%)</span></td>
        <td style="text-align:right;"> {{task.totevhs06}}<br>{{task.currenttotevhs06}}<br><span class='finished'>{{task.totevprochs06}}</span> <br> <span class='failed'>{{task.failedevprochs06}}</span></td>
        <td> {{task.dsinfo.nfiles}} |
            <span class='finished'>{{task.dsinfo.nfilesfinished}} ({{task.dsinfo.pctfinished}}%)</span> {% if task.dsinfo.nfilesfailed > 0 %} | <span class='failed'>{{task.dsinfo.nfilesfailed}} ({{task.dsinfo.pctfailed}}%)</span>  {% endif %} </td>
{% endif %}

		<td>{{ task.creationdate }}</td>
		<td>{{ task.modificationtime }}</td>
		<td>{{ task.corecount }}</td>
		<td>{{ task.taskpriority }}</td>
{% if task.ticketid %}
        <td><a href="https://its.cern.ch/jira/browse/{{ task.ticketid }}">{{ task.ticketsystemtype }}</a></td>
{% endif %}
	</tr>
</table>


<div>
    <span class="warning" style="float: left; font-weight: bold; padding-top: 10px">!!! All links are here &#x279c; &nbsp; </span>
</div>
<div class="dropdownplots">
  <button class="dropdownbutton">Go to</button>
  <div id="dropdown-plotchoice" class="dropdown-plot">

    <a style="cursor: pointer;" onclick="javascript:toggleDetailDisplay('badevents');">Show exhausted events</a>

    {% if requestParams.mode and requestParams.mode == 'nodrop' %}
        <a style="cursor: pointer;" href="{{nomodeurl}}mode=drop">Drop mode</a>
    {% else%}
        <a style="cursor: pointer;" href="{{nomodeurl}}mode=nodrop">Nodrop mode</a>
    {% endif %}
    {% if vomode == 'atlas' %}
        {%  if task.tasktype == 'prod' %}
            <a href="https://prodtask-dev.cern.ch/prodtask/task_manage/#/?time_period=custom&task_type=production&task_id={{ task.jeditaskid }}" target="_blank">Prod Task view (to manage task)</a>
            <a href="https://prodtask-dev.cern.ch/prodtask/task/{{ task.jeditaskid }}/">Prod Task page</a>
        {% endif %}
    {% endif %}
    <a target="_blank" href="https://es-atlas.cern.ch/kibana/app/kibana?#/discover?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:'{{ task.kibanatimefrom }}',mode:quick,to:'{{ task.kibanatimeto }}'))&_a=(columns:!('timeEvent',type,logLevel,message),filters:!(),index:'atlas_jedilogs-*',interval:auto,query:(query_string:(analyze_wildcard:!t,query:'type:%22atlasprodtaskbroker%22%20AND%20jediTaskID:{{jeditaskid}}')),sort:!('timeEvent',asc),vis:(aggs:!((params:(field:jediTaskID,orderBy:'2',size:20),schema:segment,type:terms),(id:'2',schema:metric,type:count)),type:histogram))&indexPattern=atlas_jedilogs-*&type=histogram">Task brokerage </a>

    <a target="_blank" href="https://es-atlas.cern.ch/kibana/app/kibana?#/discover?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:'{{ task.kibanatimefrom }}',mode:quick,to:'{{ task.kibanatimeto }}'))&_a=(columns:!('timeEvent',type,message),filters:!(),index:'atlas_jedilogs-*',interval:auto,query:(query_string:(analyze_wildcard:!t,query:'type:%22{% if taskbrokerage == 'prod_brokerage' %}atlasprodjobbroker{% else %}atlasanaljobbroker{% endif %}%22%20AND%20jediTaskID:{{jeditaskid}}')),sort:!('timeEvent',desc),vis:(aggs:!((params:(field:jediTaskID,orderBy:'2',size:20),schema:segment,type:terms),(id:'2',schema:metric,type:count)),type:histogram))&indexPattern=atlas_jedilogs-*&type=histogram">Job brokerage </a>

    <a target="_blank" href="https://es-atlas.cern.ch/kibana/app/kibana?#/discover?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:'{{ task.kibanatimefrom }}',mode:quick,to:'{{ task.kibanatimeto }}'))&_a=(columns:!('timeEvent',type,logLevel,message),index:'atlas_jedilogs-*',interval:auto,query:(query_string:(analyze_wildcard:!t,query:'jediTaskID:{{jeditaskid}}')),sort:!('timeEvent',desc))">Action logger</a>
    <a target="_blank" href="https://es-atlas.cern.ch/kibana/app/kibana?#/discover?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:'{{ task.kibanatimefrom }}',mode:quick,to:'{{ task.kibanatimeto }}'))&_a=(columns:!('timeEvent',logName,type,logLevel,message),index:'atlas_pandalogs-*',interval:auto,query:(query_string:(analyze_wildcard:!t,query:'logName:%22panda.log.RetrialModule%22%20AND%20type:%22retrialmodule%22%20AND%20jediTaskID:{{jeditaskid}}')),sort:!('timeEvent',desc))">Retrial Module logger</a>
    <a href="{% url 'errorSummary' %}?jeditaskid={{jeditaskid}}">Error summary</a>
    {% if task.parent_tid != task.jeditaskid and task.parent_tid != None %}
        <a href="{% url 'taskInfo' task.parent_tid %}">Parent task {{ task.parent_tid }}</a>
    {% endif %}
    <a href="{% url 'taskList' %}?parent_tid={{ task.jeditaskid }}&display_limit=100">Child tasks</a>
    {% if task.ttcrequested != None and task.starttime != None%}
        <a href="{% url 'ttc' %}?jeditaskid={{jeditaskid}}" target="_blank">TTC page</a>
    {% endif %}
  </div>
</div>

<div class="dropdownplots">
  <button class="dropdownbutton">Show jobs</button>
  <div id="dropdown-plotchoice" class="dropdown-plot">
    {% if jobsummary %}
        <a href="{% url 'jobList' %}?jeditaskid={{jeditaskid}}&mode=nodrop&display_limit=100">All (access to job details and logs)</a>
        <a href="{% url 'jobList' %}?jeditaskid={{jeditaskid}}&jobstatus=finished|failed|cancelled">Ended</a>
        <a href="{% url 'jobList' %}?jeditaskid={{jeditaskid}}&jobstatus=defined|waiting|pending|assigned|throttled|activated|sent|starting|running|holding|transferring">Active</a>
    {% endif %}
  </div>
</div>

<div class="dropdownplots">
  <button class="dropdownbutton">Jump to</button>
  <div id="dropdown-plotchoice" class="dropdown-plot">
    <a href="#jobparams">Job parameters</a>
    {% if jobscoutids.cputimescoutjob|length > 0 or jobscoutids.walltimescoutjob|length > 0 %}
        <a href="#scouts">Scout jobs</a>
    {% endif %}
    {% if taskparaml %}
        <a href="#taskparamsprodsys">Prodsys task parameters</a>
    {% endif %}
    <a href="#taskparamsjedi">PanDA/JEDI task parameters</a>
    <a href="#help">Help</a>
  </div>
</div>

<div class="dropdownplots">
  <button class="dropdownbutton">Open plot</button>
  <div id="dropdown-plotchoice" class="dropdown-plot">
    <a style="cursor: pointer;" onclick="javascript:buildNeventsPlot('plot0' ,'nevents_plot');">Number of events distribution plot</a>
    <a style="cursor: pointer;" onclick="javascript:buildPlots('d3splot');">Memory and Walltime usage</a>
    <a href="http://atlas-kibana.mwt2.org:5601/app/kibana#/dashboard/BP_a_task?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:'{{ task.kibanatimefrom }}',mode:absolute,to:'{{ task.kibanatimeto }}'))&_a=(filters:!(),options:(darkTheme:!t),panels:!((col:1,id:BP_Walltime_all_jobs,panelIndex:1,row:1,size_x:6,size_y:3,type:visualization),(col:7,id:BP_Walltime_failed_jobs,panelIndex:2,row:1,size_x:6,size_y:3,type:visualization),(col:1,id:BP_MAX_PSS_all_jobs,panelIndex:3,row:4,size_x:6,size_y:3,type:visualization),(col:7,id:BP_MAX_PSS_failed_jobs,panelIndex:4,row:4,size_x:6,size_y:3,type:visualization),(col:1,id:BP_MAX_PSS_per_core_all_jobs,panelIndex:5,row:7,size_x:6,size_y:3,type:visualization),(col:7,id:BP_MAX_PSS_per_core_failed_jobs,panelIndex:6,row:7,size_x:6,size_y:3,type:visualization)),query:(query_string:(analyze_wildcard:!t,lowercase_expanded_terms:!f,query:'jeditaskid:{{ task.jeditaskid }}')),title:BP_a_task,uiState:(P-1:(spy:(mode:(fill:!f,name:!n)),vis:(legendOpen:!t))))" target="_blank">Memory and Walltime usage (Kibana)</a>
    {% if not task.tasktype == 'anal' %}
        <a href="{% url 'ganttTaskChain' %}?jeditaskid={{ task.jeditaskid }}" target="_blank">Task Chain (Gantt diagram)</a>
        <a href="{% url 'taskchain' %}?jeditaskid={{ task.jeditaskid }}" target="_blank">Task Chain (Tree diagram)</a>
    {% endif %}
    {% if showtaskprof == True %}
        <a href="{% url 'taskprofileplot' %}?jeditaskid={{ task.jeditaskid }}" target="_blank">Task Profile</a>
        <a href="{% url 'taskesprofileplot' %}?jeditaskid={{ task.jeditaskid }}" target="_blank">Events Processing Profile (Not dropped finished jobs)</a>
    {% endif %}
    <a href="http://atlas-kibana.mwt2.org:5601/app/kibana#/dashboard/9058c590-200d-11e7-84dc-8d3ed2710506?_g=(filters:!(),refreshInterval:(display:Off,pause:!f,value:0),time:(from:'{{ task.kibanatimefrom }}',mode:quick,to:'{{ task.kibanatimeto }}'))&_a=(filters:!(),options:(darkTheme:!t),panels:!((col:1,id:'3f4fa5d0-2001-11e7-a8cf-1bce3a1c32b4',panelIndex:1,row:1,size_x:3,size_y:3,type:visualization),(col:4,id:'94d395c0-2001-11e7-a8cf-1bce3a1c32b4',panelIndex:3,row:1,size_x:5,size_y:4,type:visualization),(col:1,id:'88c1ea50-2003-11e7-983d-8109a2d43cab',panelIndex:4,row:5,size_x:6,size_y:5,type:visualization),(col:9,id:c3a6e3c0-2001-11e7-a8cf-1bce3a1c32b4,panelIndex:5,row:1,size_x:4,size_y:4,type:visualization),(col:7,id:'88e76c50-2006-11e7-983d-8109a2d43cab',panelIndex:6,row:5,size_x:6,size_y:5,type:visualization),(col:1,id:b2c68750-2005-11e7-983d-8109a2d43cab,panelIndex:7,row:10,size_x:5,size_y:3,type:visualization),(col:6,id:f0d9a450-2005-11e7-983d-8109a2d43cab,panelIndex:8,row:10,size_x:6,size_y:3,type:visualization),(col:1,id:c9e1f1d0-2006-11e7-983d-8109a2d43cab,panelIndex:9,row:13,size_x:2,size_y:3,type:visualization),(col:3,id:'7c88d960-2008-11e7-983d-8109a2d43cab',panelIndex:10,row:13,size_x:10,size_y:3,type:visualization),(col:9,id:'12a10860-2008-11e7-983d-8109a2d43cab',panelIndex:12,row:16,size_x:4,size_y:3,type:visualization),(col:5,id:'0b3a75d0-2007-11e7-983d-8109a2d43cab',panelIndex:13,row:16,size_x:4,size_y:3,type:visualization),(col:1,id:'52964850-2007-11e7-983d-8109a2d43cab',panelIndex:14,row:16,size_x:4,size_y:3,type:visualization),(col:1,id:b07c2fe0-200a-11e7-983d-8109a2d43cab,panelIndex:15,row:19,size_x:12,size_y:4,type:visualization),(col:1,id:'039a7c60-2009-11e7-983d-8109a2d43cab',panelIndex:16,row:23,size_x:12,size_y:5,type:visualization)),query:(query_string:(analyze_wildcard:!t,lowercase_expanded_terms:!f,query:'jeditaskid:{{ task.jeditaskid }}')),title:BP_ES_task,uiState:(P-1:(vis:(legendOpen:!f)),P-10:(vis:(legendOpen:!f)),P-13:(vis:(legendOpen:!f)),P-14:(vis:(legendOpen:!f)),P-15:(vis:(legendOpen:!f)),P-16:(spy:(mode:(fill:!f,name:!n)),vis:(legendOpen:!f)),P-3:(vis:(legendOpen:!f)),P-4:(vis:(legendOpen:!f)),P-5:(vis:(legendOpen:!f)),P-6:(vis:(legendOpen:!f)),P-7:(vis:(legendOpen:!f)),P-8:(vis:(legendOpen:!f)),P-9:(vis:(legendOpen:!f))))" target="_blank">ES task dashboard (Kibana)</a>
  </div>
</div>

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
    <div class="badevents" ng-app="taskESApps" ng-controller="taskEventsController" style="display:none;">
        <p>
        <table>
            <tr bgcolor="lightcyan"><th colspan=4>Exhausted events</th></tr>
            <tr>
                <th>Error</th>
                <th>Count</th>
                <th>PandaIDs</th>
                <th>Events</th>
            </tr>

            <tbody ng-repeat="row in eventsrows">
                <tr>
                    <td>{$ row.ERROR_CODE $}</td>
                    <td>{$ row.COUNT $}</td>
                    <td>{$ row.PANDAIDS.join(', ') $}</td>
                    <td>{$ row.EVENTS.join(', ') $}</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
    var app = angular.module('taskESApps', []).config(function ($interpolateProvider) {
        $interpolateProvider.startSymbol('{$');
        $interpolateProvider.endSymbol('$}');
    });

    app.controller('taskEventsController', function ($scope,  $http) {
        $scope.eventsrows = [];

        $http({
                 url: '{% url 'getbadeventsforfask' %}?jeditaskid={{ jeditaskid }}&mode={{ requestParams.mode }}',
                 method: "GET",
            }).then(function successCallback(response) {
                    $scope.eventsrows = response.data;
              }, function errorCallback(response) {

              });

        });
    </script>




    {% with 'done finished failed ready broken aborted defined' as finalstatelist %}
        {% if not task.status in finalstatelist %}
            <div style="float: right">
               <a onclick="javascript:killtasks({{ task.jeditaskid }}, 0);" class='killbutton'>Finish</a>
                <a onclick="javascript:killtasks({{ task.jeditaskid }}, 1);" class='killbutton'>Abort</a>
           </div>
        {% endif %}
    {% endwith %}

<p>

{% if jobsummary %}

<table>
<tr bgcolor="lightcyan"><th colspan=20>
<b>States of jobs in this task</b>   &nbsp; &nbsp; <a href="{% url 'jobList' %}?jeditaskid={{jeditaskid}}&eventservice=not2&display_limit=100">Show jobs</a>  &nbsp; &nbsp; &nbsp;
    {% if requestParams.mode and requestParams.mode == 'nodrop' %}
        <a style="cursor: pointer;" href="{{nomodeurl}}mode=drop">Switch to drop mode</a>
    {% else%}
        <a style="cursor: pointer;" href="{{nomodeurl}}mode=nodrop">Switch to nodrop mode</a>
    {% endif %}
</th></tr>
<tr>
{% for state in jobsummary %}
<td class="{{ state.name}}"> <b> {{ state.name }} </b> </td>
{% endfor %}
</tr><tr>
{% for state in jobsummary %}
{% if newjobsummary_test %}
{% for newstate in newjobsummary_test %}
{% if forloop.counter == forloop.parentloop.counter %}
<td {% if state.count > 0 or newstate.count > 0 %} class='{{state.name}}_fill' {% endif %}> {% if state.count > 0 or newstate.count > 0 %} <b> <a href="{% url 'jobList' %}?jeditaskid={{task.jeditaskid}}&jobstatus={{state.name}}{% ifequal requestParams.mode 'nodrop' %}&mode=nodrop{%  endifequal %}{% ifequal requestParams.mode 'drop' %}&mode=drop{%  endifequal %}&eventservice=not2&display_limit=100"><span class='{{state.name}}_fill'>{% if state.count > 0 %}{{ state.count }} ({{ newstate.count }}) {% else %} 0 ({{ newstate.count }}) {% endif %}</span></a> </b> {% endif %} </td>
{% endif %}
{% endfor %}
{% else %}
 <td {% if state.count > 0 %} class='{{state.name}}_fill' {% endif %}> {% if state.count > 0 %} <b> <a href="{% url 'jobList' %}?jeditaskid={{task.jeditaskid}}&jobstatus={{state.name}}{% ifequal requestParams.mode 'nodrop' %}&mode=nodrop{%  endifequal %}{% ifequal requestParams.mode 'drop' %}&mode=drop{%  endifequal %}&eventservice=not2&display_limit=100"><span class='{{state.name}}_fill'>{% if state.count > 0 %}{{ state.count }} {% endif %}</span></a> </b> {% endif %} </td>
{% endif %}
{% endfor %}
</table>

{% endif %}

{% if jobsummaryESMerge %}

<table>
<tr bgcolor="lightcyan"><th colspan=20>
<b>States of es_merge jobs in this task</b>   &nbsp; &nbsp; <a href="{% url 'jobList' %}?jeditaskid={{jeditaskid}}&eventservice=2&display_limit=100">Show jobs</a>
</th></tr>
<tr>
{% for state in jobsummaryESMerge %}
<td class="{{ state.name}}"> <b> {{ state.name }} </b> </td>
{% endfor %}
</tr><tr>
{% for state in jobsummaryESMerge %}
{% if newjobsummaryESMerge_test %}
{% for newstate in newjobsummaryESMerge_test %}
{% if forloop.counter == forloop.parentloop.counter %}
<td {% if state.count > 0 or newstate.count > 0 %} class='{{state.name}}_fill' {% endif %}> {% if state.count > 0 or newstate.count > 0 %} <b> <a href="{% url 'jobList' %}?jeditaskid={{task.jeditaskid}}&jobstatus={{state.name}}{% ifequal requestParams.mode 'nodrop' %}&mode=nodrop{%  endifequal %}{% ifequal requestParams.mode 'drop' %}&mode=drop{%  endifequal %}&display_limit=100&eventservice=2"><span class='{{state.name}}_fill'>{% if state.count > 0 %}{{ state.count }} ({{ newstate.count }}) {% else %} 0 ({{ newstate.count }}) {% endif%}</span></a> </b> {% endif %} </td>
{% endif %}
{% endfor %}
{% else %}
<td {% if state.count > 0 %} class='{{state.name}}_fill' {% endif %}> {% if state.count > 0 %} <b> <a href="{% url 'jobList' %}?jeditaskid={{task.jeditaskid}}&jobstatus={{state.name}}{% ifequal requestParams.mode 'nodrop' %}&mode=nodrop{%  endifequal %}{% ifequal requestParams.mode 'drop' %}&mode=drop{%  endifequal %}&display_limit=100&eventservice=2"><span class='{{state.name}}_fill'>{{ state.count }}</span></a> </b> {% endif %} </td>
{% endif %}
{% endfor %}
</table>
{% endif %}



<script type="text/javascript">
    $(document).ready(function() {

     eventchunktable = $('#eventchunktable').dataTable( {
        "aaSorting": [[ 4, "desc" ]],
        "aoColumns": [
            { "mData":"jobsetid",
              sDefaultContent: "",
              "render": function (chunk, type, full)  {
                   return '<a href="'+{% url 'jobList' %}+'?jeditaskid={{ jeditaskid }}&jobsetid='+full['jobsetid']+'">' + full['jobsetid'] + '</a>';
              },

            },
            { "mData":"attemptnrDS",
              sDefaultContent: "",
              "render": function (chunk, type, full)  {
                   var reStr = "";
                   full['prevAttempts'].forEach(function(entry) {
                        reStr += '<- <a href="'+{% url 'jobList' %}+'?jeditaskid={{ jeditaskid }}&jobsetid='+entry+'">' + entry + '</a>';
                   });
                   return reStr;
              },

            },
            {
               "mData":"status",
               sDefaultContent: "",
            },
            {
                "mData":"attemptnr",
                sDefaultContent: "",
            },
            {
                "mData":"attemptnrDS",
                sDefaultContent: "",
            },
            {
              "mData":"lfn",
              sDefaultContent: ""
            },
            {
                "mData":"startevent",
                 sDefaultContent: "",
            },
            {
                "mData":"endevent",
                sDefaultContent: "",
            },
            {
                "mData":"failedattempt",
                sDefaultContent: "",
            },
            {
                "mData":"maxfailure",
                sDefaultContent: "",
            },
            {
                "mData":"maxattempt",
                sDefaultContent: "",
            },
        ],

        "bServerSide": false,
        "searching": true,

         "ajax": {
                 "processing": true,
                 "url": "{% url 'eventschunks' %}?jeditaskid={{ jeditaskid }}",
                 "dataSrc" : ''},

        "bStateSave" : true, // optional


      initComplete: function () {
            this.api().columns([2]).every( function () {
                var column = this;
                var select = $('<select><option value="">Show all</option></select>')
                    .appendTo( $(column.header()).empty() )
                    .on( 'change', function () {
                        var val = $.fn.dataTable.util.escapeRegex(
                            $(this).val()
                        );

                        column
                            .search( val ? '^'+val+'$' : '', true, false )
                            .draw();
                    } );

                column.data().unique().sort().each( function ( d, j ) {
                    select.append( '<option value="'+d+'">'+d+'</option>' )
                } );
            } );

        }
    });
    $('#eventchunktable').click(function() { // only if you don't hardcode column widths
        eventchunktable.fnAdjustColumnSizing();
    });



        {% if eventssummary|length > 0 %}

        if ($(".showeventsdetailsrow").is(':visible'))
                $(".showeventsdetailsrow").hide();

        {% endif %}
    });
    function showEventsDetails(){
        if (!$(".showeventsdetailsrow").is(':visible')){
            $(".showeventsdetailsrow").show()}
        else {
            $(".showeventsdetailsrow").hide()}
    }
</script>


{% if eventssummary|length > 0 %}
<table>
<tr bgcolor="lightcyan"><th colspan=20>
<b>States of events in this task</b>  {% if requestParams.mode and requestParams.mode == 'nodrop' %} <a style="cursor: pointer;" onclick="javascript:showEventsDetails();" href="#">  Show details</a> {% endif %} &nbsp
</th></tr>
<tr>
{% for state in eventssummary %}
<td> <span class="{{ state.statusname}}"><b> {{ state.statusname }} </b></span>
    <span class="showeventsdetailsrow">
    <br>
        {% if state.count > 0 %}
        <b>ComputingElement, ObjectStoreID : Nevents</b>
        {% endif %}
    </span>
</td>
{% endfor %}
</tr>
    <tr>
{% for state in eventssummary %}
{% if neweventssummary_test %}
{% for newstate in neweventssummary_test %}
{% if forloop.counter == forloop.parentloop.counter %}
<td {% if state.count > 0 or newstate.count > 0 %} class='{{state.statusname}}_fill' {% endif %}> {% if state.count > 0 or newstate.count > 0 %}
    <b> <span class='{{state.statusname}}_fill'>
        {% if state.statusname == 'failed' and state.count > 0 %}
            <a onclick="javascript:loadErrorSummaryData( '{{ jeditaskid }}' , '{{ mode }}' , '{{ tk }}' );"> {{ state.count }} ({{ newstate.count }}) </a>
         {% elif  newstate.statusname == 'failed' and newstate.count > 0%}
             <a onclick="javascript:loadErrorSummaryData( '{{ jeditaskid }}' , '{{ mode }}' , '{{ tk }}' );"> {{ state.count }} ({{ newstate.count }}) </a>
        {% else %} {{ state.count }} ({{ newstate.count }})
        {% endif %}
    </span></b>
    {% endif %}
</td>

{% endif %}
{% endfor %}
{% else %}
<td {% if state.count > 0 %} class='{{state.statusname}}_fill' {% endif %}> {% if state.count > 0 %}
    <b> <span class='{{state.statusname}}_fill'>
        {% if state.statusname == 'failed' and state.count > 0 %}
            <a onclick="javascript:loadErrorSummaryData( '{{ jeditaskid }}' , '{{ mode }}' , '{{ tk }}' );"> {{ state.count }} </a>
        {% else %} {{ state.count }}
        {% endif %}
    </span></b>
    {% endif %}
</td>
 {% endif %}
{% endfor %}</tr>
{% if ossummary|length > 0 %}
<tr class="showeventsdetailsrow" >
{% for state in eventssummary %}
    <td {% if state.count > 0 %} class='{{state.name}}_fill' {% endif %}>
    {% for osrow in ossummary %}
        {% if state.statusname == osrow.statusname %} {{ osrow.computingelement }}, {% if osrow.objectstoreid != None %} {{ osrow.objectstoreid }} {% else %} unknown {% endif %} : {{ osrow.nevents }} <br> {% endif %}
    {% endfor %}
    </td>
{% endfor %}
</tr>
{% endif %}
</table>
{% endif %}


<p>
<div id="div-error-sum">

</div>
<p>

<p>
{% if task.errordialog %}
<table width=1000><tr><td bgcolor="#FFFBDA"><font color='brown'> <b>Logged status: {{ task.errordialog|safe }}</b></font></td></tr>
{% if logtxt %}
<tr><td>
<font size=-1><pre>
{{ logtxt }}
</pre></font>
</td></tr>
{% endif %}
</table>
{% endif %}


<p>
<div id="jobsconsumptionplots"></div>
{% if  plotsDict.nevents|length > 0 %} <div class="nevents_plot" id="plot0" style="align:left;display:none;font-size: 12px"></div><br style="clear:both;"> {% endif %}

{% if  plotsDict.maxpss|length > 0 %} <div class="d3splot" id="plot1" style="float:left;display:none"></div> {% endif %}
{% if  plotsDict.walltime|length > 0 %} <div class="d3splot" id="plot2" style="float:left;display:none"></div> {% endif %}
{% if  plotsDict.maxpsspercore|length > 0 %} <div class="d3splot" id="plot5" style="float:left;display:none"></div> {% endif %}
{% if  plotsDict.hs06s|length > 0 %} <div class="d3splot" id="plot7" style="float:left;display:none"></div> {% endif %}
{% if  plotsDict.walltimeperevent|length > 0 %} <div class="d3splot" id="plot9" style="float:left;display:none"></div> {% endif %}
    <br style="clear:both;">
{% if  plotsDict.maxpssf|length > 0 %} <div class="d3splot" id="plot3" style="float:left;display:none"></div> {% endif %}
{% if  plotsDict.walltimef|length > 0 %} <div class="d3splot" id="plot4" style="float:left;display:none"></div> {% endif %}
{% if  plotsDict.maxpsspercoref|length > 0 %} <div class="d3splot" id="plot6" style="float:left;display:none"></div> {% endif %}
{% if  plotsDict.hs06sf|length > 0 %} <div class="d3splot" id="plot8" style="float:left;display:none"></div> {% endif %}
<br style="clear: both;">


{% if inctrs %}
<table>
<tr bgcolor='lightcyan' >
	<th>Input containers</th>
</tr>
{% for dsrec in inctrs %}
	<tr>
		<td><font size=-1><a href="{% url 'datasetList' %}?containername={{ dsrec }}">{{ dsrec }}</a></font></td>
	</tr>
{% endfor %}
</table>
{% endif %}

{% if outctrs %}
<table>
<tr bgcolor='lightcyan' >
	<th>Output containers</th>
</tr>
{% for dsrec in outctrs %}
	<tr>
		<td><font size=-1><a href="{% url 'datasetList' %}?containername={{ dsrec }}">{{ dsrec }}</a></font></td>
	</tr>
{% endfor %}
</table>
{% endif %}

{% if datasets %}

<table>

{% if dstypes %}
<tr bgcolor='lightcyan'> <th colspan=20> 
{{ datasets|length }} datasets, show/hide by type:
&nbsp; <a style="cursor: pointer;" onclick="javascript:toggleRowsDisplay('type-all');">all</a>
{% for dst in dstypes %}
  &nbsp; <a style="cursor: pointer;" onclick="javascript:toggleRowsDisplay('type-{{ dst.type }}');">{{ dst.type }}({{ dst.count }})</a>
{% endfor %}
</th> </tr>
{% endif %}

<tr bgcolor='lightcyan' >
	<th>Dataset, container name</th>
	<th>Type</th>
	<th>Stream</th>
	<th>State</th>
	<th>Status</th>
	<th>Nfiles</th>
	<th>Created</th>
	<th>Modified</th>
</tr>

{% for dsrec in datasets %}
	<tr class="type-{{ dsrec.type }} type-all" style="display:all">
		<td><font size=-1><a href="{% url 'datasetInfo' %}?datasetid={{ dsrec.datasetid }}">{{ dsrec.datasetname }}</a></font></td>
		<td>{{ dsrec.type }}</td>
		<td>{{ dsrec.streamname }}</td>
		<td class='{{dsrec.state}}'>{{ dsrec.state }}</td>
		<td class='{{dsrec.status}}'>{{ dsrec.status }}</td>
		<td>{{ dsrec.nfiles }}</td>
		<td>{{ dsrec.creationtime }}</td>
		<td>{{ dsrec.modificationtime }}</td>
	</tr>
{% endfor %}
</table>
</p>

{% else %}

No datasets were found for this task

{% endif %}

{% if sumd %}
<table>
{% for fdict in sumd %}
<tr><th> {{ fdict.field }} </th><td>
{% for item in fdict.list %}
{% if fdict.field == 'status' %} <span class='{{item.kname}}'> {% else %} <span> {% endif %}  {{ item.kname }} </span>
<a href="{{xurl}}{{fdict.field}}={{item.kname}}">({{ item.kvalue }})</a> &nbsp; 
{% endfor %}
</td></tr>
{% endfor %}
</table>
{% endif %}

{% if jobparams %}
<table>
<a name="jobparams"></a>
<tr bgcolor='lightcyan'><th colspan=20> Job parameters </th></tr>
{% for p in jobparams %}
<tr><td><font size=-1>{{ p|safe }}</font></td></tr>
{% endfor %}
</table>
<p>
{% endif %}

{% if jobscoutids.cputimescoutjob|length > 0 or jobscoutids.walltimescoutjob|length > 0 or jobscoutids.ramcountscoutjob|length > 0 or jobscoutids.outdiskcountscoutjob|length > 0 or jobscoutids.iointensityscoutjob|length > 0  %}
<table>
<a name="scouts"></a>
<tr>
<td bgcolor='lightcyan'><b> Scout jobs: </b></td>
    {% if jobscoutids.walltimescoutjob and jobscoutids.walltimescoutjob|length > 0 %}
        <td>Walltime:
            {% for job in jobscoutids.walltimescoutjob %}
                <a href="{% url 'jobInfo' %}?pandaid={{ job }}">{{ job }}</a> {% if forloop.last %} {% else %} , {% endif %}
            {% endfor %}
        </td>{% endif %}
    {% if jobscoutids.cputimescoutjob and jobscoutids.cputimescoutjob|length %}
        <td>CPU time:
            {% for job in jobscoutids.cputimescoutjob %}
                <a href="{% url 'jobInfo' %}?pandaid={{ job }}">{{ job }}</a> {% if forloop.last %} {% else %} , {% endif %}
            {% endfor %}
        </td>{% endif %}
    {% if jobscoutids.ramcountscoutjob and jobscoutids.ramcountscoutjob|length %}
        <td>RAM count:
            {% for job in jobscoutids.ramcountscoutjob %}
                <a href="{% url 'jobInfo' %}?pandaid={{ job }}">{{ job }}</a> {% if forloop.last %} {% else %} , {% endif %}
            {% endfor %}
        </td>{% endif %}
    {% if jobscoutids.outdiskcountscoutjob and jobscoutids.outdiskcountscoutjob|length %}
        <td>Out disk count:
            {% for job in jobscoutids.outdiskcountscoutjob %}
                <a href="{% url 'jobInfo' %}?pandaid={{ job }}">{{ job }}</a> {% if forloop.last %} {% else %} , {% endif %}
            {% endfor %}
        </td>{% endif %}
    {% if jobscoutids.iointensityscoutjob and jobscoutids.iointensityscoutjob|length %}
        <td>IO intensity:
            {% for job in jobscoutids.iointensityscoutjob %}
                <a href="{% url 'jobInfo' %}?pandaid={{ job }}">{{ job }}</a> {% if forloop.last %} {% else %} , {% endif %}
            {% endfor %}
        </td>{% endif %}
</tr>
</table>
{% endif %}

<a name="taskparamsprodsys"></a>
{% if taskparaml %}
<table>
<tr bgcolor='lightcyan'><th colspan=20> Prodsys task parameters </th></tr>
{% for p in taskparaml %}
{% if p.name != 'jobParameters' and p.name != 'log' %}
<tr><th> {{ p.name }} </th><td>{% if p.value != None %} {{ p.value }} {% endif %}</td></tr>
{% endif %}
{% endfor %}
</table>
<p>
{% endif %}

<table>
<a name="taskparamsjedi"></a>
<tr bgcolor='lightcyan'><th colspan=20> PanDA/JEDI task parameters </th></tr>
{% for col in columns %}
<tr><th>{{ col.name }} </th><td> {% if col.value != 'None' %} {% if col.name == 'cputimescoutjob' %} <a href="{% url 'jobInfo' %}?pandaid={{ col.value }}">{{ col.value }}</a> {% else %} {{ col.value }} {% endif %} {% endif %}</td></tr>
{% endfor %}
</table>

    {% if currentlyRunningDataSets and currentlyRunningDataSets|length > 0 %}
        <table>
        <tr bgcolor='lightcyan'><th colspan=20>Currently running jobsets</th></tr>
        <tr>
        <td>
        {% for currentlyRunningDataSet in currentlyRunningDataSets %}
            <a href="{% url 'jobList' %}?jeditaskid={{ jeditaskid }}&jobsetid={{ currentlyRunningDataSet }}">{{ currentlyRunningDataSet }}</a>,
        {% endfor %}
        </td>
        </tr>
        </table>
    {% endif %}





    <table class="table table-striped table-bordered" id="eventchunktable" style="clear: both;">
    <thead>
        <tr>
            <th>Last jobset</th>
            <th>Previous<br> JobSets attempts</th>
            <th>DS Status</th>
            <th>Count attempts<br> from DS</th>
            <th>Count attempts from<br> retries reconstruction</th>
            <th>The logical filename (lfn)</th>
            <th>The starting event number used in the file (Start Event)</th>
            <th>The ending event number used in the file (End Event)</th>
            <th>How many times the file failed so far (Failedattempt)</th>,
            <th>How many times the file can be failed at most(Maxfailure)</th>,
            <th>How many times the file can be failed at most(Maxattempt)</th>

        </tr>
    </thead>
    </table>



{% else %}

<p>
PanDA task {% if jeditaskid > 0 %}{{ jeditaskid }}:{% endif %} <b>{{ taskname }}</b> not found.
</p>

{% if viewParams.MON_VO == 'ATLAS' %}

 <p> Note that task info pages are currently only available for JEDI tasks in the new monitor.
 </p><p>
 You can however get a job listing for any task in quick search.
</p>
{% endif%}

{% endif %}

{% endblock %}

{% block helptext %}
<a name="help"></a>
{% include "taskInfoHelp.html" with helptitle="Task detail page help" %}
{% endblock %}
