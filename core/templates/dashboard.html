{% extends "_base_core.html" %}

{% block page_title %} {{ viewParams.MON_VO }} PanDA jobs{% endblock %}
{% block title %} <a class="menu-link" href="{% url 'index' %}">{{ viewParams.MON_VO }} PanDA monitor</a>{% endblock %}
{% block subtitle %}PanDA {{view}} {{ requestParams.mode }} dashboard{{ viewParams.selection|safe }}
{% endblock %}
{% block body %}

{{ viewParams.header }}

{% if cloudview == 'region' %}
<div class="callout alert large" data-closable>
    <h5>Please participate in testing
        <a class="blacklink" href="{% url 'dashRegion' %}{% if view == 'analysis' %}?jobtype=analy&splitby=jobtype{% elif view == 'production' %}?jobtype=prod&splitby=jobtype{% endif %}"><b>a new nicer and faster dashboard page</b></a>,
        where a number of interactive filters are available and e.g. job counts for GU queues can be split by both job and resource types:
        <a class="blacklink" href="{% url 'dashRegion' %}{% if view == 'analysis' %}?jobtype=analy&splitby=jobtype{% elif view == 'production' %}?jobtype=prod&splitby=jobtype{% endif %}"><b>https://bigpanda.cern.ch/new/dash/{% if view == 'analysis' %}?jobtype=analy&splitby=jobtype{% elif view == 'production' %}?jobtype=prod&splitby=jobtype{% endif %}</b></a></h5>
  <button class="close-button small" aria-label="Dismiss alert" type="button" data-close>
        <span aria-hidden="true">&times;</span>
  </button>
</div>
{% endif %}

{% if requestParams.sortby %} <p><b>Sorted by: {{ requestParams.sortby }} </b><p> {% endif %}

{% if viewParams.MON_VO != 'ATLAS' %}

<table width=800><tr><td>
This page summarizes recent job status for VOs, clouds and sites. Click on the numbers to see job listings.
Failure rates above {{ errthreshold }}% are shown in red.
Click the cloud name in the overall summary to go to the cloud's site summary.
Click the job counts to go to job listings.
Click on column titles to sort.
</td></tr></table>
<p>

<div class='section'>VO / Cloud / Site summary</div>
{% else %}


{% if noldtransjobs > 0 %}
<p>
<table>
<tr class='tablesection'>
<th> Jobs in transferring state more than {{ hoursSinceUpdate }} hours </th>
<th> Total </th>
{% for cloud in transclouds %}
<th> {{ cloud.name }} </th>
{% endfor %}
</tr>
<tr>
<td> By home cloud </td>
<td> <a href="{% url 'jobList' %}?transferringnotupdated={{ hoursSinceUpdate }}&display_limit=100">{{ noldtransjobs }}</a> </td>
{% for cloud in transclouds %}
<td> {{ cloud.count }} </td>
{% endfor %}
</tr>
<tr>
<td> By assigned (multi-cloud production) cloud </td>
<td> <a href="{% url 'jobList' %}?transferringnotupdated={{ hoursSinceUpdate }}&display_limit=100">{{ noldtransjobs }}</a> </td>
{% for cloud in transrclouds %}
<td> <a href="{% url 'jobList' %}?transferringnotupdated={{ hoursSinceUpdate }}&cloud={{ cloud.name }}&display_limit=100">{{ cloud.count }}</a> </td>
{% endfor %}
</tr>
</table>
</p>
{% endif %}

{% if mode == 'task' %}

{% if cloudTaskSummary %}

<table>
<tr class='tablesection'><th colspan=30> {{ view }} task summary by cloud, last {{ taskdays }} days</span>         <font size=-1>Hover over state name to see full name. <a href="https://twiki.cern.ch/twiki/bin/view/PanDA/PandaJEDI#Transition_of_task_status">Task state documentation</a></font> </th></tr>
<tr class='tablesection'>
<th>Cloud</th>

{% if rw %}
<th><a href="https://twiki.cern.ch/twiki/bin/view/PanDA/PandaJEDI#Task_brokerage" target="new">RW</a></th>
{% endif %}

{% if jobsLeft %}
<th>nJobs left</th>
{% endif %}
<th><font size=-1>nTask</font></th>
{% for state in taskstates %}
<th><div title="{{state.state}}"><font size=-1><span class="{{ state.state }}"> {{ state.short }} </span></font></div></th>
{% endfor %}
</tr>


{% for fdict in cloudTaskSummary %}
<tr><td> <b>{{ fdict.field }}</b> </td>
{% if rw %}
<td>{{ rw|get_item:fdict.field }}</td>
{% endif %}
{% if jobsLeft %}
<td bgcolor=whitesmoke align='right'> <a href="{% url 'jobList' %}?cloud={{ fdict.field }}{% if requestParams.workinggroup %}&workinggroup={{requestParams.workinggroup}}{% endif %}{% if requestParams.processingtype %}&processingtype={{requestParams.processingtype}}{% endif %}{% if requestParams.tasktype %}&tasktype={{requestParams.tasktype}}{% endif %}{% if requestParams.project %}&project={{requestParams.project}}{% endif %}&hours={{hours}}&jobstatus=waiting|assigned|activated|starting|running|transferring|holding|defined|sent|throttled|merging&jobtype={{ view }}&display_limit=100">{{ jobsLeft|get_item:fdict.field }}</a> </td>
{% endif %}
<td> <a href="{% url 'taskList' %}?cloud={{fdict.field}}{% if requestParams.workinggroup %}&workinggroup={{requestParams.workinggroup}}{% endif %}{% if requestParams.processingtype %}&processingtype={{requestParams.processingtype}}{% endif %}{% if requestParams.tasktype %}&tasktype={{requestParams.tasktype}}{% endif %}&jobtype={{view}}{% if requestParams.project %}&project={{requestParams.project}}{% endif %}&days={{taskdays}}">{{ fdict.count }}</a></td>
{% for item in fdict.list %}
<td {% if item.kvalue > 0 %} class='{{item.kname}}_fill' {% endif %}> <a href="{% url 'taskList' %}?cloud={{fdict.field}}{% if requestParams.workinggroup %}&workinggroup={{requestParams.workinggroup}}{% endif %}{% if requestParams.processingtype %}&processingtype={{requestParams.processingtype}}{% endif %}{% if requestParams.project %}{% if requestParams.tasktype %}&tasktype={{requestParams.tasktype}}{% endif %}&project={{requestParams.project}}{% endif %}&status={{item.kname}}&jobtype={{view}}&days={{taskdays}}"><span {% if item.kvalue == 0 %}class='{{item.kname}}'{% else %}class='{{item.kname}}_fill'{% endif %}>{{ item.kvalue }}</span></a></td>
{% endfor %}
</tr>
{% endfor %}

</table>

<p>
{% endif %}
{% endif %}
{% endif %}


{% if summary or vosummary%}

<script type="text/javascript">

    var shift = 0;
    var startshift = -1;

    {% if cloudview == 'region' %}
        startshift = 0;
    {% endif %}



    $(document).ready(function() {

        $('#defined').change(function() {
            if ($('#cloudsitesummary tr td:nth-child('+(5+startshift).toString()+'),#cloudsitesummary th:nth-child('+(5+startshift).toString()+')').is(':visible'))
                $('#cloudsitesummary tr td:nth-child('+(5+startshift).toString()+'),#cloudsitesummary th:nth-child('+(5+startshift).toString()+')').hide();
            else
                $('#cloudsitesummary tr td:nth-child('+(5+startshift).toString()+'),#cloudsitesummary th:nth-child('+(5+startshift).toString()+')').show();
        });
        $('#waiting').change(function() {
            if ($('#cloudsitesummary tr td:nth-child('+(6+startshift).toString()+'),#cloudsitesummary th:nth-child('+(6+startshift).toString()+')').is(':visible'))
                $('#cloudsitesummary tr td:nth-child('+(6+startshift).toString()+'),#cloudsitesummary th:nth-child('+(6+startshift).toString()+')').hide();
            else
                $('#cloudsitesummary tr td:nth-child('+(6+startshift).toString()+'),#cloudsitesummary th:nth-child('+(6+startshift).toString()+')').show();
        });
        $('#assigned').change(function() {
            if ($('#cloudsitesummary tr td:nth-child('+(7+startshift).toString()+'),#cloudsitesummary th:nth-child('+(7+startshift).toString()+')').is(':visible'))
                $('#cloudsitesummary tr td:nth-child('+(7+startshift).toString()+'),#cloudsitesummary th:nth-child('+(7+startshift).toString()+')').hide();
            else
                $('#cloudsitesummary tr td:nth-child('+(7+startshift).toString()+'),#cloudsitesummary th:nth-child('+(7+startshift).toString()+')').show();
        });
        $('#throttled').change(function() {
            if ($('#cloudsitesummary tr td:nth-child('+(8+startshift).toString()+'),#cloudsitesummary th:nth-child('+(8+startshift).toString()+')').is(':visible'))
                $('#cloudsitesummary tr td:nth-child('+(8+startshift).toString()+'),#cloudsitesummary th:nth-child('+(8+startshift).toString()+')').hide();
            else
                $('#cloudsitesummary tr td:nth-child('+(8+startshift).toString()+'),#cloudsitesummary th:nth-child('+(8+startshift).toString()+')').show();
        });
        $('#activated').change(function() {
            if ($('#cloudsitesummary tr td:nth-child('+(9+startshift).toString()+'),#cloudsitesummary th:nth-child('+(9+startshift).toString()+')').is(':visible'))
                $('#cloudsitesummary tr td:nth-child('+(9+startshift).toString()+'),#cloudsitesummary th:nth-child('+(9+startshift).toString()+')').hide();
            else
                $('#cloudsitesummary tr td:nth-child('+(9+startshift).toString()+'),#cloudsitesummary th:nth-child('+(9+startshift).toString()+')').show();
        });
        $('#sent').change(function() {
            if ($('#cloudsitesummary tr td:nth-child('+(10+startshift).toString()+'),#cloudsitesummary th:nth-child('+(10+startshift).toString()+')').is(':visible'))
                $('#cloudsitesummary tr td:nth-child('+(10+startshift).toString()+'),#cloudsitesummary th:nth-child('+(10+startshift).toString()+')').hide();
            else
                $('#cloudsitesummary tr td:nth-child('+(10+startshift).toString()+'),#cloudsitesummary th:nth-child('+(10+startshift).toString()+')').show();
        });
        $('#starting').change(function() {
            if ($('#cloudsitesummary tr td:nth-child('+(11+startshift).toString()+'),#cloudsitesummary th:nth-child('+(11+startshift).toString()+')').is(':visible'))
                $('#cloudsitesummary tr td:nth-child('+(11+startshift).toString()+'),#cloudsitesummary th:nth-child('+(11+startshift).toString()+')').hide();
            else
                $('#cloudsitesummary tr td:nth-child('+(11+startshift).toString()+'),#cloudsitesummary th:nth-child('+(11+startshift).toString()+')').show();
        });
        $('#running').change(function() {
            if ($('#cloudsitesummary tr td:nth-child('+(12+startshift).toString()+'),#cloudsitesummary th:nth-child('+(12+startshift).toString()+')').is(':visible'))
                $('#cloudsitesummary tr td:nth-child('+(12+startshift).toString()+'),#cloudsitesummary th:nth-child('+(12+startshift).toString()+')').hide();
            else
                $('#cloudsitesummary tr td:nth-child('+(12+startshift).toString()+'),#cloudsitesummary th:nth-child('+(12+startshift).toString()+')').show();
        });
        $('#holding').change(function() {
            if ($('#cloudsitesummary tr td:nth-child('+(13+startshift).toString()+'),#cloudsitesummary th:nth-child('+(13+startshift).toString()+')').is(':visible'))
                $('#cloudsitesummary tr td:nth-child('+(13+startshift).toString()+'),#cloudsitesummary th:nth-child('+(13+startshift).toString()+')').hide();
            else
                $('#cloudsitesummary tr td:nth-child('+(13+startshift).toString()+'),#cloudsitesummary th:nth-child('+(13+startshift).toString()+')').show();
        });


{% if viewParams.MON_VO == 'ATLAS' %}
       $('#merging').change(function() {
            if ($('#cloudsitesummary tr td:nth-child('+(14+startshift).toString()+'),#cloudsitesummary th:nth-child('+(14+startshift).toString()+')').is(':visible'))
                $('#cloudsitesummary tr td:nth-child('+(14+startshift).toString()+'),#cloudsitesummary th:nth-child('+(14+startshift).toString()+')').hide();
            else
                $('#cloudsitesummary tr td:nth-child('+(14+startshift).toString()+'),#cloudsitesummary th:nth-child('+(14+startshift).toString()+')').show();
        });
        shift = 1;
{% endif %}

        $('#transferring').change(function() {
            if ($('#cloudsitesummary tr td:nth-child('+(14+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(14+startshift+shift).toString()+')').is(':visible'))
                $('#cloudsitesummary tr td:nth-child('+(14+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(14+startshift+shift).toString()+')').hide();
            else
                $('#cloudsitesummary tr td:nth-child('+(14+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(14+startshift+shift).toString()+')').show();
        });

        $('#finished').change(function() {
            if ($('#cloudsitesummary tr td:nth-child('+(15+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(15+startshift+shift).toString()+')').is(':visible'))
                $('#cloudsitesummary tr td:nth-child('+(15+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(15+startshift+shift).toString()+')').hide();
            else
                $('#cloudsitesummary tr td:nth-child('+(15+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(15+startshift+shift).toString()+')').show();
        });

        $('#failed').change(function() {
            if ($('#cloudsitesummary tr td:nth-child('+(16+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(16+startshift+shift).toString()+')').is(':visible'))
                $('#cloudsitesummary tr td:nth-child('+(16+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(16+startshift+shift).toString()+')').hide();
            else
                $('#cloudsitesummary tr td:nth-child('+(16+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(16+startshift+shift).toString()+')').show();
        });

        $('#cancelled').change(function() {
            if ($('#cloudsitesummary tr td:nth-child('+(17+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(17+startshift+shift).toString()+')').is(':visible'))
                $('#cloudsitesummary tr td:nth-child('+(17+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(17+startshift+shift).toString()+')').hide();
            else
                $('#cloudsitesummary tr td:nth-child('+(17+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(17+startshift+shift).toString()+')').show();
        });

        $('#closed').change(function() {
            if ($('#cloudsitesummary tr td:nth-child('+(18+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(18+startshift+shift).toString()+')').is(':visible'))
                $('#cloudsitesummary tr td:nth-child('+(18+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(18+startshift+shift).toString()+')').hide();
            else
                $('#cloudsitesummary tr td:nth-child('+(18+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(18+startshift+shift).toString()+')').show();
        });
        $('#pctfail').change(function() {
            if ($('#cloudsitesummary tr td:nth-child('+(19+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(19+startshift+shift).toString()+')').is(':visible'))
                $('#cloudsitesummary tr td:nth-child('+(19+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(19+startshift+shift).toString()+')').hide();
            else
                $('#cloudsitesummary tr td:nth-child('+(19+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(19+startshift+shift).toString()+')').show();
        });

        if (!$("#defined").is(':checked'))
            $('#cloudsitesummary tr td:nth-child('+(5+startshift).toString()+'),#cloudsitesummary th:nth-child('+(5+startshift).toString()+')').hide();

        if (!$("#waiting").is(':checked'))
            $('#cloudsitesummary tr td:nth-child('+(6+startshift).toString()+'),#cloudsitesummary th:nth-child('+(6+startshift).toString()+')').hide();

        if (!$("#assigned").is(':checked'))
            $('#cloudsitesummary tr td:nth-child('+(7+startshift).toString()+'),#cloudsitesummary th:nth-child('+(7+startshift).toString()+')').hide();

        if (!$("#throttled").is(':checked'))
            $('#cloudsitesummary tr td:nth-child('+(8+startshift).toString()+'),#cloudsitesummary th:nth-child('+(8+startshift).toString()+')').hide();

        if (!$("#activated").is(':checked'))
            $('#cloudsitesummary tr td:nth-child('+(9+startshift).toString()+'),#cloudsitesummary th:nth-child('+(9+startshift).toString()+')').hide();

        if (!$("#sent").is(':checked'))
            $('#cloudsitesummary tr td:nth-child('+(10+startshift).toString()+'),#cloudsitesummary th:nth-child('+(10+startshift).toString()+')').hide();

        if (!$("#starting").is(':checked'))
            $('#cloudsitesummary tr td:nth-child('+(11+startshift).toString()+'),#cloudsitesummary th:nth-child('+(11+startshift).toString()+')').hide();

        if (!$("#running").is(':checked'))
            $('#cloudsitesummary tr td:nth-child('+(12+startshift).toString()+'),#cloudsitesummary th:nth-child('+(12+startshift).toString()+')').hide();

        if (!$("#holding").is(':checked'))
            $('#cloudsitesummary tr td:nth-child('+(13+startshift).toString()+'),#cloudsitesummary th:nth-child('+(13+startshift).toString()+')').hide();

        if (!$("#merging").is(':checked'))
            $('#cloudsitesummary tr td:nth-child('+(14+startshift).toString()+'),#cloudsitesummary th:nth-child('+(14+startshift).toString()+')').hide();

        if (!$("#transferring").is(':checked'))
            $('#cloudsitesummary tr td:nth-child('+(14+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(14+startshift+shift).toString()+')').hide();

        if (!$("#finished").is(':checked'))
            $('#cloudsitesummary tr td:nth-child('+(15+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(15+startshift+shift).toString()+')').hide();

        if (!$("#failed").is(':checked'))
            $('#cloudsitesummary tr td:nth-child('+(16+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(16+startshift+shift).toString()+')').hide();

        if (!$("#cancelled").is(':checked'))
            $('#cloudsitesummary tr td:nth-child('+(17+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(17+startshift+shift).toString()+')').hide();

        if (!$("#closed").is(':checked'))
            $('#cloudsitesummary tr td:nth-child('+(18+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(18+startshift+shift).toString()+')').hide();

        if (!$("#pctfail").is(':checked'))
            $('#cloudsitesummary tr td:nth-child('+(19+startshift+shift).toString()+'),#cloudsitesummary th:nth-child('+(19+startshift+shift).toString()+')').hide();

        toggle('hiderow');

    });


    function toggle(thisname) {
       tr=document.getElementsByTagName('tr')
          for (i=0;i<tr.length;i++){
              if (tr[i].className == thisname){
                 if ( tr[i].style.display=='none' ){
                    tr[i].style.display = '';
                 }
              else {
                 tr[i].style.display = 'none';
                 }
              }
           }
        }


</script>
<a class="bluebutton" onclick="javascript:toggle('hiderow');" href="#">Select states to show</a>
<table id="columnstoshow">
<tr class='hiderow'><td>defined <input id="defined" type="checkbox" checked/></td>
<td>waiting <input id="waiting" type="checkbox" checked/></td>
<td>assigned <input id="assigned" type="checkbox" checked/></td>
<td>throttled <input id="throttled" type="checkbox" checked/></td>
<td>activated <input id="activated" type="checkbox" checked/></td>
<td>sent <input id="sent" type="checkbox" checked/></td>
<td>starting <input id="starting" type="checkbox" checked/></td>
<td>running <input id="running" type="checkbox" checked/></td>
<tr class='hiderow'>
<td>holding <input id="holding" type="checkbox" checked/></td>
{% if viewParams.MON_VO == 'ATLAS' %}
    <td>merging <input id="merging" type="checkbox" checked/></td>
{% endif %}
<td>transferring <input id="transferring" type="checkbox" checked/></td>
<td>finished <input id="finished" type="checkbox" checked/></td>
<td>failed <input id="failed" type="checkbox" checked/></td>
<td>cancelled <input id="cancelled" type="checkbox" checked/></td>
<td>closed <input id="closed" type="checkbox" checked/></td>
<td>pctfail <input id="pctfail" type="checkbox" checked/></td></tr>

</table>

{% endif %}

{% if summary or vosummary %}
<script type="text/javascript">
    $(document).ready(function() {
        if (!$(".hideofflinerow").is(':visible'))
                $(".hideofflinerow").show();
    });
    function hideoffline(){
        if ($(".hideofflinerow").is(':visible')){
            $(".hideofflinerow").hide();
            document.getElementById('hidebutton').innerHTML='Show offline and brokeroff queues'}
        else {
            $(".hideofflinerow").show();
            document.getElementById('hidebutton').innerHTML='Hide offline and brokeroff queues'}
    }
</script>

<a id="hidebutton" class="bluebutton" onclick="javascript:hideoffline();" href="#">Hide offline and brokeroff queues</a>
<br style="clear:both;">
<p>
{% endif %}


<table id="cloudsitesummary">

{% if viewParams.MON_VO != 'ATLAS' %}

<tr class='tablesection'><th colspan=20> VO summary </th></tr>
<tr class='tablesection'>
<th> <a href="{{nosorturl}}">VO</a> </th>
<th>  </th>
<th> nJobs </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=defined">defined</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=waiting">waiting</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=assigned">assigned</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=throttled">throttled</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=activated">activated</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=sent">sent</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=starting">starting</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=running">running</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=holding">holding</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=merging">merging</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=transferring">transferring</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=finished">finished</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=failed">failed</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=cancelled">cancelled</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=closed">closed</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=pctfail">% failed</a></div> </th>
</tr>



{% for vo in vosummary %}
<tr height=10 colspan=12></tr>
<tr>
<th  bgcolor=whitesmoke> {{ vo.name }} </th>
<th bgcolor=whitesmoke> </th>
<th  bgcolor=whitesmoke align='right'> <a href="{% url 'jobList' %}?vo={{ vo.name }}{{ estailtojobslinks }}&hours={{hours}}&jobtype={{ view }}&display_limit=100">{{ vo.count }}</a> </th>
{% for state in vo.statelist %}
<th {% if state.count > 0 %} class='{{ state.name }}_fill' {% else %} bgcolor=whitesmoke {% endif %} align='right'> <a href="{% url 'jobList' %}?vo={{ vo.name }}{{ estailtojobslinks }}&jobstatus={{ state.name }}&hours={{hours}}&jobtype={{ view }}&display_limit=100"> <span class="{{ state.name }}{% if state.count > 0 %}_fill{% endif %}">{{ state.count }}</span></a> </th>
{% endfor %}
<th  bgcolor=whitesmoke align='right'>  {% if vo.pctfail > errthreshold %} <font color=red>{{ vo.pctfail  }}</font> {% else %} {{ vo.pctfail  }} {% endif %}  </th>
</tr>
{% endfor %}
<tr height=10 colspan=12></tr>

{% endif %}

{% if summary %}

<tr class='tablesection'><th colspan=20> Cloud / Site summary 
{% if view == 'analysis' %}
of analysis jobs
{% elif view == 'production' %}
of production jobs
{% else %}
of all jobs
{% endif %}
{% if view != 'analysis' %}
{% if cloudview == 'region' %}
- Region view         For a description of region view
{% else %}
- Cloud view         For a description of cloud view
{% endif %}
{% else %}
        For a description
{% endif %}
<a href="#doc"><span class="helpdark">see below</a>
</th></tr>

<tr class='tablesection'>
<th> <a href="{{nosorturl}}">Cloud</a> </th>
<th> Status</th>
<th> nJobs </th>
{% if cloudview == 'region' %}
<th> nPilots (Sum(nojobabs)) </th>
{% endif %}
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=defined">defined</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=waiting">waiting</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=assigned">assigned</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=throttled">throttled</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=activated">activated</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=sent">sent</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=starting">starting</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=running">running</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=holding">holding</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=merging">merging</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=transferring">transferring</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=finished">finished</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=failed">failed</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=cancelled">cancelled</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=closed">closed</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=pctfail">% failed</a></div> </th>
</tr>

{% for cloud in summary %}
<tr height=10 colspan=12></tr>
<tr>
<th  bgcolor=whitesmoke> {% if cloud.name != 'All' %}{% if cloud.name != '' %}<a href="#cloud_{{ cloud.name }}"><span class="{{cloud.status}}">{{ cloud.name }}</span></a> <a onclick='PopUp("SITE={% if view == 'analysis' %}{{ cloud.name }}_analy{% else %}{{cloud.name }}{% endif %}&SIZE=medium", "{% if view == 'analysis' %}{{ cloud.name }}_analy{% else %}{{ cloud_name }}{% endif %}", "day")'><img src='/static/images/tinychart.png' width=14 height=14 border=0/></a>{% else %} Failed before site assigned {% endif %} {% else %}  All clouds {% endif %}</th>
<th  bgcolor=whitesmoke> <span class="{{cloud.status}}">{{ cloud.status }}</span> </th>
<th  bgcolor=whitesmoke align='right'>{{ cloud.count }}</th>
{% if cloudview == 'region' %}
<th  bgcolor=whitesmoke align='right'> {{ cloud.pilots }} ({{ cloud.nojobabs }}) </th>
{% endif %}
{% for state in cloud.statelist %}
<th  {% if state.count > 0 %} class='{{ state.name }}_fill' {% else %} bgcolor=whitesmoke {% endif %} align='right'><span class="{{ state.name }}{% if state.count > 0 %}_fill{% endif %}"> {{ state.count }}</span></td>
{% endfor %}
<th  bgcolor=whitesmoke align='right'> <a href="{% url 'errorSummary' %}?jobtype={{view}}{{ estailtojobslinks }}{% if requestParams.workinggroup %}&workinggroup={{requestParams.workinggroup}}{% endif %}{% if requestParams.processingtype %}&processingtype={{requestParams.processingtype}}{% endif %}{% if requestParams.tasktype %}&tasktype={{requestParams.tasktype}}{% endif %}&jobtype={{view}}{% if requestParams.project %}&project={{requestParams.project}}{% endif %}&sortby=count&cloud={{cloud.name}}&hours={{hours}}"> {% if cloud.pctfail > errthreshold %} <font color=red>{{ cloud.pctfail  }}</font> {% else %} {{ cloud.pctfail  }} {% endif %} </a></th>
</tr>
{% endfor %}


{% for cloud in summary %}

{% if cloud.name != 'All' %}

<tr height=10 colspan=12></tr>
<tr>
<th class="tablesection"> <a name="cloud_{{ cloud.name }}"><span class="{{cloud.status}}">{{ cloud.name }} Cloud</span></a>, Sites </th>
<th class="tablesection"> Status</th>
<th class="tablesection"> nJobs </th>
{% if cloudview == 'region' %}
<th class="tablesection"> nPilots (sum(nojobabs)) </th>
{% endif %}
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=defined">defined</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=waiting">waiting</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=assigned">assigned</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=throttled">throttled</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=activated">activated</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=sent">sent</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=starting">starting</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=running">running</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=holding">holding</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=merging">merging</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=transferring">transferring</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=finished">finished</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=failed">failed</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=cancelled">cancelled</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=closed">closed</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=pctfail">% failed</a></div> </th>
</tr>


<tr height=10 colspan=12></tr>
<tr>
<th bgcolor=whitesmoke> {{ cloud.name }} all sites {% if cloudview != 'region' and view != 'analysis' %} including MCP {% endif %}</th>
<th bgcolor=whitesmoke> </th>
<th bgcolor=whitesmoke align='right'>{{ cloud.count }}</th>
{% if cloudview == 'region' %}
<th> {{ cloud.pilots }} ({{ cloud.nojobabs }}) </th>
{% endif %}
{% for state in cloud.statelist %}
<th {% if state.count > 0 %} class='{{ state.name }}_fill' {% else %} bgcolor=whitesmoke {% endif %} align='right'><span class="{{ state.name }}{% if state.count > 0 %}_fill{% endif %}">{{ state.count }}</span></th>
{% endfor %}
<th  bgcolor=whitesmoke align='right'> <a href="{% url 'errorSummary' %}?jobtype={{view}}{{ estailtojobslinks }}&sortby=count{% if requestParams.workinggroup %}&workinggroup={{requestParams.workinggroup}}{% endif %}{% if requestParams.processingtype %}&processingtype={{requestParams.processingtype}}{% endif %}{% if requestParams.tasktype %}&tasktype={{requestParams.tasktype}}{% endif %}&jobtype={{view}}{% if requestParams.project %}&project={{requestParams.project}}{% endif %}&cloud={{cloud.name}}&hours={{hours}}"> {% if cloud.pctfail > errthreshold %} <font color=red>{{ cloud.pctfail  }}</font> {% else %} {{ cloud.pctfail  }} {% endif %} </a> </th>
</tr>
{% for site in cloud.summary %}
    {% if site.parent %}
    <tr class="parent">

    {% else %}
    <tr  {% if site.status == 'offline' or site.status == 'brokeroff'%} class="hideofflinerow" {% endif %}>
    {% endif %}
    <td>
        {% if site.name %}
            {% if site.parent %}
                {{ site.parent }} [{{ site.resource }}]
                <div class="inline-div">
                <a onclick='PopUp("SITE={% if view == 'analysis' %}{{ site.parent }}{% else %}{{ site.parent }}{% endif %}&SIZE=medium&RESOURCE={{ site.resource }}", "{% if view == 'analysis' %}{{ site.parent }}{% else %}{{ site.parent }}{% endif %}", "day")'><img src='/static/images/tinychart.png' width=14 height=14 border=0/></a>  <a target="_blank" href="https://monit-grafana.cern.ch/d/5iI1ddfWz/jobs-monitoring-ig?orgId=17&var-retention=1h&var-cloud=All&var-tier=All&var-federation=All&var-nucleus=All&var-site=All&var-queue={{site.parent}}&var-queue_state=online&var-resource={{site.resource}}&var-states=All&var-type=All&var-pilot_manager=All&var-pilot_version=All&var-harvester=All&var-workflow=All&var-frontier=All&var-fts_server=All&var-container_type=All&var-pledge=All"><div class="tooltip-upper"><img src="/static/images/grafana.png" width=14 height=14 border=0><span class="tooltip-text">Link to Jobs monitoring dashboard in Grafana</span></div></a> {% else %}<a href="{% url 'siteInfo' site.name %}"><span class="{{ site.status }}">{{ site.name }}</span></a> <a onclick='PopUp("SITE={% if view == 'analysis' %}{{ site.name }}{% else %}{{ site.name }}{% endif %}&SIZE=medium", "{% if view == 'analysis' %}{{ site.name }}{% else %}{{ site.name }}{% endif %}", "day")'><img src='/static/images/tinychart.png' width=14 height=14 border=0/></a>
                {% if 'isHarvester' in site and site.isHarvester %}
                    <a target="_blank" href="https://es-atlas.cern.ch/kibana/app/kibana#/dashboard/a312a030-8b0e-11e8-a7e3-ffbb2f24f6b4?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:now-24h,mode:quick,to:now))&_a=(description:'',filters:!(('$state':(store:appState),meta:(alias:!n,disabled:!f,index:'09f5a610-6810-11e9-a744-833d910adbcf',key:computingsite.keyword,negate:!f,params:(query:{{site.name}},type:phrase),type:phrase,value:{{site.name}}),query:(match:(computingsite.keyword:(query:{{site.name}},type:phrase))))))" ><div class="tooltip-upper"><img src="/static/images/kibana-logo.png" width=14 height=14 border=0><span class="tooltip-text">Link to "Harvester particular computingsite" Kibana dashboard</span> </div></a>
                {% endif %}
                    <a target="_blank" href="https://monit-grafana.cern.ch/d/000000696/job-accounting-historical-data?orgId=17&from=now-24h&to=now&var-bin=1h&var-groupby=gshare&var-country=All&var-federation=All&var-resources=GRID&var-resources=cloud&var-resources=hpc&var-tier=All&var-cloud=All&var-site=All&var-computingsite={{ site.name }}&var-nucleus=All&var-cores=All&var-eventservice=All&var-groups=All&var-inputdatatypes=All&var-inputprojects=All&var-outputproject=All&var-gshare=All&var-resourceserporting=All&var-processingtype=All&var-jobtype=All&var-jobstatus=All&var-error_category=All&var-measurement_suffix=1h&var-measurement_suffix_CQ=1h&var-retention_policy=long&var-division_factor=1&var-hourly_multiplier=1"><div class="tooltip-upper"><img src="/static/images/grafana.png" width=14 height=14 border=0><span class="tooltip-text">Link to Jobs accountig dashboard in Grafana</span></div></a>
                    <a onclick='PopUpGrafana("SITE={% if view == 'analysis' %}{{ site.name }}{% else %}{{ site.name }}{% endif %}&SIZE=medium", "{% if view == 'analysis' %}{{ site.name }}{% else %}{{ site.name }}{% endif %}", "day")'><div class="tooltip-upper"><img src="/static/images/grafana-black.png" width=14 height=14 border=0><span class="tooltip-text">Slots of running jobs (Pop-up window)</span></div></a>
                </div>
                {% endif %}
        {% else %} Failed before site assignment
        {% endif %}
    {% if site.sumres and 1 == 0 %}
        <br/><hr style="height:1px; background-color: #0a0a0a; margin: auto" size=1>
    {% for res in site.sumres%}
        {{ res }}
        <br/>
    {% endfor %}
    {% endif %}

    </td>

    {% get_renderedrow type="region_sitesummary" errorSummary='/errors/' errthreshold=errthreshold cloudname=cloud.name requestParams=requestParams site=site joblisturl='/jobs/' view=view cloudview=cloudview estailtojobslinks=estailtojobslinks hours=hours %}
{% endfor %}

{% endif %}

{% endfor %}
</table>

{% endif %}

{% if taskJobSummary %}
<p>
<table>
<tr class='tablesection'>
<th> Job summary for {{ taskJobSummary|length }} recently active {{ view }} tasks. 
{% if display_limit >= taskJobSummary|length %}     display_limit={{ display_limit }} {% endif %}
</th>
<th> Status </th>
<th> nJobs </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=defined">defined</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=waiting">waiting</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=assigned">assigned</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=throttled">throttled</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=activated">activated</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=sent">sent</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=starting">starting</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=running">running</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=holding">holding</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=merging">merging</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=transferring">transferring</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=finished">finished</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=failed">failed</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=cancelled">cancelled</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=closed">closed</a></div> </th>
<th class="tablesection vertical-dash-header"> <div class="vertical-dash-header"><a href="{{nosorturl}}sortby=pctfail">% failed</a></div> </th>
</tr>
{% for task in taskJobSummary %}
<tr>
<td> <a href="{% url 'taskInfo' task.taskid %}"><span class="{{task.status}}">{{ task.name }}</span></a></td>
<td> <span class="{{task.status}}{% if task.count > 0 %}_fill{% endif %}">{{ task.status }}</span> </td>
<td><a href="{% url 'jobList' %}?taskid={{ task.taskid }}{{ estailtojobslinks }}&hours={{hours}}&jobtype={{ view }}&display_limit=100"> {{ task.count }} </a></td>
{% for state in task.statelist %}
<td {% if state.count > 0 %} class='{{ state.name }}_fill' {% endif %}><a href="{% url 'jobList' %}?taskid={{ task.taskid }}{{ estailtojobslinks }}&jobstatus={{ state.name }}&hours={{hours}}&jobtype={{ view }}&display_limit=100"> <span class="{{ state.name }}{% if state.count > 0 %}_fill{% endif %}"> {{ state.count }}</span></a> </td>
{% endfor %}
<td> <a href="{% url 'errorSummary' %}?taskid={{ task.taskid }}&sortby=count&hours={{hours}}"> {% if task.pctfail > errthreshold %} <font color=red>{{ task.pctfail  }}</font> {% else %} {{ task.pctfail  }} {% endif %} </a></td>
</tr>
{% endfor %}
</table>
</p>
{% endif %}

<script language="javascript">
    var newWin;
    var newWinGrafana;
    function PopUp(ref, site, type) {
        var prt = 'http://'
        if ("https:" == document.location.protocol) {
            prt = 'https://'
        } else {
            prt = 'http://'
        }
        var strFeatures="toolbar=no,status=no,menubar=no,location=no"
        strFeatures=strFeatures+",scrollbars=no,resizable=no,height=500,width=500"
        if (!newWin || newWin.closed) {newWin = window.open(ref,'TellObj',strFeatures);
        if (!newWin.opener) {newWin.opener = window; }

        newWin.document.write('<img src="http://panglia.lcg.triumf.ca/site/graph.php?TIME=day&'+ref+'" id="show_image"><p>');
        newWin.document.write('<input type=button onclick=document.getElementById("show_image").src="http://panglia.lcg.triumf.ca/site/graph.php?TIME=hour&'+ref+'"; value=Hour>');;
        newWin.document.write('<input type=button onclick=document.getElementById("show_image").src="http://panglia.lcg.triumf.ca/site/graph.php?TIME=day&'+ref+'"; value=Day>');
        newWin.document.write('<input type=button onclick=document.getElementById("show_image").src="http://panglia.lcg.triumf.ca/site/graph.php?TIME=week&'+ref+'"; value=Week>');
        newWin.document.write('<input type=button onclick=document.getElementById("show_image").src="http://panglia.lcg.triumf.ca/site/graph.php?TIME=month&'+ref+'"; value=Month>');
        newWin.document.write('<input type=button onclick=document.getElementById("show_image").src="http://panglia.lcg.triumf.ca/site/graph.php?TIME=year&'+ref+'"; value=Year>');
        newWin.document.write('<p><input type=button value="Close" onclick="window.close();return false;">');
        newWin.document.close();
        } else {
            if (window.focus) {newWin.focus()};
        }
    }
    function PopUpGrafana(ref, site) {
        var prt = 'http://'
        if ("https:" == document.location.protocol) {
            prt = 'https://'
        } else {
            prt = 'http://'
        }
        var strFeatures="toolbar=no,status=no,menubar=no,location=no"
        strFeatures=strFeatures+",scrollbars=no,resizable=no,height=800,width=1100"
        if (!newWinGrafana || newWinGrafana.closed) {
            newWinGrafana = window.open(ref,'TellObj', strFeatures);
            if (!newWinGrafana.opener) {newWinGrafana.opener = window; }

        newWinGrafana.document.write('<img src="{% url 'grafana' %}?url=https://monit-grafana.cern.ch/render/d-solo/000000696/job-accounting-historical-data?orgId=17&from=now-24h&to=now&var-bin=1h&var-groupby=gshare&var-country=All&var-federation=All&var-resources=GRID&var-resources=cloud&var-resources=hpc&var-tier=All&var-cloud=All&var-site=All&var-computingsite='+site+'&var-nucleus=All&var-cores=All&var-eventservice=All&var-groups=All&var-inputdatatypes=All&var-inputprojects=All&var-outputproject=All&var-gshare=All&var-resourceserporting=All&var-processingtype=All&var-jobtype=All&var-jobstatus=All&var-error_category=All&var-measurement_suffix=1h&var-measurement_suffix_CQ=1h&var-retention_policy=long&var-division_factor=1&var-hourly_multiplier=1&panelId=138&width=1000&height=500&tz=Europe%2FBerlin" id="show_image"><p>');
        newWinGrafana.document.close();
        } else {
            if (window.focus) {newWinGrafana.focus()};
        }
    }
</script>

{% endblock %}

{% block helptext %}
{% include "dashboardHelp.html" with helptitle="Dashboard help" %}
{% include "jobInfoHelp.html" with helptitle="Job information" show="all" %}
{% endblock %}
