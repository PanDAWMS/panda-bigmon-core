{% extends "_base_core.html" %}
{% load static %}
{% block page_title %} {{ viewParams.MON_VO }} PanDA job errors{% endblock %}

{% block settings-offcanvas %}
    <p>
        <span style="font-weight: bold">Errors page settings</span>
    </p>

  {% for table, desc in userPreferences.defaulttables.items %}
          <div class="switch-toggle-wrapper">
            <div class="switch tiny">
              <input class="switch-input" id="switch-table-{{ table }}" type="checkbox" name="switch-table"
                      {% if table in userPreferences.tables %} checked="checked" {% endif %}
                        onchange="disableDetails('{{ table }}');">
              <label class="switch-paddle" for="switch-table-{{ table }}">
                <span class="show-for-sr">{{ desc }}</span>
              </label>
            </div>
            <span>{{desc }}</span>
          </div>
  {% endfor %}


<div class="row">
  <div class="columns offCanvasRight-columns">
    <ul class="accordion " data-accordion data-allow-all-closed="true">
    <li id="jobattr-menu" class="accordion-item is-active " data-accordion-item><a href="#" class="menu-link" id="jobattr-link" class="accordion-title">Job Attribute Summary Table</a>
     <div class="accordion-content" data-tab-content >
      <ul id="jobattr-menu-item" class="menu vertical nested">

        {% for attr in userPreferences.defaultjobattr %}
          <div class="switch-toggle-wrapper">
            <div class="switch tiny">
              <input class="switch-input" id="switch-jobsattr-{{ attr }}" type="checkbox" name="switch-jobsattr"
                {% if attr in userPreferences.jobattr %} checked="checked" {% endif %}>
              <label class="switch-paddle" for="switch-jobsattr-{{ attr }}">
                <span class="show-for-sr">{{ attr }}</span>
              </label>
            </div>
            <span>{{ attr }}</span>
          </div>
        {% endfor %}
       </ul>
     </div>
    </li>
  </ul>
  </div>
</div>

{% endblock %}


{% block subtitle %}PanDA job error summary{{ viewParams.selection|safe }}
{% if user %}     user={{ user }} {% endif %}
{% if site %}     site={{ site }} {% endif %}
{% if vo %}     VO={{ vo }} {% endif %}
{% endblock %}
{% block subtitle_params %}
{% if jobsErrorsTotalCount != None%} <b> Total jobs found &#x7E; <a href="{% url 'errorSummary' %}?{% if requestString != None %}{{ requestString }}{% endif %}hours={{hours}}&limit={{jobsErrorsTotalCount}}&mode=nodrop">{{ jobsErrorsTotalCount }}</a></b> {% endif %}
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static "js/datatables/DataTables-1.10.13/css/dataTables.foundation.css" %}">
    <link rel="stylesheet" href="{% static "js/datatables/RowGroup-1.1.1/css/rowGroup.foundation.css" %}">
    <style>
        #errorsList_wrapper .row {
            max-width: 99%;
            margin-top: 1rem;
        }
    </style>
{% endblock %}
{% block extra_js %}
    <script src="{% static 'js/humanize.min.js' %}"></script>
    <script src="{% static 'js/datatables/DataTables-1.10.13/js/jquery.dataTables.js' %}"></script>
    <script src="{% static 'js/datatables/DataTables-1.10.13/js/dataTables.foundation.js' %}"></script>
    <script src="{% static 'js/datatables/RowGroup-1.1.1/js/dataTables.rowGroup.js' %}"></script>
    <script src="{% static 'js/datatables/Select-1.2.0/js/dataTables.select.js' %}"></script>
    <script src="{% static 'js/datatables/dataTables.num-html.js' %}"></script>
{% endblock %}

{% block body %}
{{ viewParams.header }}
<script>
    $(document).ready(function() {
        let clipboard = new ClipboardJS('#copy-button'); //needed for copy to clipboard button

        clipboard.on('success', function (e) {
            let copy_button = document.getElementById('copy-button');
            copy_button.innerHTML = 'copied!';
            copy_button.classList.add('disabled');
            e.clearSelection();
        });

        clipboard.on('error', function (e) {
            let copy_button = document.getElementById('copy-button');
            copy_button.innerHTML = 'copying failed!';
            copy_button.classList.add('disabled');
        });
    });
</script>


<b>{{ njobs }} jobs found. Show jobs: </b>
    <a href="{% url 'jobList' %}?{% if requestString != None %}{{ requestString }}{% endif %}jobstatus=failed&hours={{hours}}&limit={{limit}}&mode=nodrop"><b>Failed </b></a>,
    <a href="{% url 'jobList' %}?{% if requestString != None %}{{ requestString }}{% endif %}hours={{hours}}&limit={{limit}}&mode=nodrop"><b> All</b></a>

{% if sortby == "count" %}
<p>Sort by <b>count</b>, <a href="{{nosorturl}}">alpha</a>
{% else %}
<p>Sort by <a href="{{xurlsubst}}sortby=count">count</a>, <b>alpha</b>
{% endif %}

{% if requestParams.jobtype %}<br><b>Job type: {{ requestParams.jobtype }}</b> {% endif %}
{% if requestParams.cloud %}<br><b>Cloud: {{ requestParams.cloud }}</b> {% endif %}
{% if requestParams.computingsite %}<br><b>Site: <a href="{% url 'siteInfo' requestParams.computingsite %}">{{ requestParams.computingsite }}</a></b> {% endif %}
{% if requestParams.produsername %}<br><b>User: <a href="{% url 'userInfo' requestParams.produsername %}?display_limit=100">{{ requestParams.produsername }}</a></b> {% endif %}
{% if requestParams.jeditaskid %}<br><b>JEDI Task: <a href="{% url 'taskInfo' requestParams.jeditaskid  %}">{{ requestParams.jeditaskid }}     {{ taskname }}</a> </b> {% endif %}

{% if requestParams.reqid_from %}<br><b>From request ID: {{ requestParams.reqid_from }}</b> {% endif %}
{% if requestParams.reqid_to %}<br><b>To request ID: {{ requestParams.reqid_to }}</b> {% endif %}

{% if requestParams.taskid %}<br><b>Task ID: {{ requestParams.taskid }}</b> {% endif %}
{% if requestParams.jobsetid %}<br><b>Jobset ID: {{ requestParams.jobsetid }}</b> {% endif %}
{% if requestParams.workinggroup %}<br><b>Working group: {{ requestParams.workinggroup }}</b> {% endif %}

<p>

<p>Job modification times in this listing range from <b>{{ tfirst }}</b> to <b>{{ tlast }}</b>,
<a id="copy-button" class="bluelink" data-clipboard-text="https://{{ request.get_host }}{{ time_locked_url }}">copy time locked link</a>
<p>

<p>Go to {% if errsByCount %} <a href="#summary">overall</a>, {% endif %} {% if errsBySite %} <a href="#sites">site</a>,{% endif %} {% if errsByUser %} <a href="#users">user</a>, {% endif %} {% if errsByTask %} <a href="#tasks">task</a> {% endif %} {% if errMessageSummary %} <a href="#messages">messages</a> {% endif %} summary

<script type="text/javascript"
           src="https://www.google.com/jsapi?autoload={'modules':[{'name':'visualization','version':'1.1','packages':['sankey','corechart']}]}">
</script>
{% if flowstruct %}
{% include "googleFlowDiagram.html" with struct=flowstruct %}
{% endif %}

{% if errHist %}
    <script type="text/javascript">
      google.setOnLoadCallback(drawChart);
      function drawChart() {
        var data = google.visualization.arrayToDataTable([
          ['Time', 'Count'],
          {% for time, count in errHist %}
                   ['{{ time|date:"m-d H:i" }}', {{ count }}],
          {% endfor %}
        ]);
        var options = {
          title: 'Error count timeline',
          legend: { position: 'none' },
          hAxis: {title: 'Time (empty bins suppressed)', titleTextStyle: {color: 'black'},  textStyle: { fontSize:11},},
        };
        var chart = new google.visualization.ColumnChart(document.getElementById('chart_div'));
        chart.draw(data, options);
      }
    </script>
<div id="chart_div" style="height: 500px;"></div>
{% endif %}

<script type="text/javascript" src="{% static "/js/jquery.shorten.1.0.js" %}"></script>
<script type="text/javascript">
	$(document).ready(function() {
	    $(".comment").shorten();
	});
</script>
{% if sumd %}
<table>
<tr class='tablesection'><th colspan=20> Error occurrences by job attribute </th></tr>
{% for fdict in sumd %}
<tr><th> {{ fdict.field }} ({{ fdict.list|length }}) </th>
    <td><div class="comment more">
        {% for item in fdict.list %}
            {% if fdict.field == 'jeditaskid' %} <a href="{% url 'taskInfo' item.kname %}"> {{ item.kname }} </a><a href="{{xurl}}{{fdict.field}}={{item.kname}}" >({{ item.kvalue }})</a>
            {% else %}
                    {% if fdict.field == 'jobstatus' %} <span class='{{item.kname}} item'> {% else %} <span class="item"> {% endif %}  {{ item.kname }} </span>
                    <a href="{{xurlsubst}}{{fdict.field}}={{item.kname}}">({{ item.kvalue }})</a>
               {% endif %}
        {% endfor %}
    </div>
</td></tr>
{% endfor %}
</table>

{% endif %}

{% if errsByCount %}
<a name="summary"></a>
<table id="errsbycount" class="fixed">
<colgroup>
    <col class="w10"/>
    <col class="w5"/>
    <col class="w5"/>
    <col class="w80"/>
</colgroup>
<thead>
<tr class='tablesection'><th colspan=4> Overall error summary </th></tr>
<tr><th>Category:code</th><th>Job list</th><th>Nerrors</th><th>Sample error description</th></tr>
</thead>
<tbody>
{% for errval in errsByCount %}
<tr>
    <td class="wrap-words"> <a href="{{xurlsubst}}{{errval.codename}}={{errval.codeval}}&hours={{hours}}&display_limit=100"> {{ errval.error }} </a> </td>
    <td> <a href="{{jobsurl}}{{errval.codename}}={{errval.codeval}}&hours={{hours}}&display_limit=100"> jobs </a> </td>
    <td> {{ errval.count }} </td>
    <td class="wrap-words"> {{ errval.diag }} <br/> {% if errval.count > 1 and not 'transformation' in errval.error %} <a href="{% url 'summaryErrorsList'%}?codename={{errval.codename}}&codeval={{errval.codeval}}&tk={{ errval.tk }}" target="_blank"> more information here </a> {% endif %} </td>
</tr>
{% endfor %}
</tbody>
</table>
{#<button class="bluebutton" id="errsbycount-showall" onclick="toggleTableByID('errsbycount', 'errsbycount-showall')">Show all</button>#}
{% endif %}

{% if errsBySite %}
<a name="sites"></a>
<table class="fixed">
<colgroup>
    <col class="w15"/>
    <col class="w5"/>
    <col class="w80"/>
</colgroup>
<tr class='tablesection'><th colspan=3> Site error summary </th></tr>
{% for site in errsBySite %}
<tr><th class="wrap-words"> <a href="{{xurlsubstNoSite}}computingsite={{ site.name }}"> {{ site.name }} </a> </th>
<th> {{ site.toterrors }} </th>
<th> Total errors in {{ site.toterrjobs }} jobs.     <a href="{% url 'jobList' %}{{jobsurlNoSite}}computingsite={{ site.name }}&jobstatus=finished&hours={{ hours }}"><span class='finished'> Finished: {{ site.finished }} </span></a>     <a href="{% url 'jobList' %}{{jobsurlNoSite}}computingsite={{ site.name }}&jobstatus=failed&hours={{ hours }}"><span class='failed'> Failed: {{ site.failed }} </span></a>     % failed: {{ site.pctfail }}     <a href="{% url 'jobList' %}{{jobsurlNoSite}}computingsite={{ site.name }}&jobstatus=holding&hours={{ hours }}"><span class='holding'> Holding: {{ site.holding }} </span></a>      <a href="{% url 'jobList' %}{{jobsurlNoSite}}computingsite={{ site.name }}&jobstatus=cancelled&hours={{ hours }}"><span class='cancelled'> Cancelled: {{ site.cancelled }} </span></a> </th>  </tr>
{% for errval in site.errorlist %}
<tr><td>  </td>
    <td> <a href="{{jobsurlNoSite}}?computingsite={{site.name}}&{{errval.codename}}={{errval.codeval}}&hours={{hours}}&display_limit=100&mode=nodrop">{{ errval.count }}</a> </td>
    <td class="wrap-words"> <b>{{ errval.error }}</b>     <font size=-1> {{ errval.diag }} </font></td>
</tr>
{% endfor %}
{% endfor %}
</table>
{% endif %}

{% if errsByUser %}
<a name="users"></a>
<table class="fixed">
<colgroup>
    <col class="w15"/>
    <col class="w5"/>
    <col class="w80"/>
</colgroup>
<tr class='tablesection'><th colspan=3> User error summary </th></tr>
{% for user in errsByUser %}
<tr><th class="wrap-words"> <a href="{{xurl}}produsername={{ user.name }}"> {{ user.name }} </a> </th> <th> {{ user.toterrors }} </th> <th> Total errors </th>  </tr>
{% for errval in user.errorlist %}
<tr><td>  </td> <td> <a href="{{jobsurl}}produsername={{user.name}}&{{errval.codename}}={{errval.codeval}}&hours={{hours}}&display_limit=100&mode=nodrop">{{ errval.count }}</a> </td> <td class="wrap-words"> <b>{{ errval.error }}</b>     {{ errval.diag }} </td>  </tr>
{% endfor %}
{% endfor %}
</table>
{% endif %}

{% if errsByTask %}
<a name="tasks"></a>
<table class="fixed">
<colgroup>
    <col class="w10"/>
    <col class="w90"/>
</colgroup>
<tr class='tablesection'><th colspan=2> Task error summary </th></tr>
{% for task in errsByTask %}
<tr><th colspan=10> <a href="{{xurlsubst}}{{task.tasktype}}={{ task.name }}"> {{ task.tasktype }}     {{ task.name }} </a>         {% if task.longname != '' %} <a href="{{xurlsubst}}{{task.tasktype}}={{ task.name }}">{{ task.longname }}</a>{% endif %} </th></tr>
<tr>
<th> {{ task.toterrors }} </th>
<th> Total errors in {{ task.toterrjobs }} jobs.     <a href="{% url 'jobList' %}?taskid={{ task.name }}&jobstatus=finished&hours={{ hours }}"><span class='finished'> Finished: {{ task.finished }} </span></a>     <a href="{% url 'jobList' %}?taskid={{ task.name }}&jobstatus=failed&hours={{ hours }}"><span class='failed'> Failed: {{ task.failed }} </span></a>     % failed: {{ task.pctfail }}     <a href="{% url 'jobList' %}?taskid={{ task.name }}&jobstatus=holding&hours={{ hours }}"><span class='holding'> Holding: {{ task.holding }} </span></a>      <a href="{% url 'jobList' %}?taskid={{ task.name }}&jobstatus=cancelled&hours={{ hours }}"><span class='cancelled'> Cancelled: {{ task.cancelled }} </span></a> </th>
</tr>
{% for errval in task.errorlist %}
<tr><td> <a href="{{jobsurl}}{{task.tasktype}}={{task.name}}&{{errval.codename}}={{errval.codeval}}&hours={{hours}}&display_limit=100&mode=nodrop">{{ errval.count }}</a> </td> <td class="wrap-words"> <b>{{ errval.error }}</b>      {{ errval.diag }} </td>  </tr>
{% endfor %}
{% endfor %}
</table>

{% endif %}


{% if errMessageSummary %}
<a name="messages"></a>
<table id="errorsList" class="data-table left-aligned">
    <thead>
      <tr>
        <th>Error code</th>
        <th class="num">Number of errors</th>
        <th class="num">Walltime loss, days</th>
        <th>Error message</th>
        <th class="num">Number of error message</th>
        <th>Job samples</th>
      </tr>
    </thead>
    <tfoot>
      <tr>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
        <th></th>
      </tr>
    </tfoot>
    <tbody></tbody>
</table>

<script type="text/javascript">
var err_list_data = {{ errMessageSummary|safe }};
var errorListDataTable;

$(document).ready(function () {
        DisplayErorListDataTable();
    });

function DisplayErorListDataTable() {
    errorListDataTable = $('#errorsList').dataTable({
        "sPaginationType": "full_numbers",
        "lengthMenu": [[20, 50, 100, 200, -1], [20, 50, 100, 200, "All"]],
        "paging": true,
        "aaSorting": [[1, 'desc'], [4, 'desc']],
        "data": err_list_data,
        "columns": [
            {
                "data": "errcode",
                sDefaultContent: "",
                "render": function (data, type, row, meta) {
                    return '<a href="{{ xurlsubst }}' + row['errcodename'] + '=' + row['errcodeval'] + '" target="_blank">' + data + '</a>'
                }
            },
            {
                "data": "errcodecount",
                sDefaultContent: "",
                className: "num",
                render: $.fn.dataTable.render.number( ',', '.'),
            },
            {
                "data": "errcodewalltimeloss",
                sDefaultContent: "",
                className: "num",
                render: $.fn.dataTable.render.number( ',', '.'),
            },
            {
                "data": "errmessage",
                sDefaultContent: "",
            },
            {
                "data": "errmessagecount",
                sDefaultContent: "",
                className: "num",
                render: $.fn.dataTable.render.number( ',', '.'),
            },
            {
                "data": "pandaids",
                sDefaultContent: "",
                "render": function (data) {
                    let rendered_pandaids = '';
                    for (let i = 0; i < data.length; i++) {
                        rendered_pandaids += '<a href="/job/' + data[i] + '" target="_blank">' + data[i] + '</a>';
                        if (i < data.length - 1) {
                            rendered_pandaids += ', '
                        }
                    }
                    return rendered_pandaids
                }
            },
        ],
        rowGroup: {
            dataSrc: "errcode",
        },
        initComplete: function () {
            this.api().columns([0,1]).every(function (i) {
                var column = this;
                var select = $('<select><option value="">All</option></select>')
                    .appendTo( $(column.footer()).empty() )
                    .on('change', function () {
                        var val = $.fn.dataTable.util.escapeRegex(
                            $(this).val()
                        );

                        column
                            .search(val ? '^' + val + '$' : '', true, false)
                            .draw();
                    });
                if (i === 0) {
                    column.data().unique().sort().each(function (d, j) {
                        select.append('<option value="' + d + '">' + d + '</option>')
                    });
                }
                else {
                    column.data().unique().sort((a,b) => b - a).each(function (d, j) {
                        select.append('<option value="' + d + '">' + d + '</option>')
                    });
                }
            });
        }
    });
}
</script>

{% endif %}

{% endblock %}

{% block helptext %}
{% include "errorSummaryHelp.html" with helptitle="Error summary help" %}
{% endblock %}


