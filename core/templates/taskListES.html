{% extends "_base_core.html" %}
{% load staticfiles %}
{% block page_title %} {{ viewParams.MON_VO }} PanDA ES tasks{% endblock %}
{% block title %} <a class="menu-link" href="{% url 'index' %}">{{ viewParams.MON_VO }} PanDA monitor</a>{% endblock %}
{% block subtitle %}PanDA Event Service tasks{{viewParams.selection|safe }}
{% if vo %}     for VO {{ vo }}
{% endif %}
{% endblock %}

{% block subtitle_params %}
{% if tasksTotalCount != None%} <b> Total tasks found &#x7E; <a href="{% url 'taskList' %}?{% if requestString != None %}{{ requestString }}{% endif %}{% if display_limit %}display_limit={{display_limit }}{% endif %}&limit={{tasksTotalCount}}">{{ tasksTotalCount }}</a></b> {% endif %}
{% endblock %}

{% block js_head_page_library %}
  <script src="{% static 'js/humanize.min.js' %}"></script>
  <script src="{% static 'js/d3.v3.min.js' %}"></script>
{% endblock %}

{% block body %}

{% if requestParams.statenotupdated %}<br><b>Tasks in <span class="{{ requestParams.status }}">{{ requestParams.status }}</span> state for more than {{ requestParams.statenotupdated }} hours</b> {% endif %}
{% if requestParams.workinggroup %}<br><b>Working group: {{ requestParams.workinggroup }}</b> {% endif %}
{% if requestParams.username %}<br><b>User: <a href="{% url 'userInfo' requestParams.username %}?display_limit=300">{{ requestParams.username }}</a>     <a href="{% url 'userInfo' requestParams.username %}?display_limit=300">Show user page</a></b> {% endif %}
{% if requestParams.tasktype %}<br><b>Task type: {{ requestParams.tasktype }}</b> {% endif %}

{% if requestParams.campaign %}<br><b>Campaign: {{ requestParams.campaign }}</b> {% endif %}
{% if requestParams.project %}<br><b>Project: {{ requestParams.project }}</b> {% endif %}
{% if requestParams.stream %}<br><b>Stream: {{ requestParams.stream }}</b> {% endif %}
{% if requestParams.tag %}<br><b>Tag: {{ requestParams.tag }}</b> {% endif %}

{% if requestParams.transpath %}<br><b>Transformation: {{ requestParams.transpath }}</b> {% endif %}
{% if requestParams.transuses %}<br><b>Release: {{ requestParams.transuses }}</b> {% endif %}
{% if requestParams.processingtype %}<br><b>Processing type: {{ requestParams.processingtype }}</b> {% endif %}
{% if requestParams.cloud %}<br><b>Cloud: {{ requestParams.cloud }}</b> {% endif %}
{% if requestParams.parent_tid %}<br><b>Parent task: {{ requestParams.parent_tid }}</b> {% endif %}
{% if requestParams.status %}<br><b>{% if viewParams.MON_VO == 'ATLAS' %}Detailed JEDI task status {% else %}Task status {% endif %}: <span class='{{requestParams.status}}'>{{ requestParams.status }}</span></b> {% endif %}
{% if requestParams.superstatus %}<br><b>{% if viewParams.MON_VO == 'ATLAS' %}Task status {% else %}Task status {% endif %}: <span class='{{requestParams.superstatus}}'>{{ requestParams.superstatus }}</span></b> {% endif %}
{% if requestParams.hashtag %}<br><b>Hashtag: {{ requestParams.hashtag }} </b> {% endif %}

<p></p>

{% if tasks %}

{% if sumd %}

<table>
<tr class='tablesection'><th colspan=20> Task attribute summary, {{ ntasks }} tasks </th></tr>
{% for fdict in sumd %}
<tr><th> {{ fdict.field }} ({{ fdict.list|length }}) </th><td>
{% for item in fdict.list %}
<span {% if fdict.field == 'status' or fdict.field == 'superstatus' %} class='{{item.kname}} {{item.kname}}_tooltip' {% endif %}> {{ item.kname }} </span>
{% if not request.session.xurls or fdict.field not in request.session.xurls %}
    <a href="{{ xurl }}{{ fdict.field }}={{ item.kname }}">({{ item.kvalue }})</a>
{% else %}
    <a href="{{ request.session.xurls|get_item:fdict.field }}{{ fdict.field }}={{ item.kname }}">({{ item.kvalue }})</a>
{% endif %}
{% endfor %}
</td></tr>
{% endfor %}
{% if hashtags and hashtags|length > 0 %}
    <tr>
        <th>hashtags ({{ hashtags|length }})</th>
        <td>{% for hashtag in hashtags %}
                {% if 'hashtag' in requestParams %}
                    <a href="{{ nohashtagurl }}hashtag={{ requestParams.hashtag }},{{ hashtag }}">{{ hashtag }}</a>
                {% else %}
                    <a href="{{ xurl }}hashtag={{ hashtag }}">{{ hashtag }}</a>
                {% endif %}
                {% if not forloop.last %}, {% endif %}
            {% endfor %}</td>
    </tr>
{% endif %}
</table>
{% endif %}
<a onclick="javascript:buildPlots('d3splot', {{ idtasks }});">Show plots</a>
<div id="plots" style="display:none">
    <div id="jobsconsumptionplots"></div>
    <div class="d3splot" id="plot1" style="float:left;display:none"></div>

    <div class="d3splot" id="plot2" style="float:left;display:none"></div>

    <div class="d3splot" id="plot5" style="float:left;display:none"></div>

    <div class="d3splot" id="plot7" style="float:left;display:none"></div>

    <div class="d3splot" id="plot10" style="float:left;display:none"></div>

    <div class="d3splot" id="plot9" style="float:left;display:none"></div>

    <div class="d3splot" id="plot11" style="float:left;display:none"></div>

    <br style="clear:both;">

    <div class="d3splot" id="plot3" style="clear:both;float:left;display:none"></div>

    <div class="d3splot" id="plot4" style="float:left;display:none"></div>

    <div class="d3splot" id="plot6" style="float:left;display:none"></div>

    <div class="d3splot" id="plot8" style="float:left;display:none"></div>

    <div class="d3splot" id="plot12" style="float:left;display:none"></div>

    <div class="d3splot" id="plot13" style="float:left;display:none"></div>
    <br style="clear: both">
</div>
<br/><br/>
<table>
<tr class='tablesection'><th colspan=20> {{ display_limit }} tasks{% if 'sortby' in requestParams %}, sorted by {{ requestParams.sortby }} {% else %}, sorted by jeditaskid {% endif %}
{% if display_limit %} {% if tasks|length >= display_limit %}
        <font size=-1>Only the most recent {{ display_limit }} tasks are shown. <a href="{{ url_nolimit }}">Remove the limit</a></font>
{% endif %} {% endif %}
</th></tr>
<tr class='tablesection'>
	<th><a href="{{nosorturl}}">ID</a></th>
    {% if requestParams.tasktype == 'anal' %}<th>Jobset</th>{% endif %}
	<th>TaskType/ProcessingType     Group<br><font color='brown'>Logged status</font></th>

    <th>Site</th>

	<th>Task status</th>
	<th>Ninputfiles | <span class='finished'>finished</span> | <br><span class='failed'>failed</span></th>
	<th>Nevents | remaining</th>

	<th>Event dispatches</th>
	<th><a href="{{nosorturl}}">Created</a></th>
	<th><a href="{{nosorturl}}sortby=time-descending">Modified</a></th>
	<th><a href="{{nosorturl}}sortby=statetime-descending">State changed</a></th>
	<th><a href="{{nosorturl}}sortby=priority">Priority</a></th>
</tr>
{% for task in tasks %}
	<tr>
		<td><a href="{% url 'taskInfo' task.jeditaskid %}">{{ task.jeditaskid }}</a>
            <br> <a style="color: grey" href="{% url 'taskInfoNew' task.jeditaskid %}"><span class="tooltip-upper">{{ task.jeditaskid }}<span class="tooltip-text">Go to a new<br>input-based<br>ES task page</span></span></a>
		</td>
		{% if requestParams.tasktype == 'anal' %}<td>{{ task.reqid }}</td>{% endif %}
		<td>{{ task.tasktype }}{% if task.processingtype %}/{{ task.processingtype }} {% endif %}     {% if task.workinggroup %} <a href="{% url 'taskList' %}?workinggroup={{ task.workinggroup }}">{{ task.workinggroup }}</a>     {% endif %}  <a href="{% url 'taskList' %}?username={{ task.username }}">{{ task.username }}</a></font> {% if task.ticketid %}     <a href="https://its.cern.ch/jira/browse/{{ task.ticketid }}"> {% if task.ticketsystemtype %}{{ task.ticketsystemtype }} {% else %} JIRA {% endif %}</a> {% endif %}
{% if task.deftreqid %}     RequestID:<a href="https://prodtask-dev.cern.ch/prodtask/inputlist_with_request/{{task.deftreqid}}/">{{task.deftreqid}}</a> {% endif %}
		<br><font color='brown'>{{ task.errordialog|safe }}</font></td>

        <td> <a href="{% url 'siteInfo' task.site %}">{{ task.site }}</a> </td>

		<td  class='{{task.superstatus}}_fill'><a href="https://twiki.cern.ch/twiki/bin/view/PanDA/PandaJEDI#Transition_of_task_status">{% if task.superstatus %} <span class="{{ task.superstatus }}_tooltip">{{ task.superstatus }}</span> {% else %} <span class="{{ task.status }}_tooltip">{{ task.status }} </span> {% endif %}</a></td>
        <td>
            {{ task.dsinfo.nfiles }} | <span class='finished'> {{ task.dsinfo.nfilesfinished }}</span> | <span class='failed'>{{ task.dsinfo.nfilesfailed }}</span>
        </td>

        <td>
        {% if task.eventsData %}
            {{ task.eventsData.totev }} | {{ task.eventsData.totevrem }}
        {% endif %}
        </td>

        <td> {{task.estaskstr}}

           <div id="div-{{ task.jeditaskid }}">
                <a onclick="javascript:loadESData('{{ task.jeditaskid }}');">Show</a>
            </div>
        </td>
		<td><font size=-1>{{ task.creationdate }}</font></td>
		<td><font size=-1>{{ task.modificationtime }}</font></td>
		<td><font size=-1>{{ task.statechangetime }}</font></td>
		<td>{{ task.taskpriority }}</td>
	</tr>
{% endfor %}
</table>

{% else %}
    <p>No matches to query.</p>
{% endif %}
{% endblock %}

{% block js_body_page %}
  <script src="{% static 'js/d3jsplot.js' %}"></script>
<script type="text/javascript">

function loadESData(jeditaskid) {

    $('#div-'+jeditaskid).html("<img src='{% static "images/load.gif" %}'>  ");
    $.ajax({
        url: {% url 'taskESExtendedInfo' %},
        data: 'jeditaskid='+jeditaskid,
        async: true,
    }).done(function (response) {
        $('#div-'+jeditaskid).html(response);
    });

};
function toggleDetailDisplay(className) {
    el = document.getElementsByClassName(className);
    for (i = 0; i < el.length; i++) {
        el[i].style.display = (el[i].style.display == "none") ? "" : "none";
    }
}

function buildPlots(classname, idtasks) {

    el = document.getElementsByClassName(classname);
    var flag = 0;
    for (i = 0; i < el.length; i++) {
        flag = (el[i].innerHTML) ? flag : flag + 1;
    }
    if (flag > 0) {
        var values =  []
        $.ajax({
            type: "GET",
            url: '{% url 'tasksplots' %}?idtasks='+idtasks,
            async: false,
            cache: false,
            dataType: "json",
            data: {},
            success: function (data) {
                values = data;
                document.getElementById("plots").style.display = "block";
            },
            error : function($xhr,textStatus,errorThrown){
                var string= $xhr.responseJSON;
                var json_object= JSON.parse(string);
                console.log("ERROR : ",  json_object.message);
            }
        })
        ;
        $("#jobsconsumptionplots").html("<img src='{% static "images/load.gif" %}'>  ");

        if ('maxpss' in values) {
            pandamonplotHistNew(values['maxpss'], "#plot1", "Maximum PSS histogram");
        }
        if ('maxpssf' in values) {
            pandamonplotHistNew(values['maxpssf'], "#plot3", "Maximum PSS histogram (failed jobs)");
        }
        if ('walltime' in values) {
            pandamonplotHistNew(values['walltime'], "#plot2", "Walltime histogram");
        }
        if ('walltimef' in values) {
            pandamonplotHistNew(values['walltimef'], "#plot4", "Walltime histogram (failed jobs)");
        }
        if ('maxpsspercore' in values) {
            pandamonplotHistNew(values['maxpsspercore'], "#plot5", "Maximum PSS per core histogram");
        }
        if ('maxpsspercoref' in values) {
            pandamonplotHistNew(values['maxpsspercoref'], "#plot6", "Maximum PSS per core histogram (failed jobs)");
        }
        if ('hs06s' in values) {
            pandamonplotHistNew(values['hs06s'], "#plot7", "HS06s histogram");
        }
        if ('hs06sf' in values) {
            pandamonplotHistNew(values['hs06sf'], "#plot8", "HS06s histogram (failed jobs)");
        }
        if ('walltimeperevent' in values) {
            pandamonplotHistNew(values['walltimeperevent'], "#plot9", "Walltime per event histogram");
        }
        if ('cputime' in values) {
            pandamonplotHistNew(values['cputime'], "#plot10", "CPU time histogram");
        }
        if ('cputimeperevent' in values) {
            pandamonplotHistNew(values['cputimeperevent'], "#plot11", "CPU time per event histogram");
        }
        if ('cputimef' in values) {
            pandamonplotHistNew(values['cputimef'], "#plot12", "CPU time histogram (failed jobs)");
        }
        if ('cputimepereventf' in values) {
            pandamonplotHistNew(values['cputimepereventf'], "#plot13", "CPU time per event histogram (failed jobs)");
        }
        $("#jobsconsumptionplots").html("");
        toggleDetailDisplay(classname);
    }
    else {
        toggleDetailDisplay(classname);
    }
}

</script>
{% endblock %}

{% block helptext %}
{% include "taskInfoHelp.html" with helptitle="Task list help" show="all" %}
{% endblock %}

