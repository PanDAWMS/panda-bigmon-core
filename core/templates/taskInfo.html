{% extends "_base_core.html" %}
{% load static %}
{% block page_title %} {{ jeditaskid }} task  {% endblock %}


{% block subtitle %}{% if jeditaskid > 0 %}{{ jeditaskid }} task:{% endif %} <b>{{ task.taskname }}</b>{% endblock %}

{% block body %}


{% if columns %}
<div class="card bp-container">
<div class="card-divider">
    <p>{{ jeditaskid }} task: {{ taskname }} </p>
</div>
<div class="card-section">
<table class="bp-table">
<thead>
    <tr>
        <th>Task ID</th>
        {% if task.deftreqid %}
            <th> Request</th> {% endif %}
        {% if task.reqid != task.jeditaskid and not task.deftreqid %}
            <th>Jobset</th>{% endif %}
        <th>Type</th>
        <th>Working Group</th>
        <th>User</th>
        <th>Destination</th>
        {% if task.campaign %}
            <th> Campaign</th> {% endif %}
        <th>Task status</th>{% if task.superstatus %}{% if task.superstatus != task.status %}
        <th> Detailed JEDI status</th>{% endif %} {% endif %}
        {% if task.dsinfo %}
            <th>Nevents<br><span class='finished'>used</span></th>
            <th>HS06*sec<br>Expected<br>Total<br><span class='done'>done</span><br><span class='failed'>failed</span></th>
            <th>Ninputfiles<br><span class='finished'>finished</span><br><span class='failed'>failed</span></th>
        {% endif %}
        <th>Created</th>
        <th>Modified</th>
        <th>Cores</th>
        <th>Priority</th>
        <th>Parent</th>
        {% if task.ticketid %}
            <th>Tracker</th> {% endif %}
    </tr>
</thead>
<tbody>
    <tr>
        <td><a href="https://prodtask-dev.cern.ch/prodtask/task/{{ task.jeditaskid }}/"
               target="_blank">{{ task.jeditaskid }}</a></td>
        {% if task.deftreqid %}
            <td><a href="https://prodtask-dev.cern.ch/prodtask/inputlist_with_request/{{ task.deftreqid }}/"
                   target="_blank">{{ task.deftreqid }}</a></td> {% endif %}
        {% if task.reqid != task.jeditaskid and not task.deftreqid %}
            <td>{{ task.reqid }}</td>{% endif %}
        <td>{% if task.tasktype == 'anal' %} analy {% else %} {{ task.tasktype }} {% endif %}</td>
        <td>{% if task.workinggroup %} {{ task.workinggroup }} {% endif %} </td>
        <td><a href="{% url 'taskList' %}?username={{ task.username }}">{{ task.username }}</a></td>
        <td>{{ task.destination }}</td>
        {% if task.campaign %}
            <td><a href='/tasks/?campaign={{ task.campaign }}'>{{ task.campaign }}</a></td> {% endif %}
        <td class='{{ task.status }}_fill'>{% if task.superstatus %}
            <b><a href="https://twiki.cern.ch/twiki/bin/view/PanDA/PandaJEDI#Transition_of_task_status"
                  class="{{ task.superstatus }}_tooltip">{{ task.superstatus }}</a></b>
            {% if task.superstatus != task.status %}
                <td class='{{ task.status }}'><a href="https://twiki.cern.ch/twiki/bin/view/PanDA/PandaJEDI#Transition_of_task_status"
                        class="{{ task.status }}_tooltip">{{ task.status }}</a></td>{% endif %} {% else %}
            <a href="https://twiki.cern.ch/twiki/bin/view/PanDA/PandaJEDI#Transition_of_task_status"
               class="{{ task.superstatus }}_tooltip">{{ task.status }}</a>{% endif %}</td>

        {% if task.dsinfo %}
            <td> {{ task.totev }} <br>
                <span class='finished'>{{ task.totevproc }} ({{ task.pctfinished|floatformat }}%)</span></td>
            <td class="num"> {{ task.totevhs06 }}<br>{{ task.currenttotevhs06 }}<br><span
                    class='finished'>{{ task.totevprochs06 }}</span><br><span
                    class='failed'>{{ task.failedevprochs06 }}</span></td>
            <td> {{ task.dsinfo.nfiles }} <br>
                <span class='finished'>{{ task.dsinfo.nfilesfinished }} ({{ task.dsinfo.pctfinished|floatformat }}%)</span>
                {% if task.dsinfo.nfilesfailed > 0 %} <br>
                    <span class='failed'>{{ task.dsinfo.nfilesfailed }} ({{ task.dsinfo.pctfailed|floatformat }}%)</span>  {% endif %}
            </td>
        {% endif %}
        <td>{{ task.creationdate }}</td>
        <td>{{ task.modificationtime }}</td>
        <td>{{ task.corecount }}</td>
        <td>{{ task.taskpriority }}</td>
        <td><a href="{% url 'taskInfo' task.parent_tid %}">{% if task.parent_tid != task.jeditaskid %}
            {{ task.parent_tid }} {% endif %}</a></td>
        {% if task.ticketid %}
            <td><a href="https://its.cern.ch/jira/browse/{{ task.ticketid }}">{{ task.ticketsystemtype }}</a>
            </td>
        {% endif %}
    </tr>
</tbody>
</table>
</div>
</div>

<div class="bp-dd-container">
    <button class="button" type="button" data-toggle="taskextrainfo">Task extra info</button>
    <div class="dropdown-pane bp-dd-pane" id="taskextrainfo" data-dropdown data-hover="true" data-hover-pane="true">
        {% if requestParams.mode and requestParams.mode == 'nodrop' %}
            <a href="{{ nomodeurl }}mode=drop">Drop mode</a>
        {% else %}
            <a href="{{ nomodeurl }}mode=nodrop">Nodrop mode</a>
        {% endif %}
        {% if vomode == 'atlas' %}
            {% if task.tasktype == 'prod' %}
                <a href="https://prodtask-dev.cern.ch/prodtask/task_manage/#/?time_period=custom&task_type=production&task_id={{ task.jeditaskid }}"
                   target="_blank">Prod Task view (to manage task)</a>
                <a href="https://prodtask-dev.cern.ch/prodtask/task/{{ task.jeditaskid }}/">Prod Task page</a>
            {% elif  task.tasktype == 'anal' %}
                <a href="https://prodtask-dev.cern.ch/prodtask/task_manage/#/?time_period=custom&task_type=analysis&task_id={{ task.jeditaskid }}"
                   target="_blank">Prod Task view (to manage task)</a>
                <a href="https://prodtask-dev.cern.ch/prodtask/task/{{ task.jeditaskid }}/">Prod Task page</a>
            {% endif %}
        {% endif %}
        <a target="_blank" href="https://es-atlas.cern.ch/kibana/app/kibana?#/discover?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:'{{ task.kibanatimefrom }}',mode:quick,to:'{{ task.kibanatimeto }}'))&_a=(columns:!('timeEvent',fields.type,logLevel,message),filters:!(),index:'43ecb650-6c45-11e8-a7e3-ffbb2f24f6b4',interval:auto,query:(query_string:(analyze_wildcard:!t,query:'fields.type:%22atlasprodtaskbroker%22%20AND%20jediTaskID:{{ jeditaskid }}')),sort:!('timeEvent',asc),vis:(aggs:!((params:(field:jediTaskID,orderBy:'2',size:20),schema:segment,type:terms),(id:'2',schema:metric,type:count)),type:histogram))&indexPattern=43ecb650-6c45-11e8-a7e3-ffbb2f24f6b4&type=histogram">
            Task brokerage </a>
        <a target="_blank" href="https://es-atlas.cern.ch/kibana/app/kibana?#/discover?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:'{{ task.kibanatimefrom }}',mode:quick,to:'{{ task.kibanatimeto }}'))&_a=(columns:!('timeEvent',fields.type,message),filters:!(),index:'43ecb650-6c45-11e8-a7e3-ffbb2f24f6b4',interval:auto,query:(query_string:(analyze_wildcard:!t,query:'fields.type:%22{% if taskbrokerage == 'prod_brokerage' %}atlasprodjobbroker{% else %}atlasanaljobbroker{% endif %}%22%20AND%20jediTaskID:{{ jeditaskid }}')),sort:!('timeEvent',asc),vis:(aggs:!((params:(field:jediTaskID,orderBy:'2',size:20),schema:segment,type:terms),(id:'2',schema:metric,type:count)),type:histogram))&indexPattern=43ecb650-6c45-11e8-a7e3-ffbb2f24f6b4&type=histogram">
            Job brokerage </a>
        <a target="_blank" href="https://es-atlas.cern.ch/kibana/app/kibana?#/discover?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:'{{ task.kibanatimefrom }}',mode:quick,to:'{{ task.kibanatimeto }}'))&_a=(columns:!('timeEvent',fields.type,logLevel,message),index:'43ecb650-6c45-11e8-a7e3-ffbb2f24f6b4',interval:auto,query:(query_string:(analyze_wildcard:!t,query:'jediTaskID:{{ jeditaskid }}')),sort:!('timeEvent',asc))">
            Action logger</a>
        <a target="_blank" href="https://es-atlas.cern.ch/kibana/app/kibana?#/discover?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:'{{ task.kibanatimefrom }}',mode:quick,to:'{{ task.kibanatimeto }}'))&_a=(columns:!('timeEvent',logName,fields.type,logLevel,message),index:'5cff0440-6c45-11e8-a7e3-ffbb2f24f6b4',interval:auto,query:(query_string:(analyze_wildcard:!t,query:'logName.keyword:%22panda.log.RetrialModule%22%20AND%20fields.type:%22retrialmodule%22%20AND%20jediTaskID:{{ jeditaskid }}')),sort:!('timeEvent',desc))">
            Retrial Module logger</a>
        <a href="{% url 'errorSummary' %}?jeditaskid={{ jeditaskid }}">Error summary</a>
        {% if task.parent_tid != task.jeditaskid and task.parent_tid != None %}
            <a href="{% url 'taskInfo' task.parent_tid %}">Parent task {{ task.parent_tid }}</a>
        {% endif %}
        <a href="{% url 'taskList' %}?parent_tid={{ task.jeditaskid }}&display_limit=100">Child tasks</a>
        {% if task.ttcrequested != None and task.starttime != None %}
            <a href="{% url 'ttc' %}?jeditaskid={{ jeditaskid }}" target="_blank">TTC page</a>
        {% endif %}
    </div>
</div>
<div class="bp-dd-container">
    <button class="button" type="button" data-toggle="showjobs">Show jobs</button>
    <div class="dropdown-pane bp-dd-pane" id="showjobs" data-dropdown data-hover="true" data-hover-pane="true">
        {% if jobsummary %}
            <a href="{% url 'jobList' %}?jeditaskid={{ jeditaskid }}&mode=nodrop&display_limit=100">All
                (including retries)</a>
            <a href="{% url 'jobList' %}?jeditaskid={{ jeditaskid }}&mode=drop&display_limit=100">All (retries
                dropped)</a>
            <a href="{% url 'jobList' %}?jeditaskid={{ jeditaskid }}&specialhandling=sj">Scouts</a>
            <a href="{% url 'jobList' %}?jeditaskid={{ jeditaskid }}&jobstatus=finished|failed|cancelled">Ended</a>
            <a href="{% url 'jobList' %}?jeditaskid={{ jeditaskid }}&jobstatus=defined|waiting|pending|assigned|throttled|activated|sent|starting|running|holding|transferring">Active</a>
        {% endif %}
    </div>
</div>
<div class="bp-dd-container">
    <button class="button" type="button" data-toggle="taskparams">Task parameters and help</button>
    <div class="dropdown-pane bp-dd-pane" id="taskparams" data-dropdown data-hover="true" data-hover-pane="true">
        <a href="#jobparams">Job parameters</a>
        {% if jobscoutids.cputimescoutjob|length > 0 or jobscoutids.walltimescoutjob|length > 0 %}
            <a href="#scouts">Scout jobs</a>
        {% endif %}
        {% if taskparaml %}
            <a href="#taskparamsprodsys">Prodsys task parameters</a>
        {% endif %}
        <a href="#taskparamsjedi">PanDA/JEDI task parameters</a>
        <a href="#help">Help</a>
    </div>
</div>
<div class="bp-dd-container">
    <button class="button" type="button" data-toggle="jobsconsumption">Memory & walltime usage</button>
    <div class="dropdown-pane bp-dd-pane" id="jobsconsumption" data-dropdown data-hover="true" data-hover-pane="true">
        <a style="cursor: pointer;" href="#jobsconsumptionplots" onclick="javascript:buildPlots('d3splot');">Memory
                and walltime usage</a>
        <a href="http://atlas-kibana-panda.mwt2.org:5601/app/kibana#/dashboard/BP_a_task?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:'{{ task.kibanatimefrom }}',mode:absolute,to:'{{ task.kibanatimeto }}'))&_a=(filters:!(),options:(darkTheme:!t),panels:!((col:1,id:BP_Walltime_all_jobs,panelIndex:1,row:1,size_x:6,size_y:3,type:visualization),(col:7,id:BP_Walltime_failed_jobs,panelIndex:2,row:1,size_x:6,size_y:3,type:visualization),(col:1,id:BP_MAX_PSS_all_jobs,panelIndex:3,row:4,size_x:6,size_y:3,type:visualization),(col:7,id:BP_MAX_PSS_failed_jobs,panelIndex:4,row:4,size_x:6,size_y:3,type:visualization),(col:1,id:BP_MAX_PSS_per_core_all_jobs,panelIndex:5,row:7,size_x:6,size_y:3,type:visualization),(col:7,id:BP_MAX_PSS_per_core_failed_jobs,panelIndex:6,row:7,size_x:6,size_y:3,type:visualization)),query:(query_string:(analyze_wildcard:!t,lowercase_expanded_terms:!f,query:'jeditaskid:{{ task.jeditaskid }}')),title:BP_a_task,uiState:(P-1:(spy:(mode:(fill:!f,name:!n)),vis:(legendOpen:!t))))"
           target="_blank"><span class="tooltip-upper">Memory and Walltime usage (Kibana)<span class="tooltip-text">This Kibana instance is read-only. If you do not have access please contact Ilija Vukotic [ivukotic@cern.ch].</span></span></a>
    </div>
</div>
<div class="bp-dd-container">
    <button class="button" type="button" data-toggle="otherplots">Other plots</button>
    <div class="dropdown-pane bp-dd-pane" id="otherplots" data-dropdown data-hover="true" data-hover-pane="true">
        {% if not task.tasktype == 'anal' %}
            <a href="{% url 'ganttTaskChain' %}?jeditaskid={{ task.jeditaskid }}" target="_blank">Task Chain (Gantt diagram)</a>
            <a href="{% url 'taskchain' %}?jeditaskid={{ task.jeditaskid }}" target="_blank">Task Chain (Tree diagram)</a>
        {% endif %}
        {% if showtaskprof == True %}
            <a href="{% url 'taskprofileplot' %}?jeditaskid={{ task.jeditaskid }}" target="_blank">Task Profile</a>
        {% endif %}
        <a href="http://atlas-kibana-panda.mwt2.org:5601/app/kibana#/dashboard/9058c590-200d-11e7-84dc-8d3ed2710506?_g=(filters:!(),refreshInterval:(display:Off,pause:!f,value:0),time:(from:'{{ task.kibanatimefrom }}',mode:quick,to:'{{ task.kibanatimeto }}'))&_a=(filters:!(),options:(darkTheme:!t),panels:!((col:1,id:'3f4fa5d0-2001-11e7-a8cf-1bce3a1c32b4',panelIndex:1,row:1,size_x:3,size_y:3,type:visualization),(col:4,id:'94d395c0-2001-11e7-a8cf-1bce3a1c32b4',panelIndex:3,row:1,size_x:5,size_y:4,type:visualization),(col:1,id:'88c1ea50-2003-11e7-983d-8109a2d43cab',panelIndex:4,row:5,size_x:6,size_y:5,type:visualization),(col:9,id:c3a6e3c0-2001-11e7-a8cf-1bce3a1c32b4,panelIndex:5,row:1,size_x:4,size_y:4,type:visualization),(col:7,id:'88e76c50-2006-11e7-983d-8109a2d43cab',panelIndex:6,row:5,size_x:6,size_y:5,type:visualization),(col:1,id:b2c68750-2005-11e7-983d-8109a2d43cab,panelIndex:7,row:10,size_x:5,size_y:3,type:visualization),(col:6,id:f0d9a450-2005-11e7-983d-8109a2d43cab,panelIndex:8,row:10,size_x:6,size_y:3,type:visualization),(col:1,id:c9e1f1d0-2006-11e7-983d-8109a2d43cab,panelIndex:9,row:13,size_x:2,size_y:3,type:visualization),(col:3,id:'7c88d960-2008-11e7-983d-8109a2d43cab',panelIndex:10,row:13,size_x:10,size_y:3,type:visualization),(col:9,id:'12a10860-2008-11e7-983d-8109a2d43cab',panelIndex:12,row:16,size_x:4,size_y:3,type:visualization),(col:5,id:'0b3a75d0-2007-11e7-983d-8109a2d43cab',panelIndex:13,row:16,size_x:4,size_y:3,type:visualization),(col:1,id:'52964850-2007-11e7-983d-8109a2d43cab',panelIndex:14,row:16,size_x:4,size_y:3,type:visualization),(col:1,id:b07c2fe0-200a-11e7-983d-8109a2d43cab,panelIndex:15,row:19,size_x:12,size_y:4,type:visualization),(col:1,id:'039a7c60-2009-11e7-983d-8109a2d43cab',panelIndex:16,row:23,size_x:12,size_y:5,type:visualization)),query:(query_string:(analyze_wildcard:!t,lowercase_expanded_terms:!f,query:'jeditaskid:{{ task.jeditaskid }}')),title:BP_ES_task,uiState:(P-1:(vis:(legendOpen:!f)),P-10:(vis:(legendOpen:!f)),P-13:(vis:(legendOpen:!f)),P-14:(vis:(legendOpen:!f)),P-15:(vis:(legendOpen:!f)),P-16:(spy:(mode:(fill:!f,name:!n)),vis:(legendOpen:!f)),P-3:(vis:(legendOpen:!f)),P-4:(vis:(legendOpen:!f)),P-5:(vis:(legendOpen:!f)),P-6:(vis:(legendOpen:!f)),P-7:(vis:(legendOpen:!f)),P-8:(vis:(legendOpen:!f)),P-9:(vis:(legendOpen:!f))))"
           target="_blank"><span class="tooltip-upper">ES task dashboard (Kibana)<span class="tooltip-text">This Kibana instance is read-only. If you do not have access please contact Ilija Vukotic [ivukotic@cern.ch].</span></span></a>
    </div>
</div>

{% with 'done finished failed ready broken aborted defined' as finalstatelist %}
    {% if not task.status in finalstatelist %}
        <a onclick="javascript:killtasks({{ task.jeditaskid }}, 0);" class='bp-button alert'>Finish</a>
        <a onclick="javascript:killtasks({{ task.jeditaskid }}, 1);" class='bp-button alert'>Abort</a>
    {% endif %}
{% endwith %}

{% if warning.dropmode %}
    <div class="callout warning" data-closable>
      <h5>Warning! </h5>
      <p>{{ warning.dropmode }}</p>
        <button class="close-button small" aria-label="Dismiss alert" type="button" data-close>
            <span aria-hidden="true">&times;</span>
      </button>
    </div>
{% endif %}

{% if jobsummary or jobsummaryBuild or jobsummaryPMERGE %}
<div class="card bp-container">
<div class="card-divider">
    <p>Job status summary</p>
</div>
<div class="card-section">
<table class="bp-table unstriped hover">
<thead>
<tr>
    <td>Job type</td>
    {% for state in jobsummary %}
        <td class="{{ state.name }}"><b> {{ state.name }} </b></td>
    {% endfor %}
</tr>
</thead>
<tbody>
{% if jobsummaryBuild %}
<tr>
    <td>Build</td>
    {% for state in jobsummaryBuild %}
        <td {% if state.count > 0 %} class='{{ state.name }}_fill' {% endif %}>
                {% if state.count > 0 %}<b> <a href="{% url 'jobList' %}?jeditaskid={{ task.jeditaskid }}{% ifequal requestParams.mode 'nodrop' %}&mode=nodrop{% endifequal %}{% ifequal requestParams.mode 'drop' %}&mode=drop{% endifequal %}&prodsourcelabel=panda&transformation=build*&jobstatus={{ state.name }}&display_limit=100">
                <span class='{{ state.name }}_fill'>{{ state.count }}</span></a> </b> {% endif %}
        </td>
    {% endfor %}
</tr>
{% endif %}
{% if jobsummary %}
<tr>
    <td>Run</td>
    {% for state in jobsummary %}
        <td {% if state.count > 0 %} class='{{ state.name }}_fill' {% endif %}>
                {% if state.count > 0 %}<b> <a href="{% url 'jobList' %}?jeditaskid={{ task.jeditaskid }}{% ifequal requestParams.mode 'nodrop' %}&mode=nodrop{% endifequal %}{% ifequal requestParams.mode 'drop' %}&mode=drop{% endifequal %}&prodsourcelabel=user&jobstatus={{ state.name }}&display_limit=100">
                <span class='{{ state.name }}_fill'>{{ state.count }}</span></a> </b> {% endif %}
        </td>
    {% endfor %}
</tr>
{% endif %}
{% if jobsummaryPMERGE %}
<tr>
    <td>Merge</td>
    {% for state in jobsummaryPMERGE %}
        <td {% if state.count > 0 %} class='{{ state.name }}_fill' {% endif %}>
            {% if state.count > 0 %}<b> <a href="{% url 'jobList' %}?jeditaskid={{ task.jeditaskid }}&jobstatus={{ state.name }}&display_limit=100&processingtype=pmerge"><span
                    class='{{ state.name }}_fill'>{{ state.count }}</span></a> </b> {% endif %}
        </td>
    {% endfor %}
</tr>
{% endif %}
</tbody>
</table>
</div>
</div>
{% endif %}

{% if task.tasktype == 'anal' and warning.memoryleaksuspicion %}
    <div class="callout warning" data-closable>
      <h5>Warning! {{ warning.memoryleaksuspicion.message }}</h5>
      <p>At least one of jobs in this task consumed more max RSS than it is available on a computing site. Please check the next top memory consumed jobs and their memory and IO usage plots: </p>
      <ul>
      {% for job in warning.memoryleaksuspicion.jobs %}
        <li style="font-size: smaller"> <a class="blacklink bold hover" href="{% url 'jobInfo' job.pandaid %}">{{ job.pandaid }}</a> job consumed {{ job.jobmaxrss }} MB out of {{ job.sitemaxrss }} MB available on <a class="blacklink bold hover" href="{% url 'siteInfo' job.computingsite %}">{{ job.computingsite }}</a>, see <a class="blacklink bold hover" target="_blank" href="{% url 'memoryplot' %}?pandaid={{ job.pandaid }}">plots</a>
      {% endfor %}
      </ul>
      <button class="close-button small" aria-label="Dismiss alert" type="button" data-close>
            <span aria-hidden="true">&times;</span>
      </button>
    </div>
{% endif %}

{% if task.errordialog %}
    <div class="card error">
    <div class="card-divider ">
        <p>Logged status: {{ task.errordialog|safe }}</p>
    </div>
    {% if logtxt %}
        <div class="card-section scrollable">
            <pre>
            {{ logtxt }}
            </pre>
        </div>
    {% endif %}
    </div>
{% endif %}


<div id="jobsconsumptionplots"></div>
{% if 'maxpss' in plotsDict %}
    <div class="d3splot" id="plot1" style="float:left;display:none"></div> {% endif %}
{% if 'walltime' in plotsDict %}
    <div class="d3splot" id="plot2" style="float:left;display:none"></div> {% endif %}
{% if 'maxpsspercore' in plotsDict %}
    <div class="d3splot" id="plot5" style="float:left;display:none"></div> {% endif %}
{% if 'hs06s' in plotsDict %}
    <div class="d3splot" id="plot7" style="float:left;display:none"></div> {% endif %}
{% if 'cputime' in plotsDict %}
    <div class="d3splot" id="plot10" style="float:left;display:none"></div> {% endif %}
{% if 'walltimeperevent' in plotsDict %}
    <div class="d3splot" id="plot9" style="float:left;display:none"></div> {% endif %}
{% if 'cputimeperevent' in plotsDict %}
    <div class="d3splot" id="plot11" style="float:left;display:none"></div> {% endif %}
<br style="clear:both;">
{% if 'maxpssf' in plotsDict %}
    <div class="d3splot" id="plot3" style="clear:both;float:left;display:none"></div> {% endif %}
{% if 'walltimef' in plotsDict %}
    <div class="d3splot" id="plot4" style="float:left;display:none"></div> {% endif %}
{% if 'maxpsspercoref' in plotsDict %}
    <div class="d3splot" id="plot6" style="float:left;display:none"></div> {% endif %}
{% if 'hs06sf' in plotsDict %}
    <div class="d3splot" id="plot8" style="float:left;display:none"></div> {% endif %}
{% if 'cputimef' in plotsDict %}
    <div class="d3splot" id="plot12" style="float:left;display:none"></div> {% endif %}
{% if 'cputimepereventf' in plotsDict %}
    <div class="d3splot" id="plot13" style="float:left;display:none"></div> {% endif %}
<br style="clear: both">


{% if inctrs or outctrs %}
<div class="card bp-container">
<div class="card-divider">
    <p>Containers</p>
</div>
<div class="card-section">
<table class="bp-table unstriped hover">
<thead>
<tr>
    <th>Type</th>
    <th>Name</th>
</tr>
</thead>
<tbody>
{% if inctrs %}
{% for dsrec in inctrs %}
    <tr>
        <td>Input</td>
        <td><a href="{% url 'datasetList' %}?containername={{ dsrec }}&jeditaskid={{ jeditaskid }}">{{ dsrec }}</a></td>
    </tr>
{% endfor %}
{% endif %}
{% for dsrec in outctrs %}
    <tr>
        <td>Output</td>
        <td><a href="{% url 'datasetList' %}?containername={{ dsrec }}&jeditaskid={{ jeditaskid }}">{{ dsrec }}</a></td>
    </tr>
{% endfor %}
</tbody>
</table>
</div>
</div>
{% endif %}


<div id="dsStageDiv" class="badevents" ng-app="taskInfoAppAJS" ng-controller="StagingDSController" style="display:none;">
<table class="bp-table">
    <tr bgcolor='lightcyan'>
        <th colspan=20> Dataset staging information</th>
    </tr>
    <tr>
         <th>Staged / Total files <a target="_blank" href="{% url 'staginprogressplot' %}?jeditaskid={{ jeditaskid }}"><img src='/static/images/tinychart.png' width=14 height=14 border=0/></a></th>
         <td>{$ json['staged_files'] $} / {$ json['total_files'] $}</td>
    </tr>
    <tr ng-repeat="(key, value) in json" ng-if="key!='staged_files' && key!='total_files' && key!='taskid'">
         <th>{$ key $}</th>
         <td>{$ value $}</td>
    </tr>
</table>
</div>

{% if datasets %}
<div class="card bp-container">
<div class="card-divider">
    <p>Dataset processing information</p>
</div>
<div class="card-section">
<table class="bp-datatable" id="datasetstable">
<thead>
<tr>
    <th>Dataset, container name</th>
    <th>Type</th>
    <th>Stream</th>
    <th>Status</th>
    <th>Nfiles</th>
    <th>Nfiles finished</th>
    <th>Nfiles failed</th>
    <th>%</th>
    <th>Links</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>
{% else %}
    <p>No datasets were found for this task</p>
{% endif %}

{% if jobscoutids.cputimescoutjob|length > 0 or jobscoutids.walltimescoutjob|length > 0 or jobscoutids.ramcountscoutjob|length > 0 or jobscoutids.outdiskcountscoutjob|length > 0 or jobscoutids.iointensityscoutjob|length > 0 %}
<table>
    <a name="scouts"></a>
    <tr>
        <td><b>Scout jobs: </b></td>
        {% if jobscoutids.walltimescoutjob and jobscoutids.walltimescoutjob|length > 0 %}
            <td>Walltime:
                {% for job in jobscoutids.walltimescoutjob %}
                    <a href="{% url 'jobInfo' %}?pandaid={{ job }}">{{ job }}</a> {% if forloop.last %}
                {% else %} , {% endif %}
                {% endfor %}
            </td>{% endif %}
        {% if jobscoutids.cputimescoutjob and jobscoutids.cputimescoutjob|length %}
            <td>CPU time:
                {% for job in jobscoutids.cputimescoutjob %}
                    <a href="{% url 'jobInfo' %}?pandaid={{ job }}">{{ job }}</a> {% if forloop.last %}
                {% else %} , {% endif %}
                {% endfor %}
            </td>{% endif %}
        {% if jobscoutids.ramcountscoutjob and jobscoutids.ramcountscoutjob|length %}
            <td>RAM count:
                {% for job in jobscoutids.ramcountscoutjob %}
                    <a href="{% url 'jobInfo' %}?pandaid={{ job }}">{{ job }}</a> {% if forloop.last %}
                {% else %} , {% endif %}
                {% endfor %}
            </td>{% endif %}
        {% if jobscoutids.outdiskcountscoutjob and jobscoutids.outdiskcountscoutjob|length %}
            <td>Out disk count:
                {% for job in jobscoutids.outdiskcountscoutjob %}
                    <a href="{% url 'jobInfo' %}?pandaid={{ job }}">{{ job }}</a> {% if forloop.last %}
                {% else %} , {% endif %}
                {% endfor %}
            </td>{% endif %}
        {% if jobscoutids.iointensityscoutjob and jobscoutids.iointensityscoutjob|length %}
            <td>IO intensity:
                {% for job in jobscoutids.iointensityscoutjob %}
                    <a href="{% url 'jobInfo' %}?pandaid={{ job }}">{{ job }}</a> {% if forloop.last %}
                {% else %} , {% endif %}
                {% endfor %}
            </td>{% endif %}
    </tr>
</table>
{% endif %}


<div class="card bp-container">
<div class="card-divider">
    <p>Task related parameters</p>
</div>
<div class="card-section">
<table class="bp-table hover">
<tbody>
<tr>
    <th colspan="2">Job parameters</th>
</tr>
{% for p in jobparams %}
    <tr>
        <td colspan="2" class="wrap-words">{{ p|safe }}</td>
    </tr>
{% endfor %}
<tr>
    <th colspan="2">ProdSys2 task parameters</th>
</tr>
{% for p in taskparaml %}
    {% if p.name != 'jobParameters' and p.name != 'log' %}
        <tr>
            <td> {{ p.name }} </td>
            <td>{% if p.value != None %} {{ p.value }} {% endif %}</td>
        </tr>
    {% endif %}
{% endfor %}
<tr>
    <th colspan="2">PanDA/JEDI task parameters</th>
</tr>
{% for col in columns %}
    <tr>
        <td {% if col.name == 'cputime' or col.name == 'cputimeunit' or col.name == 'cpuefficiency' or col.name == 'basewalltime' or col.name == 'outdiskcount' or col.name == 'outdiskunit' or col.name == 'workdiskcount' or col.name == 'workdiskunit' %}
                    bgcolor='HoneyDew' {% endif %}>{{ col.name }} </td>
        <td> {% if col.value != 'None' %} {{ col.value }} {% endif %}</td>
    </tr>
{% endfor %}
</tbody>
</table>
</div>
</div>

{% else %}
    <p>
        PanDA task {% if jeditaskid > 0 %}{{ jeditaskid }}:{% endif %} <b>{{ taskname }}</b> not found.
    </p>
{% endif %}

{% endblock %}


{% block extra_js %}
<script type="text/javascript" src="{% static "node_modules/datatables.net/js/jquery.dataTables.min.js" %}"></script>
<script type="text/javascript" src="{% static "node_modules/d3/dist/d3.min.js" %}"></script>
<script type="text/javascript" src="{% static "node_modules/d3-scale/dist/d3-scale.min.js" %}"></script>
<script type="text/javascript" src="{% static "node_modules/d3-axis/dist/d3-axis.min.js" %}"></script>
<script type="text/javascript" src="{% static "node_modules/d3-shape/dist/d3-shape.min.js" %}"></script>
<script type="text/javascript" src="{% static "node_modules/c3/c3.min.js" %}"></script>

<script type="text/javascript" src="{% static "core/js/draw_plots.js" %}"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>

<script>
    var app = angular.module('taskInfoAppAJS', []).config(function ($interpolateProvider) {
        $interpolateProvider.startSymbol('{$');
        $interpolateProvider.endSymbol('$}');
    }).config(['$compileProvider', function ($compileProvider) {
    $compileProvider.debugInfoEnabled(false);
    }]);

    app.controller('StagingDSController', function ($scope, $http) {
        $scope.json = "";
        $scope.getStagingDS = function () {

            $http({
                    url: '/getstaginginfofortask/',
                    method: "GET",
                    params: {'jeditaskid':{{jeditaskid}}}
                }
            ).then(function (res) {
                $scope.json = angular.fromJson(res.data);
                if  ({{ jeditaskid }} in $scope.json) {
                    var displaydiv = document.getElementById('dsStageDiv');
                    displaydiv.style.display = "";
                    $scope.json = $scope.json[{{ jeditaskid }}];
                }
            });
        };
        var init = function () {
            $scope.getStagingDS();
        };
        init();
    });

function toggleDetailDisplay(className) {
    el = document.getElementsByClassName(className);
    for (i = 0; i < el.length; i++) {
        el[i].style.display = (el[i].style.display == "none") ? "" : "none";
    }
}

function toggleRowsDisplay(className) {
    el = document.getElementsByClassName(className);
    for (i = 0; i < el.length; i++) {
        el[i].style.display = (el[i].style.display == "none") ? "" : "none";
    }
}

(function ($) {
    $.fn.goTo = function () {
        $('html, body').animate({
            scrollTop: $(this).offset().top + 'px'
        }, 'fast');
        return this;
    }
})(jQuery);

function killtasks(taskID, action) {
    var message = ''
    if (action == 0)
        message = 'Are you sure you want to FINISH this task?'
    else
        message = 'Are you sure you want to ABORT this task?'
    if (confirm(message)) {
        $.ajax({
            url: {% url 'killtasks' %},
            data: {'task': taskID, 'action': action},
            async: true
        })
            .done(function (response) {
                var parcedResponse = $.parseJSON(response);
                alert(parcedResponse.detail);
                location.reload();
            });
    } else {
        // Do nothing!
    }
}

function buildPlots(classname) {

    el = document.getElementsByClassName(classname);
    var flag = 0;
    for (i = 0; i < el.length; i++) {
        flag = (el[i].innerHTML) ? flag : flag + 1;
    }
    if (flag > 0) {
        $("#jobsconsumptionplots").html("<img src='{% static "images/load.gif" %}'>  ");

        var values = {{ plotsDict|safe }};
        if ('maxpss' in values) {
            drawStackedBar(values['maxpss'], "#plot1", "Maximum PSS histogram");
        }
        {#if ('maxpssf' in values) {#}
        {#    pandamonplotHistNew(values['maxpssf'], "#plot3", "Maximum PSS histogram (failed jobs)");#}
        {#}#}
        {#if ('walltime' in values) {#}
        {#    pandamonplotHistNew(values['walltime'], "#plot2", "Walltime histogram");#}
        {#}#}
        {#if ('walltimef' in values) {#}
        {#    pandamonplotHistNew(values['walltimef'], "#plot4", "Walltime histogram (failed jobs)");#}
        {#}#}
        {#if ('maxpsspercore' in values) {#}
        {#    pandamonplotHistNew(values['maxpsspercore'], "#plot5", "Maximum PSS per core histogram");#}
        {#}#}
        {#if ('maxpsspercoref' in values) {#}
        {#    pandamonplotHistNew(values['maxpsspercoref'], "#plot6", "Maximum PSS per core histogram (failed jobs)");#}
        {#}#}
        {#if ('hs06s' in values) {#}
        {#    pandamonplotHistNew(values['hs06s'], "#plot7", "HS06s histogram");#}
        {#}#}
        {#if ('hs06sf' in values) {#}
        {#    pandamonplotHistNew(values['hs06sf'], "#plot8", "HS06s histogram (failed jobs)");#}
        {#}#}
        {#if ('walltimeperevent' in values) {#}
        {#    pandamonplotHistNew(values['walltimeperevent'], "#plot9", "Walltime per event histogram");#}
        {#}#}
        {#if ('cputime' in values) {#}
        {#    pandamonplotHistNew(values['cputime'], "#plot10", "CPU time histogram");#}
        {#}#}
        {#if ('cputimeperevent' in values) {#}
        {#    pandamonplotHistNew(values['cputimeperevent'], "#plot11", "CPU time per event histogram");#}
        {#}#}
        {#if ('cputimef' in values) {#}
        {#    pandamonplotHistNew(values['cputimef'], "#plot12", "CPU time histogram (failed jobs)");#}
        {#}#}
        {#if ('cputimepereventf' in values) {#}
        {#    pandamonplotHistNew(values['cputimepereventf'], "#plot13", "CPU time per event histogram (failed jobs)");#}
        {#}#}
        $("#jobsconsumptionplots").html("");
        toggleDetailDisplay(classname);
        {#        $('#jobsconsumptionplots').goTo();#}
    }
    else {
        toggleDetailDisplay(classname);
    }
}

function buildDatasetsTable() {

  $('#datasetstable').dataTable({
    //"bRetrieve": true,
    "lengthMenu": [[20, 50, 100, 200, -1], [20, 50, 100, 200, "All"]],
    "paging": true,
    "scrollX": true,
    "aaSorting": [[0,'asc']],
    "columnDefs": [
        {"type": "num-html", "targets": [4,5,6,7] }
    ],

    "ajax": {
        "processing": true,
        "url": "{% url 'taskInfo' task.jeditaskid %}?transkey={{ transkey }}&dt",
        "dataSrc" : function ( data ) {
          if ( data === null ) {
            return alert('The data was not loaded. Please press "Reload" button on the top right corner of page');
          }
          return data;
        }
    },
    "aoColumns": [
        {
            "data": "datasetname",
            sDefaultContent: "---",
            "render": function(data, type, row, meta) {
                return '<a href = "{% url 'datasetInfo' %}?datasetid=' + row['datasetid'] + '">'+row['datasetname']+'</a>'
            }
        },
        {
            "data": "type",
            sDefaultContent: "-",
        },
        {
            "data": "streamname",
            sDefaultContent: "-",
        },
        {
            "data": "status",
            sDefaultContent: "-"
        },
        {
            "data": "nfiles",
            sDefaultContent: "-",
            className: 'dt-body-right',
            "render": function(data, type, full, meta) {
                if (data > 0) {
                    return '<a href = "{% url 'fileList' %}?jeditaskid=' + full['jeditaskid'] + '&datasetid=' + full['datasetid'] + '">' + full['nfiles'] + '</a>'
                }
                else {
                    return data;
                }
            }
        },
        {
            "data": "nfilesfinished",
            sDefaultContent: "-",
            className: 'dt-body-right',
            "render": function(data, type, full, meta) {
                if (full['type'] == 'input' && data > 0) {
                    return '<a href = "{% url 'fileList' %}?procstatus=finished&jeditaskid=' + full['jeditaskid'] + '&datasetid=' + full['datasetid'] +  '"><snap class="finished">' + full['nfilesfinished'] + '</snap></a>'
                }
                else if (full['type'] == 'input' && data == 0) {
                    return data;
                }
                else {
                    return '-';
                }
                }
        },
        {
            "data": "nfilesfailed",
            sDefaultContent: "-",
            className: 'dt-body-right',
            "render": function(data, type, full, meta) {
                if (full['type'] == 'input' && data > 0) {
                    return '<a href = "{% url 'fileList' %}?procstatus=failed&jeditaskid=' + full['jeditaskid'] + '&datasetid=' + full['datasetid'] + '"><snap class="failed">' + full['nfilesfailed'] + '</snap></a>'
                }
                else if (full['type'] == 'input' && data == 0) {
                    return data;
                }
                else {
                    return '-';
                }
            }
        },
        {
            "data": "percentfinished",
            sDefaultContent: "-",
            className: 'dt-body-right'
        },
        {
            "data": "type",
            sDefaultContent: "-",
            "render": function(data, type, row, meta) {
                var links = '<a href="https://rucio-ui.cern.ch/did?scope=' + row['scope'] + '&name=' + row['datasetname'] + '" target="_blank"><img src="/static/images/rucio-logo.png" width=14 height=14 border=0></a>';
                if (row['type'] == 'input') {
                     links += ', <a href = "{% url 'jobList' %}?datasetid=' + row['datasetid'] + '&jeditaskid=' + row['jeditaskid'] + '"> jobs </a>'
                }
                return links;
            }

        },

    ],
    "createdRow": function ( row, data, index ) {
        $('td', row).eq(3).addClass(data['status'] + '_fill');
    }
  })
}

$(document).ready(function () {
    buildDatasetsTable();
    var url = window.location.href;
    if (url.indexOf("#jobsconsumptionplots") > -1) {
        buildPlots('d3splot');
        {#        $('#jobsconsumptionplots').goTo();#}
    }
});
</script>
{% endblock %}

{% block helptext %}
    <a name="help"></a>
    {% include "taskInfoHelp.html" with helptitle="Task detail page help" %}
{% endblock %}
