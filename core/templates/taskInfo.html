{% extends "_base_core.html" %}
{% load static %}{% load common_tags %}{% load humanize %}
{% block page_title %} {{ jeditaskid }} task {% endblock %}
{% block css_page_library %}
  <link rel="stylesheet" href="{% static "js/datatables/DataTables-1.10.13/css/dataTables.foundation.css" %}">
  <!-- Load c3.css -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.8/c3.min.css" rel="stylesheet">
{% endblock %}
{% block js_head_page_library %}
  <script src="{% static 'js/datatables/DataTables-1.10.13/js/jquery.dataTables.js' %}"></script>
  <script src="{% static 'js/datatables/DataTables-1.10.13/js/dataTables.foundation.js' %}"></script>
  <script src="{% static 'js/datatables/dataTables.num-html.js' %}"></script>
  <script src="{% static 'js/jquery.shorten.1.0.js' %}"></script>
  <!-- Load d3.js and c3.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.12.0/d3.min.js" charset="utf-8"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.8/c3.min.js"></script>
  <script type="text/javascript" src="/static/js/datatables/dataTables.rowsGroup.js"></script>
{% endblock %}

{% block subtitle %}
  {% if jeditaskid > 0 %}{{ jeditaskid }} task:{% endif %} <span class="hide-for-small-only"><b>{{ task.taskname }}</b></span>
{% endblock %}

{% block body %}

{% if columns %}
  <div id="taskInfoTable" data-ng-app="" data-ng-controller="taskInfoController">
  <div class="table-scroll">
  <table class="fresh-table unstriped">
    <thead class="section-emoji">
      <tr><th colspan="30">
        <div class="left">{{ jeditaskid }} task</div>
        <div class="right" ng-show="rating.is_allowed">Rate task<sup><span class="bp-tooltip bottom"><i class="fi-info"></i><span class="bp-tooltip tooltip-text">Rate the task processing from 1 (very bad) to 5 (excellent). We are collecting statistics to be used for an analysis by experts. In the future, it could be used to report problems directly.</span></span></sup>: 
          <a ng-repeat="(key, value) in rating.emoji_desc" ng-click="rating.emojiButtonClick(key)" >{$ value $}</a></div>
      </th></tr>
    </thead>
    <tbody>
      <tr>
        <th>Task ID</th>
        {% if task.campaign %}
            <th> Campaign</th>
        {% endif %}
        {% if task.deftreqid %}
            <th> Request</th>
        {% endif %}
        <th>Type</th>
        <th>Processing type</th>
        {% if task.workinggroup %}
          <th>Working Group</th>
        {% endif %}
        <th>User</th>
        <th>Nucleus</th>
        <th class="mid">Status</th>
        {% if task.superstatus and task.superstatus != task.status %}
            <th> Detailed JEDI status</th>
        {% endif %}
        {% if task.idds_info and task.idds_info.task_type == 'hpo' %}
            <th class="num"> HP points
              <br><span class='finished'>finished</span></th>
        {% else %}
          {% if task.dsinfo %}
            <th class="num"> N input files
                <br><span class='finished'>finished</span>
                {% if task.dsinfo.nfilesfailed > 0 %}
                  <br><span class='failed'>failed</span>
                {% endif %}
            </th>
            {% if task.totev > 0 %}
              <th class="num">N input events <br><span class='finished'>used</span></th>
            {% endif %}
            {% if task.totevoutput > 0 %}
              <th class="num">N output events</th>
            {% endif %}
            {% if task.transpath == 'ReSim_tf.py' %}
              <th class="num">Resim events:
                <br> average
                <br> total
              </th>
            {% endif %}
          {% endif %}
        {% endif %}
        {% if task.dsinfo and 'hs23s_humanized' in task %}
          <th class="num">HS23s
            <br> <span class="closed">Expected</span>
            <br> Total
            <br><span class='done'>done</span>
            <br> <span class='failed'>failed</span>
          </th>
        {% endif %}
        <th>Time stamps:
          <br><span class="defined">created</span>
          <br><span class="closed">last modified</span>
        </th>
        <th>Cores</th>
        <th>Priority:
          <br><span class="defined">original</span>
          <br><span class="closed">current</span>
        </th>
        <th>Attempt</th>
        <th>Rating</th>
        {% if task.parent_tid and task.parent_tid != task.jeditaskid %}
          <th>Parent</th>
        {% endif %}
        {% if 'gco2_global_humanized' in task and 'total' in task.gco2_global_humanized %}
          <th>CO<sub>2</sub> <a class="bp-tooltip left blacklink" target="_blank" href="https://panda-wms.readthedocs.io/en/latest/advanced/carbon_footprint.html"><i class="fi-info"></i>
            <span class="bp-tooltip tooltip-text">Estimated CO<sub>2</sub> emission, based on the weighted average of regional electricity sources for ATLAS Grid computing, click to read in more detail</span></a>
            total<br><span class="done">done</span><br><span class="failed">failed</span>
          </th>
        {% endif %}
      </tr>
      <tr>
        <td>
          {% if viewParams.MON_VO == 'ATLAS' %}
            <a href="https://prodtask-dev.cern.ch/prodtask/task/{{ task.jeditaskid }}/"
               target="_blank">{{ task.jeditaskid }}</a>
          {% else %}
            {{ task.jeditaskid }}
          {% endif %}
        </td>
        {% if task.campaign %}
            <td><a href='{% url 'taskList' %}?campaign={{ task.campaign }}'>{% if task.campaign_cut %}{{ task.campaign_cut }}{% else %}{{ task.campaign }}{% endif %}</a></td>
        {% endif %}
        {% if task.deftreqid %}
            <td>
              {% if viewParams.MON_VO == 'ATLAS' %}
                <a href="https://prodtask-dev.cern.ch/prodtask/inputlist_with_request/{{ task.deftreqid }}/#inputList{{ task.slice }}" target="_blank">{{ task.deftreqid }}</a>
                {% if task.reference_link %}<a target="_blank" href="{{ task.reference_link }}"><img height="14" width="36" src="{% static 'images/jira-logo-color.png' %}"></a>{% endif %}
              {% else %}
                {{ task.deftreqid }}
              {% endif %}
            </td>
        {% endif %}
        <td>{% if task.tasktype == 'anal' %} analy {% else %} {{ task.tasktype }} {% endif %}</td>
        <td>{% if task.processingtype %} {{ task.processingtype }} {% endif %} </td>
        {% if task.workinggroup %}
          <td> {{ task.workinggroup }} </td>
        {% endif %}
        <td><a href="{% url 'taskList' %}?username={{ task.username }}">{{ task.username }}</a></td>
        <td>{% if task.nucleus %}{{ task.nucleus }}{% else %}&mdash;{% endif %}</td>
        <td class='{{ task.status }}_fill mid'>
          {% if task.superstatus %}
            <a href="https://panda-wms.readthedocs.io/en/latest/terminology/terminology.html#task"
                  class="bp_tooltip task_{{ task.superstatus }}">{{ task.superstatus }}</a>
          {% else %}
            <a href="https://panda-wms.readthedocs.io/en/latest/terminology/terminology.html#task"
               class="bp_tooltip task_{{ task.status }}"><b>{{ task.status }}</b></a>
          {% endif %}
        </td>
        {% if task.superstatus and task.superstatus != task.status %}
          <td class='{{ task.status }}_fill'>
            <a href="https://panda-wms.readthedocs.io/en/latest/terminology/terminology.html#task"
               class="bp_tooltip task_{{ task.status }}"><b>{{ task.status }}</b></a>
          </td>
        {% endif %}
        {% if task.idds_info and task.idds_info.task_type == 'hpo' %}
          <td class="num">
            <div ng-show="idds.loading">LOADING...</div>
            <div ng-cloak ng-show="!idds.loading">
              <span ng-bind="idds.json.out_total_files"><span>{$ idds.json.out_total_files $}</span></span><br>
              <span class='finished'><span>{$ idds.json.out_total_files $}</span> (<span>{$ idds.json.pctprocessed $}</span>%) </span>
            </div>
          </td>
        {% else %}
          {% if task.dsinfo %}
            <td class="num"> {{ task.dsinfo.nfiles|intcomma }}
              {% if task.dsinfo.nfilesmissing > 0 %}
                <span class='lost tooltip-upper'> + {{ task.dsinfo.nfilesmissing }} lost <i class="fi-info"></i><span class="tooltip-text">The files were unavailable at a time of the task running therefore the PanDA did not create jobs for processing them and they are not included to the number of total input files.</span></span>
              {% endif %}
              <br><span class='finished'>({{ task.dsinfo.pctfinished|floatformat }}%) {{ task.dsinfo.nfilesfinished|intcomma }} </span>
              {% if task.dsinfo.nfilesfailed > 0 %}
                <br><span class='failed'>({{ task.dsinfo.pctfailed|floatformat }}%) {{ task.dsinfo.nfilesfailed|intcomma }}</span>
              {% endif %}
            </td>
            {% if task.totev > 0 %}
              <td class="num"> {{ task.totev|intcomma }}
                <br><span class='finished'>({{ task.pctfinished|floatformat }}%) {{ task.totevproc|intcomma }}</span>
              </td>
            {% endif %}
            {% if task.totevoutput > 0 %}
              <td class="num"> {{ task.totevoutput|intcomma }}</td>
            {% endif %}
            {% if task.transpath == 'ReSim_tf.py' %}
              <td class="num">
                {% if task.resimeventspernevents_avgpercent %}{{ task.resimeventspernevents_avgpercent|intcomma }}%{% else %}-{% endif %}
                <br> {% if task.resimevents_sum %}{{ task.resimevents_sum|intcomma }}{% else %}-{% endif %}
              </td>
            {% endif %}
          {% endif %}
        {% endif %}
        {% if task.dsinfo and 'hs23s_humanized' in task %}
          <td class="num">
            <span class="closed">{% if task.hs23s_humanized.expected.value %}{{ task.hs23s_humanized.expected.value|intcomma }}{{ task.hs23s_humanized.expected.unit }}{% else %}&mdash;{% endif %}</span>
            <br>{{ task.hs23s_humanized.total.value|intcomma }}{{ task.hs23s_humanized.total.unit }}
            <br><span class='finished'>{{ task.hs23s_humanized.finished.value|intcomma }}{{ task.hs23s_humanized.finished.unit }}</span>
            <br><span class='failed'>{{ task.hs23s_humanized.failed.value|intcomma }}{{ task.hs23s_humanized.failed.unit }}</span>
          </td>
        {% endif %}
        <td>{% if task.creationdate %}<span class="defined">{{ task.creationdate }}</span>{% else %}&mdash;{% endif %}
          <br>{% if task.modificationtime %}<span class="closed">{{ task.modificationtime }}</span>{% else %}&mdash;{% endif %}
        </td>
        <td>{{ task.corecount }}</td>
        <td><span class="defined">{{ task.taskpriority }}</span><br><span class="closed">{{ task.currentpriority }}</span></td>
        <td>{{ task.attemptnr }}</td>
        <td> <a class="bp-tooltip left" ng-show="rating.total>0" ng-click="rating.is_shown_feedback_list=true">{$ rating.pick_emoji(rating.total) $} ({$ rating.total $})<span class="bp-tooltip tooltip-text">Show ratings and provided feedback messages</span></a><span ng-show="rating.total<=0">&mdash;</span></td>
        {% if task.parent_tid and task.parent_tid != task.jeditaskid %}
          <td><a href="{% url 'taskInfo' task.parent_tid %}">{{ task.parent_tid }}</a></td>
        {% endif %}
        {% if 'gco2_global_humanized' in task and 'total' in task.gco2_global_humanized %}
          <td>{{ task.gco2_global_humanized.total.value|intcomma }}{{ task.gco2_global_humanized.total.unit }}
            <br><span class="done">{{ task.gco2_global_humanized.finished.value|intcomma }}{{ task.gco2_global_humanized.finished.unit }}</span>
            <br><span class="failed">{{ task.gco2_global_humanized.failed.value|intcomma }}{{ task.gco2_global_humanized.failed.unit }}</span></td>
        {% endif %}
      </tr>
    </tbody>
  </table>
  </div>

  <div class="bp-modal ng-hide" ng-show="rating.is_shown_feedback_modal">
    <div class="emoji-modal-content content">
        <!-- Close Button -->
        <a ng-click="rating.closeFeedbackModal()"><span class="close">&times;</span></a>
        <!-- Modal Content -->
        <div>
            <label>How did the task processing go? Share what went well or what could be improved. Your feedback will be submitted to the ATLAS Distributed Computing Operations Team!</label>
            <textarea ng-model="rating.feedback" ng-change="rating.validateFeedbackMessage()" id="user-comment" placeholder="E.g., fast processing, delays, high failure rate, unclear errors, or suggestions for improvement..."></textarea>
            <p class="ng-hide alert" ng-show="rating.is_shown_modal_alert">{$ rating.modal_alert $}</p>
            <a class="bp-button submit" ng-click="rating.submitFeedback()" ng-disabled="rating.submitting || (rating.new < 3 && !rating.isValidFeedbackMessage())">{$ rating.submit_button_text $}</a>
        </div>
    </div>
  </div>
  
  <div class="ng-hide" ng-show="rating.is_shown_feedback_list">
    <table class="bp-table secondary unstriped">
      <thead><tr><th colspan="3">Provided ratings and feedback for task:</th></tr></thead>
      <tbody><tr>
        <th>User</th>
        <th>Rating</th>
        <th>Feedback message</th>
      </tr>
      <tr ng-repeat="row in rating.feedback_list">
        <td>{$ row.username $}</td>
        <td>{$ rating.pick_emoji(row.rating) $}</td>
        <td>{$ row.feedback $}</td>
      </tr>
      </tbody>
    </table>
  </div>
  
  </div>


  {% if warning.submission %}
    <div class="callout warning" data-closable>
      <h5><i class="fi-alert"></i> Warning! Some options used in this task submission command are concerning!</h5>
      {% for w, message in warning.submission.items %}
        <p> {{ message|safe }}</p>
      {% endfor %}
      <button class="close-button small" aria-label="Dismiss alert" type="button" data-close>
        <span aria-hidden="true">&times;</span>
      </button>
    </div>
  {% endif %}

  {% if task.errordialog %}
    <div class="card bp-container-simple warning">
      {% if logtxt %}
        <div class="card-divider">
          <h5>Logged status: {{ task.errordialog|safe }}</h5>
        </div>
        <div class="card-section scrollable">
          <pre>
          {{ logtxt }}
          </pre>
        </div>
      {% else %}
        <div class="card-divider errorlog">
          <h5>Logged status: {{ task.errordialog|safe }}</h5>
        </div>
      {% endif %}
    </div>
  {% endif %}

  {% if viewParams.MON_VO == 'ATLAS' %}
    {% if info.split_rule %}
      <div class="callout info">
        <h5>The split rule has been changed for this task: </h5>
        <ul>
         {% for message in  info.split_rule.messages %}
             <li>{{ message }}</li>
         {% endfor %}
        </ul>
        <p>The control of the job size explained <a target="_blank" href="https://panda-wms.readthedocs.io/en/latest/client/prun.html#how-to-control-job-size">here</a> </p>
        </div>
    {% endif %}
  {% endif %}

  <div class="row bp-container-wrapper">
  <div class="columns small-7 medium-8 large-9">
  <div class="bp-dropdown-button">
      <button class="dropdown">Task extra info</button>
      <div class="dropdown-items">
          {% if requestParams.mode and requestParams.mode == 'nodrop' %}
              <a {% if 'dropmode' in warning %}class="disabled"{% endif %} href="{{ nomodeurl }}mode=drop">Switch to drop mode</a>
          {% else %}
              <a href="{{ nomodeurl }}mode=nodrop">Switch to nodrop mode</a>
          {% endif %}
          {% if viewParams.MON_VO == 'ATLAS' %}
                {% if task.tasktype == 'prod' %}
                    <a href="https://prodtask-dev.cern.ch/prodtask/task/{{ task.jeditaskid }}/" target="_blank">Prod Task (to manage task)</a>
                {% elif  task.tasktype == 'anal' %}
                    <a href="https://prodtask-dev.cern.ch/prodtask/task/{{ task.jeditaskid }}/" target="_blank">Prod Task (to manage task)</a>
                {% endif %}
              <a target="_blank" href="https://os-atlas.cern.ch/dashboards/app/data-explorer/discover/#?_a=(discover:(columns:!(message),interval:auto,sort:!(!('@timestamp',desc))),metadata:(indexPattern:'6bf79810-bfac-11ea-b7f2-27bdf2c0b5dc',view:discover))&_q=(filters:!(),query:(language:lucene,query:'fields.type:%22atlasprodtaskbroker%22%20AND%20jediTaskID:{{ jeditaskid|safe }}'))&_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:'{{ task.kibanatimefrom|safe }}',to:'{{ task.kibanatimeto|safe }}'))">Task
                  brokerage </a>
              <a target="_blank" href="https://os-atlas.cern.ch/dashboards/app/data-explorer/discover/#?_a=(discover:(columns:!(message),interval:auto,sort:!(!('@timestamp',desc))),metadata:(indexPattern:'6bf79810-bfac-11ea-b7f2-27bdf2c0b5dc',view:discover))&_q=(filters:!(),query:(language:lucene,query:'fields.type:%22{% if task.brokerage == 'prod_brokerage' %}atlasprodjobbroker{% else %}atlasanaljobbroker{% endif %}%22%20AND%20jediTaskID:{{ jeditaskid|safe }}'))&_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:'{{ task.kibanatimefrom|safe }}',to:'{{ task.kibanatimeto|safe }}'))">Job
                  brokerage </a>
              <a target="_blank" href="https://os-atlas.cern.ch/dashboards/app/data-explorer/discover/#?_a=(discover:(columns:!(fields.type,logLevel,message),interval:auto,sort:!(!('@timestamp',desc))),metadata:(indexPattern:'6bf79810-bfac-11ea-b7f2-27bdf2c0b5dc',view:discover))&_q=(filters:!(),query:(language:lucene,query:'jediTaskID:{{ jeditaskid|safe }}'))&_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:'{{ task.kibanatimefrom|safe }}',to:'{{ task.kibanatimeto|safe }}'))">Action
                  logger </a>
              <a target="_blank" href="https://os-atlas.cern.ch/dashboards/app/data-explorer/discover/#?_a=(discover:(columns:!(logName,fields.type,logLevel,message),interval:auto,sort:!(!('@timestamp',desc))),metadata:(indexPattern:'620eaaf0-bfac-11ea-b7f2-27bdf2c0b5dc',view:discover))&_q=(filters:!(),query:(language:lucene,query:'logName.keyword:%22panda.log.RetrialModule%22%20AND%20fields.type:%22retrialmodule%22%20%20AND%20jediTaskID:{{ jeditaskid|safe }}'))&_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:'{{ task.kibanatimefrom|safe }}',to:'{{ task.kibanatimeto|safe }}'))">Retrial
                  Module logger </a>
          {% endif %}
          <a {% if task.n_jobs_total == 0 %}class="disabled"{% endif %} href="{% url 'errorSummary' %}?jeditaskid={{ jeditaskid }}&display_limit=10">Error summary</a>
          <a {% if task.n_jobs_total == 0 or 'archive' in warning %}class="disabled"{% endif %} href="{% url 'errorSummary' %}?jeditaskid={{ jeditaskid }}&extra=unfinishedfiles&display_limit=10">Errors for unfinished files</a>
          {% if task.parent_tid != task.jeditaskid and task.parent_tid != None %}
              <a href="{% url 'taskInfo' task.parent_tid %}">Parent task {{ task.parent_tid }}</a>
          {% endif %}
          <a href="{% url 'taskList' %}?parent_tid={{ task.jeditaskid }}&display_limit=100">Child tasks</a>
      </div>
  </div>

  <div class="bp-dropdown-button">
    <button class="dropdown">Show jobs</button>
    <div class="dropdown-items">
      <a {% if task.n_jobs_total == 0 or 'archive' in warning %}class="disabled"{% endif %} href="{% url 'jobList' %}?jeditaskid={{ jeditaskid }}&mode=nodrop&display_limit=100">All (including retries)</a>
      <a {% if task.n_jobs_total == 0 or 'archive' in warning %}class="disabled"{% endif %} href="{% url 'jobList' %}?jeditaskid={{ jeditaskid }}&mode=drop&display_limit=100">All (retries dropped)</a>
      <a {% if task.n_jobs_total == 0 or 'archive' in warning %}class="disabled"{% endif %} href="{% url 'jobList' %}?jeditaskid={{ jeditaskid }}&specialhandling=sj">Scouts</a>
      <a {% if task.n_jobs_total == 0 or 'archive' in warning %}class="disabled"{% endif %} href="{% url 'jobList' %}?jeditaskid={{ jeditaskid }}&jobstatus=finished|failed|cancelled">Ended</a>
      <a {% if task.n_jobs_total == 0 or 'archive' in warning %}class="disabled"{% endif %} href="{% url 'jobList' %}?jeditaskid={{ jeditaskid }}&jobstatus=defined|waiting|pending|assigned|throttled|activated|sent|starting|running|holding|transferring">Active</a>
    </div>
  </div>

  <div class="bp-dropdown-button">
      <button class="dropdown">Task parameters and help</button>
      <div class="dropdown-items">
          <a href="#taskflow" id="button-taskflow">Show taskflow</a>
          <a href="#statuslog" id="button-task-status-log">Show task status log</a>
          {% if viewParams.MON_VO == 'ATLAS' %}
            <a href="#tasklogs" id="button-task-logs">Show task logs from OpenSearch</a>
            <a href="#datamovement" id="button-task-data-movement">Show task data movement summary</a>
          {% endif %}
          <a href="#jobparams">Jump to job parameters</a>
          {% if jobscoutids|length > 0 %}
              <a href="#scouts">Jump to scout jobs</a>
          {% endif %}
          {% if taskparams %}
              <a href="#taskparamsprodsys">Jump to ProdSys task parameters</a>
          {% endif %}
          <a href="#taskparamsjedi">Jump to PanDA/JEDI task parameters</a>
          <a href="#help">Jump to help</a>
      </div>
  </div>

  <div class="bp-dropdown-button">
      <button class="dropdown">Memory & walltime usage</button>
      <div class="dropdown-items">
          <a {% if task.n_jobs_total == 0 %}class="disabled"{% endif %} href="#plots" id="button-task-plots" >Show plots in the page</a>
          <a href="https://atlas-kibana.mwt2.org:5601/s/webexports/app/dashboards#/view/BP_a_task?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:'{{ task.kibanatimefrom }}',to:'{{ task.kibanatimeto }}'))&_a=(description:'',filters:!(),fullScreenMode:!f,options:(darkTheme:!t),query:(language:lucene,query:'jeditaskid:{{ task.jeditaskid }}'),timeRestore:!t,title:BP_a_task,viewMode:view)" target="_blank"><span class="tooltip-upper">Dashboard @ Kibana </span></a>
          {% if userexpert %}
          <a href="https://atlas-kibana.mwt2.org:5601/app/dashboards#/view/BP_ES_task?_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:'{{ task.kibanatimefrom }}',to:'{{ task.kibanatimeto }}'))&_a=(description:'',filters:!(),fullScreenMode:!f,options:(darkTheme:!t),query:(language:lucene,query:'jeditaskid:{{ task.jeditaskid }}'),timeRestore:!t,title:BP_a_task,viewMode:view)" target="_blank"><span class="tooltip-upper">Editable dashboard @ Kibana for experts</span></a>
          {% endif %}
      </div>
  </div>

  <div class="bp-dropdown-button">
      <button class="dropdown">Other plots</button>
      <div class="dropdown-items">
          {% if not task.tasktype == 'anal' and viewParams.MON_VO == 'ATLAS' %}
              <a href="{% url 'ganttTaskChain' %}?jeditaskid={{ task.jeditaskid }}" target="_blank">Task Chain (Gantt diagram)</a>
              <a href="{% url 'taskchain' %}?jeditaskid={{ task.jeditaskid }}" target="_blank">Task Chain (Tree diagram)</a>
          {% endif %}
          <a {% if task.n_jobs_total == 0 %}class="disabled"{% endif %} href="{% url 'taskProfileMonitor' task.jeditaskid %}" target="_blank">Task Profile</a>
     </div>
  </div>
  </div>

  <div class="columns small-5 medium-4 large-3 align-right">
  {% with 'done finished failed ready broken aborted defined' as finalstatelist %}
      {% if not task.status in finalstatelist %}
          <a id="button-task-action-finish-panda" class="bp-button kill">Finish</a>
          <a id="button-task-action-abort-panda" class="bp-button kill">Abort</a>
      {% endif %}

  {% endwith %}
  </div>
  </div>
  
  {% if warning.dropmode %}
      <div class="callout warning" data-closable>
        <h5>Warning! </h5>
        <p>{{ warning.dropmode }}</p>
        <button class="close-button small" aria-label="Dismiss alert" type="button" data-close>
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
  {% endif %}
  {% if warning.archive %}
      <div class="callout warning" data-closable>
        <h5>Warning! </h5>
        <p>{{ warning.archive }}</p>
        <button class="close-button small" aria-label="Dismiss alert" type="button" data-close>
              <span aria-hidden="true">&times;</span>
        </button>
      </div>
  {% endif %}

  {% if jobsummary %}
    {% if requestParams.warning %}
      <div class="callout small alert">
        <p style="color:brown">{{ requestParams.warning }}</p>
      </div>
    {% endif %}
    <div class="table-scroll">
    <table class="fresh-table unstriped">
      <thead>
        <tr>
            <th colspan=20>
                <b>States of jobs in this task {% if mode %}[{{ mode }} mode]{% endif %}</b>
            </th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th></th>
            {% for state in jobsummary.0.job_state_counts %}
              <th class="{{ state.name }}"><b> {{ state.name }} </b></th>
            {% endfor %}
        </tr>
        {% for job_category_states in jobsummary %}
          <tr>
            <th>{{ job_category_states.value | title }}</th>
            {% for state in job_category_states.job_state_counts %}
              <td {% if state.count > 0 %} class='{{ state.name }}_fill' {% endif %}>
                    {% if state.count > 0 %}
                        <b> <a {% if 'archive' in warning %}class="disabled"{% endif %} href="{% url 'jobList' %}?jeditaskid={{ jeditaskid }}&jobstatus={{ state.name }}&mode={{ mode }}{% if job_category_states.value == 'build' %}&transformation=build*{% elif job_category_states.value == 'merge' %}&processingtype=pmerge{% elif viewParams.MON_VO == 'ATLAS' %}&processingtype=!pmerge&prodsourcelabel={% if task.tasktype == 'prod' %}managed{% else %}user{% endif %}{% endif %}&display_limit=100">
                            <span class='{{ state.name }}_fill'>{% if state.count > 0 %} {{ state.count }} {% endif %}</span></a> </b>
                    {% endif %}
              </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
  {% else %}
    <div class="card bp-container-simple info">
      <div class="card-divider">
        <p>No jobs were found for the task</p>
      </div>
    </div>
  {% endif %}

  {% if jobscoutids|length > 0 %}
    <div class="table-scroll">
    <table class="fresh-table unstriped">
      <tbody>
        <tr>
          <th><b> Scout jobs: </b></th>
          {% for scout_metric, pandaids in jobscoutids.items %}
            <td><b>{{ scout_metric }}:</b>
              {% for job in pandaids %}
                <a href="{% url 'jobInfo' %}?pandaid={{ job }}">{{ job }}</a>{% if forloop.last %}{% else %}, {% endif %}
              {% endfor %}
            </td>
          {% endfor %}
        </tr>
      </tbody>
    </table>
    </div>
  {% endif %}

  {% if warning.memoryleaksuspicion %}
    <p></p>
    <div class="callout warning" data-closable>
      <h5>Warning! {{ warning.memoryleaksuspicion.message }}</h5>
      <p>At least one of jobs in this task consumed more max PSS/core than it is limited by a computing site. Please check the next top memory consumed jobs and their memory and IO usage plots: </p>
      <ul>
      {% for job in warning.memoryleaksuspicion.jobs %}
        <li style="font-size: smaller"> <a class="blacklink bold hover" href="{% url 'jobInfo' job.pandaid %}">{{ job.pandaid }}</a> job consumed {{ job.jobmaxpss_percore }} MB per core out of {{ job.sitemaxrss_percore }} MB per core limited by <a class="blacklink bold hover" href="{% url 'siteInfo' job.computingsite %}">{{ job.computingsite }}</a>, see <a class="blacklink bold hover" target="_blank" href="{% url 'prMonPlots' job.pandaid %}">plots</a>
      {% endfor %}
      </ul>
      <p>You may want to use a <a class="blacklink bold hover" href="https://atlassoftwaredocs.web.cern.ch/athena/performance/valgrind/">Valgrind</a> tool to identify and investigate memory leaks in your code.
      Also you can debug jobs locally: click on one of PanDA IDs in the list above, then "Go to" &rarr; "Script to re-create job for offline debugging"</p>
      <button class="close-button small" aria-label="Dismiss alert" type="button" data-close>
            <span aria-hidden="true">&times;</span>
      </button>
    </div>
  {% endif %}

  <div id="taskflow" ng-app="taskInfoAppSL" ng-controller="taskflowController">
    <div class="card bp-container-simple secondary ng-hide" ng-hide="taskflow.is_hidden">
    <div class="card-divider"><p>Task Flow Diagram</p></div>
    <div class="card-section">
      <p ng-bind-html="taskflow.message"></p>
      <div id="sankey_basic" style="width: 100%; height: 700px;"></div>
    </div>
  </div>
  </div>

  <div id="statuslog" ng-app="taskInfoAppSL" ng-controller="TaskStatusLogController">
    <div class="card bp-container-simple secondary ng-hide" ng-hide="status_log.is_hidden">
    <div class="card-divider"><p>Task status history</p></div>
    <div class="card-section">
      <p ng-bind-html="status_log.message"></p>
      <div class="c3-chart-block" id="tsl_plot"></div>
      <table class="data-table left-aligned nowrap" id="taskstatuslogtable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
    </div>
  </div>
   {% if viewParams.MON_VO == 'ATLAS' %}
  <div id="tasklogs" ng-app="taskInfoAppSL" ng-controller="TaskLogsController">
    <div class="card bp-container-simple secondary ng-hide" ng-hide="task_logs.is_hidden">
    <div class="card-divider"><p>Task logs for {{ jeditaskid|safe }} from <a href="https://os-atlas.cern.ch/dashboards/app/data-explorer/discover/#?_a=(discover:(columns:!(logName,logLevel,message,_source),interval:auto,sort:!(!('@timestamp',desc))),metadata:(indexPattern:'6bf79810-bfac-11ea-b7f2-27bdf2c0b5dc',view:discover))&_q=(query:(language:kuery,query:'jediTaskID: {{ jeditaskid|safe }}'))&_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-60d,to:now))" target="_blank">os-atlas</a></p></div>
    <div class="card-section">
      <table class="data-table left-aligned nowrap" id="tasklogstable">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  </div>
    {% endif %}
  <div id="plots" data-ng-controller="jobConsumptionPlotsController">
  <div class="card bp-container-simple secondary ng-hide" ng-hide="taskinfo.jc_plots.selection.is_hidden">
    <div class="card-divider"><p>Job consumption plots:</p></div>
    <div class="card-section">

      <fieldset class="inline">
        <legend>Job category:</legend>
        <label ng-repeat="option in taskinfo.jc_plots.options.category"><input type="radio" ng-value="option" ng-model="taskinfo.jc_plots.selection.category" ng-change="taskinfo.jc_plots.rebuild()">{$ option $}</label>
      </fieldset>

      <div class="c3-chart-block" ng-repeat="plot in taskinfo.jc_plots.plot_data" jcplot-directive plot="plot" parent="$parent"></div>
    </div>
  </div>
  </div>

  <div id="datamovement" ng-app="taskInfoAppDM" ng-controller="TaskDataMovementController">
  <div class="callout info ng-hide" ng-hide="datamovement.container.is_hidden">
    <h6>Data Movement Summary: </h6>
    <div ng-bind-html="datamovement.message"></div>
    <p class="ng-hide" ng-hide="datamovement.content.is_hidden">
      In total, <span class="bold" ng-bind="datamovement.data.n"></span> times
      <span class="bold" ng-bind="datamovement.data.nfiles"></span> unique files have been moved by PanDA for
      <span class="bold" ng-bind="datamovement.data.njobs"></span> jobs in this tasks,
      the total volume is <span class="bold" ng-bind="datamovement.data.fsize_sum"></span> GB.
    </p>
  </div>
  </div>


  {% if inctrs or outctrs %}
    <table class="fresh-table unstriped slim">
    <thead>
      <tr><th colspan=20>Containers</th></tr>
    </thead>
    <tbody>
      {% if inctrs %}
        <tr><th>Input:</th><th>Progress, %</th><th>N files | <span class="finished">finished</span> | <span class="failed">failed</span></th></tr>
        {% for dsrec in inctrs %}
          <tr>
            <td class="wrap-words"><a href="{% url 'datasetList' %}?containername={% if dsrec.containername %}{{ dsrec.containername }}{% else %}{{ dsrec }}{% endif %}">{% if dsrec.containername %}{{ dsrec.containername }}{% else %}{{ dsrec }}{% endif %}</a></td>
            <td>{{ dsrec.pct }}%</td>
            <td>{{ dsrec.nfiles }}{% if dsrec.nfilesmissing > 0 %} <span class="lost"> +{{ dsrec.nfilesmissing }} lost</span>{% endif %} | <span class="finished">{{ dsrec.nfilesfinished }}</span> | <span class="failed">{{ dsrec.nfilesfailed }}</span> </td>
          </tr>
        {% endfor %}
      {% endif %}
      {% if outctrs %}
        <tr><th colspan="3">Output:</th></tr>
        {% for dsrec in outctrs %}
          <tr>
              <td colspan="3" class="wrap-words"><a href="{% url 'datasetList' %}?containername={{ dsrec }}">{{ dsrec }}</a></td>
          </tr>
        {% endfor %}
      {% endif %}
    </tbody>
    </table>
  {% endif %}

  {% if datasets %}
    <div class="card bp-container-simple secondary" id="container_dst">
    <div class="card-divider"><p>Dataset processing information:</p></div>
    <div class="card-section">
      <table class="data-table left-aligned nowrap" id="datasetstable">
          <thead>
          <tr>
              <th>Dataset, container name</th>
              <th>Type</th>
              <th>Stream</th>
              <th>Status</th>
              <th>Nfiles</th>
              <th>Nfiles finished</th>
              <th>Nfiles failed</th>
              <th>%</th>
              <th>Links</th>
              <th>RSE</th>
          </tr>
          </thead>
          <tbody></tbody>
      </table>
    </div>
    </div>
  {% else %}
      <p>No datasets were found for this task</p>
  {% endif %}
      <div id="dsStageDiv" class="table-scroll" ng-app="taskInfoAppAJS" ng-controller="StagingDSController" style="display:none;">
          <div class="card bp-container-simple secondary" id="container_dst">
          <div class="card-divider"><p>Staging information</p></div>
          <div class="card-section">
          <span id="datasetCount" data-count="{$ datasets.length $}" style="display:none;"></span>
          <table id="dsTable" class="data-table left-aligned nowrap">
          <thead>
            <tr>
              <th colspan="11">
                <span ng-if="datasets.length === 1">
                  {% if request.session.rucio_ui|length > 0 %}
                    for <a href="{{ request.session.rucio_ui }}did?scope={$ datasets[0].scope $}&name={$ datasets[0].dataset $}">
                      {$ datasets[0].dataset $}
                    </a>
                    <a target="_blank" href="/staginprogressplot/?jeditaskid={{ jeditaskid|safe }}">
                      <i class="fi-graph-trend"></i>
                    </a>
                  {% else %}
                    {$ datasets[0].dataset $}
                  {% endif %}
                </span>
              </th>
            </tr>
            <tr>
              <th>Rucio rule</th>
              <th>Source</th>
              <th>Destination</th>
              <th class="mid">Status</th>
              <th class="num">Files <br> (staged | total | %)</th>
              <th class="mid">iDDS request status</th>
              <th class="num">iDDS files <br> (processed | total | %)</th>
              <th>Started</th>
              <th>Since last update [d:h:m:s]</th>
              <th>Dataset</th>
              <th class="mid">Errors</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="dataset in datasets">
              <td class="icons1">
                <span ng-if="dataset.rse && '{{ request.session.rucio_ui|escapejs }}'.length > 0">
                  <a ng-href="{{ request.session.rucio_ui }}rule?rule_id={$ dataset.rse $}">
                    {$ dataset.rrule_cut $} <img src="/static/images/rucio-logo.png" width="14" height="14" border="0">
                  </a>
                </span>
                <span ng-if="!dataset.rse || '{{ request.session.rucio_ui|escapejs }}'.length == 0">
                  {$ dataset.rrule_cut $}
                </span>
              </td>
              <td>{$ dataset.source_rse $}</td>
              <td>{$ dataset.destination_rse $}</td>
              <td class="{$ dataset.status $}_fill">
                    {$ dataset.status $}
              </td>
              <td class="num">
                {$ dataset.staged_files $} | {$ dataset.total_files $}  | {$ dataset.staged_files_pct $}%
              </td>
              <td class="{$ dataset.idds_status.toLowerCase() $}_fill">
                <a href="/idds/?reqid={$ dataset.idds_request_id $}">
                  {$ dataset.idds_status $}
                </a>
              </td>
              <td class="num">
                {$ dataset.idds_out_processed_files $} | {$ dataset.idds_out_total_files $} | {$ dataset.idds_pctprocessed $}%
              </td>
              <td>{$ dataset.start_time $}</td>
              <td>{$ dataset.update_time $}</td>
              <td>
                <a ng-href="{{ request.session.rucio_ui }}did?name={$ dataset.scope $}:{$ dataset.dataset $}">
                  {$ dataset.dataset $}
                </a>
              </td>
               <td>
                  <a target="_blank" href="https://monit-grafana.cern.ch/d/e77b84d4-d854-4a18-b2c6-5fb67f648832/ddm-transfers-errors?from={$ dataset.start_time_ms $}&orgId=17&to=now&var-bin=1h&var-dataset_name={$ dataset.dataset.split(':')[1] $}&var-dst_cloud=All&var-dst_country=All&var-dst_federation=All&var-dst_site=All&var-dst_tier=All&var-error_filter=&var-src_cloud=All&var-src_country=All&var-src_federation=All&var-src_site=All&var-src_tier=All&var-activity=Analysis%20Input&var-activity=Production%20Input&var-activity=Staging">
                    <img src="{% static 'images/grafana.png' %}" width=14 height=14 border=0>
                  </a>
              </td>
            </tr>
          </tbody>
        </table>
        </div>
       </div>
      </div>

    {% if task.idds_info and not task.dc_info == "dc" %}
        <div id="iDDsDiv" class="table-scroll" ng-app="iDDsInfoAppAJS" ng-controller="iDDSInfoForTaskController" style="display:none;">
            <table class="fresh-table">
                <thead>
                    <tr>
                        <th colspan="20">iDDS information</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th ng-repeat="(key, value) in iddsjson[0]" ng-if="key!='staged_files' && key!='total_files' && key!='taskid'">{$ key $}</th>
                    </tr>
                    <tr ng-repeat="item in iddsjson">
                        <td ng-repeat="(key, value) in item" ng-if="key!='staged_files' && key!='total_files' && key!='taskid'">{$ value $}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    {% endif %}
  {% if jobparams %}
    <a name="jobparams"></a>
    <table class="fresh-table">
      <thead>
        <tr><th colspan=20> Job parameters</th></tr>
      </thead>
      <tbody>
        {% for p in jobparams %}
            <tr>
              <td><div class="comment more wrap-words">{{ p|safe }}</div></td>
            </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
  
  {% if taskparams %}
    <a name="taskparamsprodsys"></a>
    <table class="fresh-table">
      <thead>
        <tr><th colspan=20> Prodsys task parameters</th></tr>
      </thead>
      <tbody>
        {% for p in taskparams %}
          {% if p.name != 'jobParameters' and p.name != 'log' %}
            <tr>
              <td class="bold">{{ p.name }}</td>
              <td>
                <div class="comment more wrap-words">
                  {% if not p.value is None and not p.value == '' %} {{ p.value }} {% else %}&mdash;{% endif %}
                </div>
              </td>
            </tr>
          {% endif %}
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <a name="taskparamsjedi"></a>
  <table  class="fresh-table">
    <thead>
      <tr>
          <th colspan=20> PanDA/JEDI task parameters</th>
      </tr>
    </thead>
    <tbody>
      {% for col in columns %}
          <tr>
              <td class="bold">{{ col.name }}</td>
              <td class="wrap-words">
                {% if not col.value is None and not col.value == '' %}
                  {% if col.name == 'cputimescoutjob' %}
                    <a href="{% url 'jobInfo' %}?pandaid={{ col.value }}">{{ col.value }}</a>
                  {% else %}
                    {{ col.value }}
                  {% endif %}
                {% else %} &mdash;
                {% endif %}
              </td>
          </tr>
      {% endfor %}
    </tbody>
  </table>

{% else %}

  <p>PanDA task {% if jeditaskid > 0 %}{{ jeditaskid }}{% endif %} {% if task.taskname %}:<b>{{ task.taskname }}</b> not found.{% endif %}</p>
  {% if viewParams.MON_VO == 'ATLAS' %}
    <p>You can however get a job listing for any task in quick search.</p>
  {% endif %}

{% endif %}

{% endblock %}

{% block js_body_page %}
<script src="{% static 'js/draw-plots-c3.js' %}?{% cache_bust "js/draw-plots-c3.js" %}"></script>
<script src="{% static 'js/google-charts-loader.js' %}?{% cache_bust "js/google-charts-loader.js" %}"></script>
<script nonce={{request.csp_nonce}}>
var MON_VO = '{{ viewParams.MON_VO|safe }}';
var jeditaskid = {{ jeditaskid | safe }};
google.charts.load('current', {'packages':['sankey']});

document.getElementById("button-taskflow").addEventListener("click", toggletaskflow);
document.getElementById("button-task-status-log").addEventListener("click", toggleStatusLog);
if (document.getElementById("button-task-data-movement")) {document.getElementById("button-task-data-movement").addEventListener("click", toggleTaskDataMovement);}
if (document.getElementById("button-task-logs")) {document.getElementById("button-task-logs").addEventListener("click", toggleTaskLogs);}
document.getElementById("button-task-plots").addEventListener("click", togglePlots);

if (document.getElementById("button-task-action-finish-panda")) {document.getElementById("button-task-action-finish-panda").addEventListener("click", operationtask_token.bind(null, jeditaskid, 'finishtask'));}
if (document.getElementById("button-task-action-abort-panda")) {document.getElementById("button-task-action-abort-panda").addEventListener("click", operationtask_token.bind(null, jeditaskid, 'killtask' ));}

const task_age = {{ task.age|safe }};
const task_rating = {{ task.rating|safe }};
const task_rating_feedback_messages = {% if 'rating_feedback' in task %} {{ task.rating_feedback|safe }} {% else %} "" {% endif %};

app.controller('taskInfoController', function($rootScope, $scope, $http) {
  $scope.idds = {
    loading: true,
  }
  $rootScope.$on('idds_info', function(event, data) {
      $scope.idds.json = data;
      $scope.idds.loading = false;
  });
  $scope.rating = {
    is_allowed: (task_age <= 90),
    total: (task_rating > 0 && task_rating <= 5) ? task_rating : 0,
    new: -1,
    feedback: '',
    is_shown_feedback_modal: false,
    emoji_desc: {
      1: '\u{1F621}',
      2: '\u{1F620}',
      3: '\u{1F610}',
      4: '\u{1F600}',
      5: '\u{1F60D}'
    },
    modal_alert: '',
    submit_button_text: 'Submit',
    submitting: false,
    is_shown_modal_alert: false,
    is_shown_feedback_messages: false,
    feedback_list: (task_rating_feedback_messages.constructor === Array) ? task_rating_feedback_messages : [],
  }
  $scope.rating.pick_emoji = function(rating) {
    return $scope.rating.emoji_desc[Math.ceil(rating)];
  }
  
  $scope.rating.emojiButtonClick = function(rating) {
      // Get the emoji and text content
      $scope.rating.new = rating;
      // Open User Feedback
      $scope.rating.is_shown_feedback_modal = true;
  }
  
  // Function to close the modal
  $scope.rating.closeFeedbackModal = function() {
      $scope.rating.is_shown_feedback_modal = false;
      $scope.rating.is_shown_modal_alert = false;
      $scope.rating.modal_alert = '';
  }

  // Function to check and validate feedback message
  $scope.rating.validateFeedbackMessage = function () {
    console.log($scope.rating.new);
    if ($scope.rating.new < 3 && !$scope.rating.isValidFeedbackMessage()) {
          $scope.rating.is_shown_modal_alert = true;
          $scope.rating.modal_alert = 'Please write at least a few words...';
    } else {
        $scope.rating.is_shown_modal_alert = false;
        $scope.rating.modal_alert = '';
    }
  };

  $scope.rating.isValidFeedbackMessage = function () {
    return $scope.rating.feedback.length > 10 || $scope.rating.feedback.split(/\s+/).length >= 2;
  };

  // Function to handle feedback submission
  $scope.rating.submitFeedback = function () {
    if ($scope.rating.new < 3 && !$scope.rating.isValidFeedbackMessage()) {
        this.modal_alert = 'Feedback is required for low ratings (at least a few words).';
        this.is_shown_modal_alert = true;
        return;
    }
    $scope.rating.submit_button_text = 'Submitting...';
    $scope.rating.submitting = true;
    $http({
        url: '{% url 'rating_func' %}?json',
        method: "POST",
        data: {
          'task': jeditaskid, 
          'rating': $scope.rating.new, 
          'feedback': $scope.rating.feedback}}
    ).then(function success(response) {
        let res_data = angular.fromJson(response.data);
        if (('data' in res_data) && ('rating_average' in res_data.data)) {
            $scope.rating.total = res_data.data.rating_average;
            $scope.rating.feedback_list = res_data.data.rating_data;
        }
        // Close the modal after submitting feedback
        $scope.rating.submitting = false;
        $scope.rating.submit_button_text = 'Submit';
        $scope.rating.is_shown_feedback_modal = false;
    }, function error(response) {
        $scope.rating.modal_alert = "Your rating & feedback submission failed";
        if (('data' in response) && ('error' in response.data)) {
            $scope.rating.modal_alert += " with the following error: " + response.data.error;
        }
        $scope.rating.is_shown_modal_alert = true;
        $scope.rating.submitting = false;
        $scope.rating.submit_button_text = 'Submit';
    });
  }  
});
app.controller('iDDSInfoForTaskController', function ($scope, $http, $rootScope) {
    $scope.iddsjson = [];

    $scope.getiDDs = function () {
        $http({
            url: '/idds/getiddsfortask/',
            method: "GET",
            params: {'jeditaskid': {{ jeditaskid|safe }}}
        }).then(function (res) {
            var iddsjson = angular.fromJson(res.data);
            if (iddsjson && 'data' in iddsjson && iddsjson['data'].length > 0) {
                $scope.iddsjson = iddsjson['data'];
                $rootScope.$emit('idds_info', $scope.iddsjson);
                $('#iDDsDiv').show();
            }
        });
    };

    var init = function () {
        $scope.getiDDs();
    };
    init();
});

app.controller('StagingDSController', function ($scope, $http) {
  $scope.datasets = [];
  $scope.MON_VO = MON_VO;

  $scope.getStagingDS = function () {
    $http({
      url: '/api/dc/staginginfofortask/',
      method: "GET",
      params: { 'jeditaskid': jeditaskid }
    }).then(function (res) {
      if (Array.isArray(res.data)) {
        $scope.datasets = res.data;
      } else {
        $scope.datasets = [res.data];
      }

      if ($scope.datasets.length > 0) {
        $scope.datasets.forEach(function (dataset) {
          if ('rse' in dataset && dataset.rse != null) {
            dataset.rrule_cut = dataset.rse.slice(0, 3) + '...' + dataset.rse.slice(-3);
          } else {
            dataset.rrule_cut = '';
          }
        });

        var displaydiv = document.getElementById('dsStageDiv');
        if (displaydiv) {
          displaydiv.style.display = "";
        }
      }
    });
  };

  var init = function () {
    $scope.getStagingDS();
  };

  if (MON_VO === 'ATLAS') {
    init();
  }
});

var jc_plot_data = {{ plotsDict|safe }};
app.controller('jobConsumptionPlotsController', function($scope) {
  $scope.taskinfo = {};
  $scope.taskinfo.jc_plots = {
    selection: {
      category: '',
      is_hidden: true,
      mode: ''
    },
    options: {
      category: []
    },
    plot_data: {},
    charts: {}
  };

  $scope.taskinfo.jc_plots.fill = function () {
    $scope.taskinfo.jc_plots.plot_data = jc_plot_data;
    if (Object.keys($scope.taskinfo.jc_plots.plot_data).length > 1) {
      Object.keys($scope.taskinfo.jc_plots.plot_data[1].data.data).forEach((key) => {
        $scope.taskinfo.jc_plots.options.category.push(key);
      });
      $scope.taskinfo.jc_plots.options.category.sort();
      if ($scope.taskinfo.jc_plots.options.category.includes('run')) {
        $scope.taskinfo.jc_plots.selection.category = 'run';
      }
      else {
        $scope.taskinfo.jc_plots.selection.category = 'all';
      }
    }
  };

  $scope.taskinfo.jc_plots.build = function () {
    $scope.taskinfo.jc_plots.plot_data.forEach((item) => {
      if (item.data.details.type === 'pie') {
        $scope.taskinfo.jc_plots.charts[item.name + "_chart"] = draw_donut(item.data.data[$scope.taskinfo.jc_plots.selection.category]['columns'], item.name + "_chart", item.data.details.title, item.data.details)
      }
      else if (item.data.details.type === 'stack_bar') {
        $scope.taskinfo.jc_plots.charts[item.name + "_chart"] = draw_stacked_bar_hist(item.data.data[$scope.taskinfo.jc_plots.selection.category], item.data.details, item.name + "_chart");
      }
    })
  };

  $scope.taskinfo.jc_plots.rebuild = function () {
    $scope.taskinfo.jc_plots.destroy();
    $scope.taskinfo.jc_plots.build();
  };

  $scope.taskinfo.jc_plots.destroy = function () {
    let plot_names = Object.keys($scope.taskinfo.jc_plots.charts);
    plot_names.forEach((item) => {
      if ($scope.taskinfo.jc_plots.charts[item]) {
        $scope.taskinfo.jc_plots.charts[item] = $scope.taskinfo.jc_plots.charts[item].destroy();
      }
    });
  };

  $scope.taskinfo.jc_plots.toggle = function () {

    if (Object.keys($scope.taskinfo.jc_plots.plot_data).length === 0) $scope.taskinfo.jc_plots.fill();

    if ($scope.taskinfo.jc_plots.options.category.length > 0) {
      ($scope.taskinfo.jc_plots.selection.is_hidden) ? $scope.taskinfo.jc_plots.selection.is_hidden = false : $scope.taskinfo.jc_plots.selection.is_hidden = true;
    }
  };

})
.directive('jcplotDirective', function ($timeout) {
    var template = '<div id="{$plot.name$}_chart"></div>';
    return {
        template: template,
        scope: {
            plot: '=',
            parent: '=',
        },
        link: function (scope, element, attrs) {
          $timeout(() => {
            element.ready(() => {
              if (scope.plot.data.details.type === 'pie') {
                if ('size' in scope.plot.data.details) {scope.plot.data.details.size[0] = getWidth();}
                scope.parent.taskinfo.jc_plots.charts[scope.plot.name + "_chart"] = draw_donut(scope.plot.data.data[scope.parent.taskinfo.jc_plots.selection.category]['columns'], scope.plot.name + "_chart", scope.plot.data.details.title, scope.plot.data.details)
              }
              else if (scope.plot.data.details.type === 'stack_bar') {
                scope.parent.taskinfo.jc_plots.charts[scope.plot.name + "_chart"] = draw_stacked_bar_hist(scope.plot.data.data[scope.parent.taskinfo.jc_plots.selection.category], scope.plot.data.details, scope.plot.name + "_chart");
              }
            });
          });
        }
    };
});
  
app.controller('taskflowController', function ($scope, $http, $sce) {
    $scope.taskflow = {
      message: $sce.trustAsHtml('<img src="{% static 'images/load.gif' %}"> Loading... '),
      data: [],
      is_hidden: true,
      plot_data: {
        columns: [],
      },
      plot: "",
    };
    $scope.taskflow.get = function () {
        $http({
                url: "{% url 'taskFlowDiagram' jeditaskid %}",
                method: "GET",
                params: {'json':1}
            }
        ).then(function success(response) {
            $scope.taskflow.message = "";
            $scope.taskflow.data = angular.fromJson(response.data.data);
            if ($scope.taskflow.data.length > 0) {
              $scope.taskflow.buildPlot();
            }
            else {
              $scope.taskflow.message = $sce.trustAsHtml("No data received :(");
            }
          },
          function error(response) {
            console.log(response);
            $scope.taskflow.message = $sce.trustAsHtml('Failed to load data :( ');
          }
        );
    };

    $scope.taskflow.buildPlot = function() {
        var data = new google.visualization.DataTable();
            data.addColumn('string', 'From');
            data.addColumn('string', 'To');
            data.addColumn('number', 'Weight');
            data.addRows($scope.taskflow.data);

    // Sets chart options.
    var options = {
        width: getWidth()-40,
        {#sankey: {#}
        {#    link: { color: { fill: '#d799ae' } },#}
        {#    node: { colors: [ '#a61d4c' ]},#}
        {# },#}
    };

    // Instantiates and draws our chart, passing in some options.
    var chart = new google.visualization.Sankey(document.getElementById('sankey_basic'));
    chart.draw(data, options);

    };
    $scope.taskflow.toggle = function() {
        $scope.taskflow.is_hidden = false;
        $scope.taskflow.get();
    };
});

app.controller('TaskStatusLogController', function ($scope, $http, $sce) {
    $scope.status_log = {
      message: $sce.trustAsHtml('<img src="{% static 'images/load.gif' %}"> Loading... '),
      data: [],
      is_hidden: true,
      data_table: "",
      plot_data: {
        columns: [],
        ext: {
          xs: {},
          size: [getWidth() - 40, 400],
          colors: "task_states",
          labels: ['Time', 'Task attempt'],
        },
      },
      plot: "",
    };
    $scope.status_log.get = function () {
        $http({
              url: "{% url 'gettaskstatuslog' jeditaskid %}",
              method: "GET",
              params: {'json':1}
            }
        ).then(function success(response) {
            $scope.status_log.message = "";
            $scope.status_log.data = angular.fromJson(response.data);
            if ($scope.status_log.data.length > 0) {
              $scope.status_log.buildPlot();
              $scope.status_log.buildDataTable();
            }
            else {
              $scope.status_log.message = $sce.trustAsHtml("No data received :(");
            }
          },
          function error(response) {
            console.log(response);
            $scope.status_log.message = $sce.trustAsHtml('Failed to load data :( ');
          }
        );
    };
    $scope.status_log.buildDataTable = function () {
        $scope.status_log.data_table = $('#taskstatuslogtable').dataTable({
            "lengthMenu": [[10, 20, 50, 100, 200, -1], [10, 20, 50, 100, 200, "All"]],
            "paging": true,
            "scrollX": true,
            "aaSorting": [[1,'asc']],
            "data": $scope.status_log.data,
            "aoColumns": [
                {
                    title: "Attempt",
                    data: "attemptnr",
                    sDefaultContent: "-",
                },
                {
                    title: "Time",
                    data: "modiftime_str",
                    sDefaultContent: "-",
                },
                {
                    title: "Status",
                    data: "status",
                    sDefaultContent: "-",
                    className: 'state',
                },
                {
                    title: "Duration, d:h:m:s",
                    data: "duration",
                    sDefaultContent: "-",
                },
                {
                    title: "Modification host",
                    data: "modificationhost",
                    sDefaultContent: "-",
                },
                {
                    title: "Reason",
                    data: "reason",
                    sDefaultContent: "-",
                },
            ],
            "createdRow": function ( row, data, index ) {
                $('td', row).eq(2).addClass(data['status'] + '_fill');
            }
          })
    };
    $scope.status_log.buildPlot = function() {
        if ($scope.status_log.data.length > 0) {
            let tmp_obj = {};
            $scope.status_log.plot_data.columns.push(['x', ]);
            $scope.status_log.data.forEach((item) => {
                tmp_obj[item.status] = [item.status, ];
                $scope.status_log.plot_data.columns[0].push(item.modiftime_str);
            });
            $scope.status_log.data.forEach((item) => {
              Object.keys(tmp_obj).forEach((key) => {
                (item.status === key) ? tmp_obj[key].push(item.attemptnr+1) : tmp_obj[key].push(0);
              });
            });
            Object.keys(tmp_obj).forEach((key) => {
              $scope.status_log.plot_data.columns.push([key, ...tmp_obj[key]]);
            })
        }
        $scope.status_log.plot = draw_steps($scope.status_log.plot_data.columns, 'tsl_plot', 'Task statuses transition', $scope.status_log.plot_data.ext);
    };
    $scope.status_log.toggle = function() {
        $scope.status_log.is_hidden = false;
        $scope.status_log.get();
    };
});

app.controller('TaskLogsController', function ($scope, $http, $sce) {
   $scope.task_logs = {
      message: $sce.trustAsHtml('<img src="{% static 'images/load.gif' %}"> Loading... '),
      data: [],
      is_hidden: true,
      data_table: "",
      plot_data: {
        columns: [],
        ext: {
          xs: {},
          size: [getWidth() - 40, 400],
          colors: "task_states",
          labels: ['Time', 'Task attempt'],
        },
      },
      plot: "",
    };
   $scope.task_logs.get = function () {
        $http({
                url: "{% url 'gettasklogs' jeditaskid %}",
                method: "GET",
                params: {'json':1}
            }
        ).then(function success(response) {
            $scope.task_logs.message = "";
            $scope.task_logs.data = angular.fromJson(response.data);
            if ($scope.task_logs.data.length > 0) {
              $scope.task_logs.buildDataTable();
            }
            else {
              $scope.task_logs.message = $sce.trustAsHtml("No data received :(");
            }
          },
          function error(response) {
            console.log(response);
            $scope.task_logs.message = $sce.trustAsHtml('Failed to load data :( ');
          }
        );
   };
   $scope.task_logs.buildDataTable = function () {
        $scope.task_logs.data_table = $('#tasklogstable').dataTable({
            "lengthMenu": [[10, 20, 50, 100, 200, -1], [10, 20, 50, 100, 200, "All"]],
            "paging": true,
            "scrollX": true,
            "aaSorting": [[1,'asc']],
            "data": $scope.task_logs.data,
            {#rowsGroup: [0],#}
            "aoColumns": [
                {
                    title: "LogName",
                    data: "logname",
                    sDefaultContent: "-",
                    "render": function (data, type, full, meta) {
                        var link_to_kibana = ''
                        if (full['logname']  == 'recoverlostfiles') {
                            link_to_kibana = '<a href="https://os-atlas.cern.ch/dashboards/app/data-explorer/discover/#?_a=(discover:(columns:!(logName,logLevel,message,_source),interval:auto,sort:!(!(\'@timestamp\',desc))),metadata:(indexPattern:\'620eaaf0-bfac-11ea-b7f2-27bdf2c0b5dc\',view:discover))&_q=(query:(language:lucene,query:\'jediTaskID:' + full['jediTaskID'] + '%20AND%20fields.type:%22' + full['logname'] + '%22\'))&_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-60d,to:now))" target="_blank">' + full['logname'] + ' (panda log)' + '</a>'
                        }
                        else {
                            link_to_kibana = '<a href="https://os-atlas.cern.ch/dashboards/app/data-explorer/discover/#?_a=(discover:(columns:!(logName,logLevel,message,_source),interval:auto,sort:!(!(\'@timestamp\',desc))),metadata:(indexPattern:\'6bf79810-bfac-11ea-b7f2-27bdf2c0b5dc\',view:discover))&_q=(query:(language:lucene,query:\'jediTaskID:' + full['jediTaskID'] + '%20AND%20fields.type:%22' + full['logname'] + '%22\'))&_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-60d,to:now))" target="_blank">' + full['logname'] + '</a>'
                        }
                        return link_to_kibana
                    }
                },
                {
                    title: "LogLevel",
                    data: "loglevel",
                    sDefaultContent: "-",
                    "render": function (data, type, full, meta) {
                        var link_to_kibana = ''
                        if (full['logname']  == 'recoverlostfiles') {
                            link_to_kibana = '<a href="https://os-atlas.cern.ch/dashboards/app/data-explorer/discover/#?_a=(discover:(columns:!(logName,logLevel,message,_source),interval:auto,sort:!(!(\'@timestamp\',desc))),metadata:(indexPattern:\'620eaaf0-bfac-11ea-b7f2-27bdf2c0b5dc\',view:discover))&_q=(query:(language:lucene,query:\'jediTaskID:' + full['jediTaskID'] + '%20AND%20fields.type:%22' + full['logname'] + '%22%20AND%20logLevel:%22' + full['loglevel'] + '%22\'))&_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-60d,to:now))" target="_blank">' + full['loglevel'] + ' (panda log)' + '</a>'
                       }
                        else {
                            link_to_kibana = '<a href="https://os-atlas.cern.ch/dashboards/app/data-explorer/discover/#?_a=(discover:(columns:!(logName,logLevel,message,_source),interval:auto,sort:!(!(\'@timestamp\',desc))),metadata:(indexPattern:\'6bf79810-bfac-11ea-b7f2-27bdf2c0b5dc\',view:discover))&_q=(query:(language:lucene,query:\'jediTaskID:' + full['jediTaskID'] + '%20AND%20fields.type:%22' + full['logname'] + '%22%20AND%20logLevel:%22' + full['loglevel'] + '%22\'))&_g=(filters:!(),refreshInterval:(pause:!t,value:0),time:(from:now-60d,to:now))" target="_blank">' + full['loglevel'] + '</a>'
                        }
                        return link_to_kibana
                    }
                },
                {
                    title: "#",
                    data: "lcount",
                    sDefaultContent: "-",

                }

            ],
            "createdRow": function ( row, data, index ) {
                $('td', row).eq(2).addClass(data['status'] + '_fill');
            }
          })
    };
   $scope.task_logs.toggle = function() {
        $scope.task_logs.is_hidden = false;
        $scope.task_logs.get();
    };
});

app.controller('TaskDataMovementController', function ($scope, $http, $sce) {
   $scope.datamovement = {
      message: $sce.trustAsHtml('<img src="{% static 'images/load.gif' %}"> Loading... '),
      data: {},
      container: {
        is_hidden: true,
      },
      content: {
        is_hidden: true,
      }
    };
   $scope.datamovement.get = function () {
        $http({
                url: "{% url 'taskdatamovement' jeditaskid %}",
                method: "GET",
                params: {'json':1}
            }
        ).then(function success(response) {
            $scope.datamovement.data = angular.fromJson(response.data);
            if (Object.keys($scope.datamovement.data).length > 0) {
              $scope.datamovement.message = $sce.trustAsHtml("");
              $scope.datamovement.content.is_hidden = false;
            }
            else {
              $scope.datamovement.message = $sce.trustAsHtml("<p>No data was moved in this task by PanDA");
            }
          },
          function error(response) {
            console.log(response);
            $scope.datamovement.message = $sce.trustAsHtml('<p>Failed to load data :( </p>');
          }
        );
   };

   $scope.datamovement.toggle = function() {
      $scope.datamovement.container.is_hidden = false;
      $scope.datamovement.get();
   };
});

$(document).ready(function () {
    $(".comment").shorten({showChars: getNCharsShorten(), minHideChars: 250});
    var dataset_list = {{ datasets|safe }};
    buildDatasetsTable(dataset_list);
    var url = window.location.href;
    if (url.indexOf("#plots") > -1) {
        togglePlots();
    }
    if (url.indexOf("#statuslog") > -1) {
        toggleStatusLog();
    }
    if (url.indexOf("#tasklogs") > -1) {
        toggleTaskLogs();
    }
    if (url.indexOf("#datamovement") > -1) {
      toggleTaskDataMovement();
    }
    var checkExist = setInterval(function () {
        if ($('#dsTable tbody tr').length > 0) {
            clearInterval(checkExist);
            var datasetCount = parseInt($('#datasetCount').attr('data-count')) || 0;

            var table = $('#dsTable').DataTable({
                paging: true,
                searching: true,
                ordering: true,
                info: true,
                scrollX: true,
                lengthMenu:  [[10, 20, 50, 100, 200, -1], [10, 20, 50, 100, 200, "All"]],
                columns: [
                    { data: 'rrule_cut' },
                    { data: 'source_rse' },
                    { data: 'destination_rse' },
                    { data: 'status' },
                    { data: 'staged_files' },
                    { data: 'idds_status' },
                    { data: 'idds_out_processed_files' },
                    { data: 'start_time' },
                    { data: 'update_time' },
                    { data: 'dataset' },
                    { data: 'errors_link' }
                ],
                columnDefs: [
                    {
                        targets: [3, 5, 10],
                        createdCell: function (td, cellData, rowData, row, col) {
                            $(td).css('text-align', 'center');
                        }
                    },
                    {
                        targets: 10,
                        orderable: false,
                        searchable: false
                    }
                ]
            });
            if (datasetCount === 1) {
                table.column(9).visible(false);
            } else {
                table.column(9).visible(true);
            }
            $(table.column(10).header()).css('text-align', 'center');
            $(table.column(3).header()).css('text-align', 'center');
            $(table.column(5).header()).css('text-align', 'center');
        }
    }, 500);
});

function togglePlots() {
  let scope = angular.element(document.getElementById('plots')).scope();
  scope.$apply(function() {
      scope.taskinfo.jc_plots.toggle();
  });
}
function toggletaskflow() {
    let scope = angular.element(document.getElementById('taskflow')).scope();
    if (scope.taskflow.is_hidden) {
      scope.$apply(function () {
        scope.taskflow.toggle();
      });
    }
}

function toggleStatusLog() {
    let scope = angular.element(document.getElementById('statuslog')).scope();
    if (scope.status_log.is_hidden) {
      scope.$apply(function () {
        scope.status_log.toggle();
      });
    }
}

function toggleTaskLogs() {
    let scope = angular.element(document.getElementById('tasklogs')).scope();
    if (scope.task_logs.is_hidden) {
      scope.$apply(function () {
        scope.task_logs.toggle();
      });
    }
}

function toggleTaskDataMovement() {
    let scope = angular.element(document.getElementById('datamovement')).scope();
    if (scope.datamovement.container.is_hidden) {
      scope.$apply(function () {
        scope.datamovement.toggle();
      });
    }
}

function killtasks(taskID, action) {
    var message = '';
    if (action === 0)
        message = 'Are you sure you want to FINISH this task?'
    else
        message = 'Are you sure you want to ABORT this task?'
    if (confirm(message)) {
        $.ajax({
            url: {% url 'killtasks' %},
            data: {'task': taskID, 'action': action},
            async: true
        })
        .done(function (response) {
            if (typeof response === 'string') {
                response = $.parseJSON(response);
            }
            alert(response.detail);
            location.reload();
        });
    } else {
        // Do nothing!
    }
}

function operationtask_token(taskID, action) {
    var message = '';
    if (action == 'finishtask' ) {
        message = 'Are you sure you want to FINISH this task?'
    }
    else if (action == 'killtask') {
        message = 'Are you sure you want to ABORT this task?'
    }
    else {
        // Reserve
    }
    if (confirm(message)) {

        $.ajax({
            url: '/panda_client/',
            data: {taskID: taskID, action: action},
            async: false,
            type: "POST",
            success: function(result){
                result_obj = JSON.parse(result)
                alert(result_obj['text']);
              }
        })
    } else {
        // Do nothing!
    }
}


function buildDatasetsTable(data) {

  $('#datasetstable').dataTable({
    //"bRetrieve": true,
    "lengthMenu": [[10, 20, 50, 100, 200, -1], [10, 20, 50, 100, 200, "All"]],
    "paging": true,
    "scrollX": true,
    "aaSorting": [[1,'asc']],
    "columnDefs": [
        {"type": "num-html", "targets": [4,5,6,7] }
    ],
    "data": data,
    "aoColumns": [
        {
            "data": "datasetname",
            sDefaultContent: "---",
            "render": function(data, type, row, meta) {
                return '<a href = "{% url 'datasetInfo' %}?datasetid=' + row['datasetid'] + '">'+row['datasetname']+'</a>'
            }
        },
        {
            "data": "type",
            sDefaultContent: "-",
        },
        {
            "data": "streamname",
            sDefaultContent: "-",
        },
        {
            "data": "status",
            sDefaultContent: "-",
            className: 'state',
        },
        {
            "data": "nfiles",
            sDefaultContent: "-",
            className: 'num',
            "render": function(data, type, full, meta) {
                let str = '';
                if (data > 0) {
                    str += '<a href = "{% url 'fileList' %}?jeditaskid=' + full['jeditaskid'] + '&datasetid=' + full['datasetid'] + '">' + full['nfiles'] + '</a>';
                    if (full['nfilesmissing'] > 0) {str += ' <span class="lost">+' + full['nfilesmissing'] + ' lost</span>'; }
                }
                else {
                    str += data;
                }
                return str
            }
        },
        {
            "data": "nfilesfinished",
            sDefaultContent: "-",
            className: 'num',
            "render": function(data, type, full, meta) {
                if (full['type'] == 'input' && data > 0) {
                    return '<a href = "{% url 'fileList' %}?procstatus=finished&jeditaskid=' + full['jeditaskid'] + '&datasetid=' + full['datasetid'] +  '"><snap class="finished">' + full['nfilesfinished'] + '</snap></a>'
                }
                else if (full['type'] == 'input' && data == 0) {
                    return data;
                }
                else {
                    return '-';
                }
                }
        },
        {
            "data": "nfilesfailed",
            sDefaultContent: "-",
            className: 'num',
            "render": function(data, type, full, meta) {
                if (full['type'] == 'input' && data > 0) {
                    return '<a href = "{% url 'fileList' %}?procstatus=failed&jeditaskid=' + full['jeditaskid'] + '&datasetid=' + full['datasetid'] + '"><snap class="failed">' + full['nfilesfailed'] + '</snap></a>'
                }
                else if (full['type'] == 'input' && data == 0) {
                    return data;
                }
                else {
                    return '-';
                }
            }
        },
        {
            "data": "percentfinished",
            sDefaultContent: "-",
            className: 'num'
        },
        {
            "data": "type",
            sDefaultContent: "-",
            "render": function(data, type, row, meta) {
                var links = '';

                if ("{{ request.session.rucio_ui }}".length > 0 && row['datasetname']) {
                    var scope = row['scope'];
                    var name = row['datasetname'];

                    if (name.includes(':')) {
                        var didParts = name.split(':');
                        if (didParts.length === 2) {
                            scope = didParts[0];
                            name = didParts[0] +':'+ didParts[1];
                        }
                    } else if (name.startsWith('group.')) {
                        var parts = name.split('.');
                        if (parts.length >= 3) {
                            scope = parts.slice(0, 2).join('.');
                        }
                    }

                    links += '<a href="{{ request.session.rucio_ui }}did?scope=' + encodeURIComponent(scope) + '&name=' + encodeURIComponent(name) + '" target="_blank">' +
                             '<img src="/static/images/rucio-logo.png" width=14 height=14 border=0></a>';
                }

                if (row['type'] === 'input') {
                    links += (links.length > 0) ? ', ' : '';
                    links += '<a href="{% url 'jobList' %}?datasetid=' + row['datasetid'] + '&jeditaskid=' + row['jeditaskid'] + '"> jobs </a>';
                }

                return links;
            }
        },
        {
            "data": "rse",
            sDefaultContent: "-",
        },

    ],
    "createdRow": function ( row, data, index ) {
        $('td', row).eq(3).addClass(data['status'] + '_fill');
    }
  })
}


</script>

{% endblock %}

{% block help %}
  <a name="help"></a>
  {% include "taskInfoHelp.html" %}
{% endblock %}
