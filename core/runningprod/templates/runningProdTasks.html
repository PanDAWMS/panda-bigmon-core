{% extends "_base_core.html" %}
{% load humanize %}
{% load static %}
{% load common_tags %}
{% block page_title %} {% if requestParams.preset %}{{ requestParams.preset }} production {% else %}Production{% endif %}  tasks{% endblock %}
{% block subtitle %}<span {% if load_ended_tasks %}class="strikethrough"{% endif %}>Running</span> production tasks{{ viewParams.selection|safe }}
{% endblock %}
{% block css_page_library %}
  <link rel="stylesheet" href="{% static "js/datatables/DataTables-1.10.13/css/dataTables.foundation.css" %}">
  <!-- Load c3.css -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.8/c3.min.css" rel="stylesheet">
{% endblock %}
{% block js_head_page_library %}
  <script src="{% static 'js/humanize.min.js' %}"></script>
  <script src="{% static 'js/datatables/DataTables-1.10.13/js/jquery.dataTables.js' %}"></script>
  <script src="{% static 'js/datatables/DataTables-1.10.13/js/dataTables.foundation.js' %}"></script>
  <script src="{% static 'js/datatables/dataTables.num-html.js' %}"></script>
  <!-- Load d3.js and c3.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.12.0/d3.min.js" charset="utf-8"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.8/c3.min.js"></script>
{% endblock %}

{% block body %}
<div>
  {% if requestParams.corecount %}<br><b>Core count:</b> {{ requestParams.corecount }} {% endif %}
  {% if requestParams.username %}<br><b>User name:</b> {{ requestParams.username }} {% endif %}
  {% if requestParams.inputdataset %}<br><b>Input dataset:</b> {{ requestParams.inputdataset }} {% endif %}
  {% if requestParams.reqid %}<br><b>Request ID:</b> {{ requestParams.reqid }} {% endif %}
  {% if requestParams.ptag %}<br><b>pTag:</b> {{ requestParams.ptag }} {% endif %}
  {% if requestParams.site %}<br><b>Site:</b> {{ requestParams.site }} {% endif %}
</div>

<table class="minimalistic-table">
  <thead>
    <tr>
        <th>Preset</th>
        <th>Working group</th>
        <th>Processing type</th>
        <th>Input</th>
        <th>Output</th>
        <th>Campaign</th>
        <th>Status</th>
        <th></th>
        <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
        <select id="presetChoice">
          <option value="MC" {% if requestParams.preset == 'MC' %} selected="selected" {% endif %}>MC</option>
          <option value="DPD" {% if requestParams.preset == 'DPD' %} selected="selected" {% endif %}>DPD</option>
          <option value="DATA" {% if requestParams.preset == 'DATA' %} selected="selected" {% endif %}>DATA</option>
          <option value="" {% if requestParams.preset != 'DPD' and requestParams.preset != 'MC'  and requestParams.preset != 'DATA' %} selected="selected" {% endif %}>All</option>
        </select>
      </td>
      <td>
        <select multiple id="workinggroup">
          <option value=""  {% if 'workinggroup' not in requestParams and 'preset' not in requestParams %} selected="selected" {% endif %}>All</option>
          <option value="!AP_REPR,!AP_VALI,!GP_PHYS,!GP_THLT"
            {% if requestParams.workinggroup == '!AP_REPR,!AP_VALI,!GP_PHYS,!GP_THLT' %} selected="selected" {% endif %}
            {% if requestParams.preset == 'MC' and 'workinggroup' not in requestParams %} selected="selected" {% endif %}
            {% if requestParams.preset == 'DPD' or requestParams.preset == 'DATA' %} disabled="disabled" {% endif %}
          >NOT IN ('AP_REPR', 'AP_VALI', 'GP_PHYS', 'GP_THLT')</option>
          <option value="GP_*"
            {% if requestParams.preset == 'DPD' and requestParams.workinggroup == 'GP_*' %} selected="selected" {% endif %}
            {% if requestParams.preset == 'MC' or requestParams.preset == 'DATA' %} disabled="disabled" {% endif %}
          >GP_*</option>

          <option value="AP_REPR"
            {% if requestParams.preset == 'DATA' or requestParams.workinggroup == 'AP_REPR' %} selected="selected" {% endif %}
            {% if requestParams.preset == 'MC' or requestParams.preset == 'DPD' %} disabled="disabled" {% endif %}
          >AP_REPR</option>

          {% if requestParams.preset != 'DATA' %}
            {% for field in sumd %}
              {% if field.field == 'workinggroup' %}
                {% for wg in field.list %}
                  <option value={{ wg.kname }} {% if wg.kname in requestParams.workinggroup|split %} selected="selected" {% endif %}>{{ wg.kname }}</option>
                {% endfor %}
              {% endif %}
            {% endfor %}
          {% endif %}
        </select>
      </td>
      <td>
        <select multiple id="processingtype">
          <option value=""  {% if 'processingtype' not in requestParams and 'preset' not in requestParams %} selected="selected" {% endif %}>All</option>
          <option value="evgen|pile|simul|recon"
              {% if requestParams.preset == 'MC' and 'processingtype' not in requestParams %} selected="selected" {% endif %}
                {% if 'processingtype' in requestParams and requestParams.processingtype == 'evgen|pile|simul|recon' %} selected="selected" {% endif %}
              {% if requestParams.preset == 'DPD' or requestParams.preset == 'DATA' %} disabled="disabled" {% endif %}
          >evgen|pile|simul|recon</option>
          <option value="merge|deriv"
              {% if requestParams.preset == 'DPD' and 'processingtype' not in requestParams %} selected="selected" {% endif %}
                {% if 'processingtype' in requestParams and requestParams.processingtype == 'merge|deriv' %} selected="selected" {% endif %}
              {% if requestParams.preset == 'MC' or requestParams.preset == 'DATA' %} disabled="disabled" {% endif %}
          >merge|deriv</option>

          <option value="reprocessing"
              {% if requestParams.preset == 'DATA' and 'processingtype' not in requestParams %} selected="selected" {% endif %}
                {% if 'processingtype' in requestParams and requestParams.processingtype == 'reprocessing' %} selected="selected" {% endif %}
              {% if requestParams.preset == 'MC' or requestParams.preset == 'DPD' %} disabled="disabled" {% endif %}
          >reprocessing</option>

          {% if requestParams.preset != 'DATA' %}
            {% for f in sumd %}{% if f.field == 'processingtype' %}{% for v in f.list %}
              <option value={{ v.kname }} {% if v.kname in requestParams.processingtype|split %} selected="selected" {% endif %}>{{ v.kname }}</option>
            {% endfor %}{% endif %}{% endfor %}
          {% endif %}
        </select>
      </td>
      <td>
        <select multiple id="inputdatasettype">
          <option value="" {% if 'inputdatasettype' not in requestParams %} selected="selected" {% endif %}>All</option>
          {% for f in sumd %}{% if f.field == 'inputdatasettype' %}{% for v in f.list %}
            <option value="{{ v.kname }}" {% if v.kname in requestParams.inputdatasettype|split %} selected="selected" {% endif %}>{{ v.kname }}</option>
          {% endfor %}{% endif %}{% endfor %}
        </select>
      </td>
      <td>
        <select multiple id="outputdatasettype">
          <option value="" {% if 'outputdatasettype' not in requestParams %}selected="selected"{% endif %}>All</option>
          {% for f in sumd %}{% if f.field == 'outputdatasettype' %}{% for v in f.list %}
            <option value="{{ v.kname }}" {% if v.kname in requestParams.outputdatasettype|split %} selected="selected" {% endif %}>{{ v.kname }}</option>
          {% endfor %}{% endif %}{% endfor %}
        </select>
      </td>
      <td>
        <select multiple id="campaign">
          <option value="" {% if 'campaign' not in requestParams %} selected="selected"{% endif %}>All</option>
          <option value="MC*"
            {% if requestParams.preset == 'MC' or requestParams.campaign == 'MC*' %} selected="selected" {% endif %}
            {% if requestParams.preset == 'DPD' or requestParams.preset == 'DATA' %} disabled="disabled" {% endif %}
          > like 'MC%'</option>
          {% for campaign in sumd.0.list %}
            <option value="*{{ campaign.kname }}*"
                {% if campaign.kname in requestParams.campaign or campaign.kname in requestParams.campaign|split %} selected="selected" {% endif %}
            >{{ campaign.kname }} </option>
          {% endfor %}
        </select>
      </td>
      <td>
        <select multiple id="status">
          <option value="" {% if 'status' not in requestParams %} selected="selected"{% endif %}>All</option>
          {% for f in sumd %}{% if f.field == 'status' %}{% for v in f.list %}
            <option value={{ v.kname }} {% if v.kname in requestParams.status|split %} selected="selected" {% endif %}>{{ v.kname }}</option>
          {% endfor %}{% endif %}{% endfor %}
          {% if requestParams.preset == 'MC' %}
            <option value="!paused" {% if 'status' in requestParams and requestParams.status == '!paused' %} selected="selected"{% endif %}>!paused</option>
          {% endif %}
        </select>
      </td>
      <td>
        <label><input type="checkbox" id="hpc" name="hpc" value="hpc"{% if requestParams.site == 'hpc' %} checked {% endif %}>HPC</label>
        <label><input type="checkbox" id="es" name="es" value="1"{% if requestParams.eventservice == '1' %} checked {% endif %}>ES</label>
        <label><input type="checkbox" id="jumbo" name="jumbo" value="1"{% if requestParams.jumbo == '1' %} checked {% endif %}>Jumbo</label>
      </td>
      <td>
          <a id="button-go" class="button primary">Go!</a>
      </td>
    </tr>
  </tbody>
</table>


<div id="warning" style="display:none"> <span class="warning" style="font-size: 24px">Data is out of date since you changed selection. Press GO! button to apply changes. </span></div>


{% if gsum.ntasks > 0 %}

<table class="unstriped stack minimalistic-table">
  <thead>
    <tr>
      <th> Events: {{ gsum.nevents | intword }} in total, extra plots [<a id="button-extra-plots"><i id="plussign" class="fi-plus"></i></a>]
        {% if 'preset' in requestParams or 'processingtype' in requestParams or requestParams|length == 0 %}, <a id="nEventsTrendLink"> show historical trend</a>{% endif %}
      </th>
      <th> Allocated slots: {{ gsum.aslots | intcomma }} in total</th>
      <th class="mid"> Task age</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
        {% for pgroup, pgdict in plots.items %}
          {% if pgroup == 'main' or pgroup == 'main_preset' %}
            {% for pname in pgdict.keys %}
              {% if 'nevents' in pname %}
                <div class="c3-chart-block" id="{{ pname }}"></div>
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endfor %}
      </td>
      <td>
        {% for pgroup, pgdict in plots.items %}
          {% if pgroup == 'main' or pgroup == 'main_preset' %}
            {% for pname in pgdict.keys %}
              {% if 'aslots' in pname %}
                <div class="c3-chart-block" id="{{ pname }}"></div>
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endfor %}
      </td>
      <td>
        {% for pgroup, pgdict in plots.items %}
          {% if pgroup == 'main' or pgroup == 'main_preset' %}
            {% for pname in pgdict.keys %}
              {% if 'hist' in pname %}
                <div class="c3-chart-block" id="{{ pname }}"></div>
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endfor %}
      </td>
    </tr>
    <tr id="extraplots" style="display: none">
      <td colspan="3">
        {% for pgroup, pgdict in plots.items %}
          {% if pgroup == 'extra' %}
            {% for pname in pgdict.keys %}
              <div class="c3-chart-block" id="{{ pname }}"></div>
            {% endfor %}
          {% endif %}
        {% endfor %}
      </td>
    </tr>
  </tbody>
</table>

<div id="nEventsLineChart" class="row d3splot" style="display: none; margin: 0"></div>

<table id = 'tasklist' class="data-table nowrap">
<caption>{{ gsum.ntasks }} task{% if gsum.ntasks > 1 %}s{% endif %} listed.
  {% if gsum.gco2_sum|length > 0 %}
    Estimated CO<sub>2</sub>  emission <a class="bp-tooltip left blacklink" target="_blank" href="https://panda-wms.readthedocs.io/en/latest/advanced/carbon_footprint.html"><i class="fi-info"></i>
            <span class="bp-tooltip tooltip-text">see explanation of how it is calculated</span></a>
    in total: {{ gsum.gco2_sum.total.value }} {{ gsum.gco2_sum.total.unit }},
    including <span class="broken">{{ gsum.gco2_sum.failed.value }} {{ gsum.gco2_sum.failed.unit }}</span> by failed jobs.
  {% endif %}
</caption>
<thead>
<tr>
  <th>Campaign</th>
  <th>Req ID</th>
  <th>Run</th>
  <th>Task ID</th>
  <th>R Jobs</th>
  <th>Status (PS2)</th>
  <th>Status (JEDI)</th>
  {% if requestParams.preset != 'DPD' %}
    <th>Type</th>
  {% endif %}
  <th>Evts total</th>
  <th>Evts done</th>
  <th>Evts running</th>
  <th>Evts waiting</th>
  <th>Evts failed</th>
  <th>%</th>
  <th>Priority</th>
  {% if requestParams.preset == 'DPD' %}
    <th>pTag</th>
  {% endif %}
  {% if requestParams.preset == 'MC' %}
    <th>Sim</th>
    <th>aTag</th>
  {% endif %}
  {% if requestParams.preset == 'DATA' %}
      <th>rTag</th>
  {% endif %}
  <th>Input</th>
  <th>Output</th>
  <th>Age</th>
  <th>Cores</th>
  {% if requestParams.preset == 'MC' or requestParams.preset == '' %}
    <th>Working group</th>
    <th>User</th>
  {% endif %}
  <th>CPU Time per Event</th>
  <th>Global Share</th>
  <th>Hashtags</th>
  <th>Site</th>
  <th>Container name</th>
  <th>ES</th>
  <th>Jumbo</th>
</tr>
</thead>
<tbody></tbody>
</table>

{% else %}
    <p>No matches to query.</p>
{% endif %}

{% endblock %}

{% block help %}
  {% include 'taskRunningProductionHelp.html' %}
{% endblock %}


{% block js_body_page %}

<script src="{% static 'js/d3jsplot.js' %}"></script>
<script src="{% static 'js/draw-plots-c3.js' %}?{% cache_bust "js/draw-plots-c3.js" %}"></script>

<script nonce={{request.csp_nonce}}>
var plots_dict = {{ plots | safe }};
var charts = {};
var requestParams = {{ requestParams | safe }};
var ntasks = {{ gsum.ntasks | safe }};

if (document.getElementById("button-go")) {
  document.getElementById("button-go").addEventListener("click", go);
}
if (document.getElementById("button-extra-plots"))  {
  document.getElementById("button-extra-plots").addEventListener("click", toggleByID.bind(null, 'extraplots', 'plussign'));
}
if (document.getElementById("nEventsTrendLink")) {
  document.getElementById("nEventsTrendLink").addEventListener("click", toggleHistoricalTrend.bind(null, 'nEventsLineChart', 'nEventsTrendLink'));
}

document.getElementById("presetChoice").addEventListener("change", onPresetChoice);
document.getElementById("workinggroup").addEventListener("change",onSubElementChoice);
document.getElementById("processingtype").addEventListener("change",onSubElementChoice);
document.getElementById("inputdatasettype").addEventListener("change",onSubElementChoice);
document.getElementById("outputdatasettype").addEventListener("change",onSubElementChoice);
document.getElementById("campaign").addEventListener("change", onSubElementChoice);
document.getElementById("status").addEventListener("change",onSubElementChoice);
document.getElementById("hpc").addEventListener("change",onSubElementChoice);
document.getElementById("es").addEventListener("change", onSubElementChoice);
document.getElementById("jumbo").addEventListener("change",onSubElementChoice);

$(document).ready(function () {

  Object.keys(plots_dict).forEach(pgroup => {
    Object.keys(plots_dict[pgroup]).forEach(item => {
      let options = plots_dict[pgroup][item]['options'];
      if (item.indexOf('hist') > -1) {
        options['size'] = [440, 260];
        charts[item] = draw_bar(plots_dict[pgroup][item]['data'], item, plots_dict[pgroup][item]['title'], options)
      }
      else if (options.type && options.type === 'sbar') {
        options['size'] = [440, 280];
        options['colors'] = {
          'done': '#207f20',
          'running': '#34a934',
          'waiting': '#c7c7c7',
          'failed': '#d62728',
        };
        charts[item] = draw_bar_cat(plots_dict[pgroup][item]['data'], item, plots_dict[pgroup][item]['title'], options)
      }
      else {
        options['size'] = [210,260];
        if (plots_dict[pgroup][item]['data'].length > 3) {
          options['size'][1] = options['size'][1] + plots_dict[pgroup][item]['data'].length * 20 / 3;
        }
        options['legend_position'] = 'bottom';
        if (item.indexOf('processingtype') > -1) {
          options['colors'] = {
            'evgen': '#ff7f0e',
            'pile': '#d62728',
            'simul': '#1f77b4',
            'recon': '#2ca02c',
            'reprocessing': '#9467bd',
            'deriv': '#bcbd22',
            'merge': '#17becf',
            'eventIndex': '#e377c2',
            'overlay': '#3b8e67',
            'archive': '#4a4a4a',
            'skim': '#62c9ae',
          };
        }
        else if (item.indexOf('status') > -1) {
          options['colors'] =  {
            'done': '#207f20',
            'running': '#34a934',
            'waiting': '#c7c7c7',
            'assigning': '#099999',
            'exhausted': '#FF9933',
            'paused': '#808080',
            'throttled': '#deb900',
            'pending': '#a9a9a9',
            'ready': '#3b8e67',
            'registered': '#4a4a4a',
            'scouting': '#47D147',
            'aborting': '#ff9896',
            'failed': '#d62728',
            'broken': '#b22222',
            'passed': '#1a1a1a',
            'defined': '#2174bb',
          };
        }
        charts[item] = draw_donut(plots_dict[pgroup][item]['data'], item, plots_dict[pgroup][item]['title'], options)
      }
    })
  });

  var preset = {{ productiontype|safe }};
  if (preset === 'MC') {
      taskListMCTable(ntasks);
  }
  else if (preset === 'DPD') {
      taskListDPDTable(ntasks);
  }
  else if (preset === 'DATA') {
      taskListDataTable(ntasks);
  }
  else {
      taskListTable();
  }
});

  function toggleByID(id, idplus) {
      if ($("#" + id).is(':visible')){
          $("#" + id).hide();
          $("#" + idplus).removeClass('fi-minus');
          $("#" + idplus).addClass('fi-plus');
      }
      else {
          $("#" + id).show();
          $("#" + idplus).removeClass('fi-plus');
          $("#" + idplus).addClass('fi-minus');
      }

  }

  function toggleHistoricalTrend(divID, linkID) {
      if ($("#" + divID).is(':visible')){
          $("#" + divID).hide();
          document.getElementById(linkID).innerHTML = 'show historical trend';
      }
      else {
          if (document.getElementById(divID).firstChild) {
              $('#'+divID).show();
          }
          else {
              var params = '';
              var preset = {{ productiontype|safe }};
              var processingtype = "{{ requestParams.processingtype  }}";
              if (processingtype.length > 0) {
                  params += 'processingtype='+ processingtype;
              }
              else {
                  if (preset === 'MC') {
                      params += 'processingtype=evgen|pile|simul|recon';
                  }
                  else if (preset === 'DPD') {
                      params += 'processingtype=merge|deriv';
                  }
                  else if (preset === 'DATA') {
                      params += 'processingtype=reprocessing';
                  }
                  params += '&';
              }
              var title = 'Nevents trend for last 7 days';
              if (params.length > 0) {
                  title += ', taken into account all active tasks with ' + params;
                  params += '&';
              }
              params += 'view=separated&json';
              let options = {
                size: [getWidth()-40, 460],
                labels: ['Timestamp, UTC', 'Number of events'],
                colors: {
                  'done': '#207f20',
                  'running': '#34a934',
                  'waiting': '#c7c7c7',
                  'evgen_running': '#ff7f0e',
                  'pile_running': '#d62728',
                  'simul_running': '#1f77b4',
                  'recon_running': '#2ca02c',
                  'reprocessing_running': '#9467bd',
                  'deriv_running': '#bcbd22',
                  'merge_running': '#17becf',
                  'eventIndex_running': '#e377c2',
                  'overlay_running': '#3b8e67',
                  'archive_running': '#9e6721',
                  'evgen_waiting': '#ffbb78',
                  'pile_waiting': '#ff9896',
                  'simul_waiting': '#aec7e8',
                  'recon_waiting': '#98df8a',
                  'reprocessing_waiting': '#c5b0d5',
                  'deriv_waiting': '#dbdb8d',
                  'merge_waiting': '#9edae5',
                  'eventIndex_waiting': '#f7b6d2',
                  'overlay_waiting': '#a1d9bf',
                  'archive_waiting': '#d2b177',
                  'total_running': '#000000',
                  'total_waiting': '#7f7f7f',
                }
              };
              $.ajax({
                  url: {% url 'prodNeventsTrend' %},
                  data: params,
                  dataType:'json',
                  success: function(response) {
                  var plotData = response;
                  charts['nEventsLineChart'] = draw_multi_line(plotData, 'nEventsLineChart', title, options);
                  }
              });

              $('#'+divID).show();
              document.getElementById(linkID).innerHTML = 'hide historical trend';
          }
      }
  }

  function onPresetChoice () {
    var presetChoice = document.getElementById ("presetChoice");
    var workinggroup = document.getElementById ("workinggroup");
    var processingtype = document.getElementById ("processingtype");
    var campaign = document.getElementById ("campaign");
    var status = document.getElementById ("status");
    var inputdatasettype = document.getElementById ("inputdatasettype");
    var outputdatasettype = document.getElementById ("outputdatasettype");
    var warning = document.getElementById ("warning");

    if (presetChoice.value == 'MC') {
        workinggroup.selectedIndex = 1;
        processingtype.selectedIndex = 1;
        campaign.selectedIndex = 1;
        status.selectedIndex = 0;
        inputdatasettype.selectedIndex = 0;
        outputdatasettype.selectedIndex = 0;
    }

    if (presetChoice.value == 'DPD') {
        workinggroup.selectedIndex = 2;
        processingtype.selectedIndex = 2;
        campaign.selectedIndex = 0;
        status.selectedIndex = 0;
        inputdatasettype.selectedIndex = 0;
        outputdatasettype.selectedIndex = 0;
    }

    if (presetChoice.value == 'DATA') {
        workinggroup.selectedIndex = 3;
        processingtype.selectedIndex =3;
        campaign.selectedIndex =0;
        status.selectedIndex = 0;
        inputdatasettype.selectedIndex = 0;
        outputdatasettype.selectedIndex = 0;
    }


    if (presetChoice.value == '') {
        workinggroup.selectedIndex = 0;
        processingtype.selectedIndex = 0;
        campaign.selectedIndex = 0;
        status.selectedIndex = 0;
        inputdatasettype.selectedIndex = 0;
        outputdatasettype.selectedIndex = 0;
    }
    warning.style.display = '';
  }

  function onSubElementChoice() {
      var warning = document.getElementById ("warning");
      warning.style.display = '';
  }

  function go() {
      const queryBase = "{% url 'runningProdTasks' %}";
      const params = new URLSearchParams();
      const select_single = [
          ["presetChoice", "preset"],
      ]
      const select_multi = [
          ["workinggroup", "workinggroup"],
          ["processingtype", "processingtype"],
          ["inputdatasettype", "inputdatasettype"],
          ["outputdatasettype", "outputdatasettype"],
          ["campaign", "campaign"],
          ["status", "status"]
      ];
      select_single.forEach(([id, key]) => {
          const el = document.getElementById(id);
          if (el && el.value.trim()) {
              params.append(key, el.value.trim());
          }
      });
      select_multi.forEach(([id, key]) => {
        const values = Array.from(document.getElementById(id).selectedOptions).map(({ value }) => value).filter(value => value.trim() !== '');
        if (values && values.length > 0) {
          params.append(key, values.join('|'));
        }
      })
      const checkboxes = [
          ["hpc", "site"],
          ["es", "eventservice"],
          ["jumbo", "jumbo"]
      ];
      checkboxes.forEach(([id, key]) => {
          const el = document.getElementById(id);
          if (el && el.checked) {
              params.append(key, el.value);
          }
      });

      // Handle time filters
      if ('days' in requestParams) {
          params.append('days', requestParams.days);
      } else if ('hours' in requestParams) {
          params.append('hours', requestParams.hours);
      } else if ('date_from' in requestParams && 'date_to' in requestParams) {
          params.append('date_from', requestParams.date_from);
          params.append('date_to', requestParams.date_to);
      }

      const query = params.toString()
          ? `${queryBase}?${params.toString()}`
          : queryBase;

      window.location = query;
  }

  function taskListMCTable(ntasks) {

    $('#tasklist').dataTable({
      //"bRetrieve": true,
      "iDisplayLength": (ntasks < 1000) ? -1 :  1000,
      "lengthMenu": [[20, 50, 100, 1000, -1], [20, 50, 100, 1000,  "All"]],
      "paging": true,
      "scrollX": true,
      "aaSorting": [[17,'desc']],

      "ajax": {
          "processing": true,
          "url": "{% url 'runningProdTasks' %}?tk={{ transKey }}&dt",
          "dataSrc" : ''},
      "columnDefs": [
          {"type": "num-html", "targets": [1,2,3,4,8,9,10,11,12,13,14,17,18,21] }
      ],
      "aoColumns": [
          {
              "data": "cutcampaign",
              sDefaultContent: "---",
              "render": function(data, type, row, meta) {
                  return '<a href = "{{ xurl }}campaign=' + row['campaign'] + '">'+row['cutcampaign']+'</a>'
               }
          },
          {
              "data": "reqid",
              sDefaultContent: "",
              "render": function ( data, type, full, meta ) {
                  let slice = (full['sliceid'] && full['sliceid'] > 0) ? '#inputList' + full['sliceid'] : '' ;
                  return '<a href = "{{ xurl }}reqid=' + full['reqid'] + '">' + full['reqid'] + '</a> <a href="https://prodtask-dev.cern.ch/prodtask/inputlist_with_request/' + full['reqid'] + '/' + slice + '" target="_blank"><i class="fi-link"></i></a>'
              }
          },
          {
              "data": "inputdataset",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}runnumber=' + full['runnumber'] + '">' + full['inputdataset'] + '</a>'
              }
          },
          {
              "data": "jeditaskid",
              sDefaultContent: "",
              "render": function ( data, type, full, meta ) {
                  return '<a href = "{% url 'taskInfo' %}' + full['jeditaskid'] + '/">' + full['jeditaskid'] + '</a> <a href="https://prodtask-dev.cern.ch/prodtask/task/' + full['jeditaskid'] + '/" target="_blank"><i class="fi-link"></i></a>'
              }
          },
          {
              "data": "rjobs",
              sDefaultContent: "",
              className: 'num',
              "render": function(data, type, full, meta) {
                  if (data > 0) {
                      return '<a href = "{% url 'jobList' %}?jobstatus=running&jeditaskid=' + full['jeditaskid'] + '">' + full['rjobs'] + '</a>'
                  }
                  else {
                      return data;
                  }
              }
          },
          {
              "data": "superstatus",
              sDefaultContent: "",
              className: "state",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}superstatus=' + full['superstatus'] + '">' + full['superstatus'] + '</a>'
              }
          },
          {
              "data": "status",
              sDefaultContent: "",
              className: "state",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}status=' + full['status'] + '">' + full['status'] + '</a>'
              }
          },
          {
              "data": "processingtype",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}processingtype=' + full['processingtype'] + '">' + full['processingtype'] + '</a>'
              }
          },
          {
              "data": "nevents",
              sDefaultContent: "---",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')

          },
          {
              "data": "neventsdone",
              sDefaultContent: "",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "neventsrunning",
              sDefaultContent: "0",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "neventswaiting",
              sDefaultContent: "---",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "neventsfailed",
              sDefaultContent: "",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "percentage",
              sDefaultContent: "",
              className: 'num'
          },
          {
              "data": "priority",
              sDefaultContent: "",
              className: 'num'
          },
          {
              "data": "simtype",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}simtype=' + full['simtype'] + '">' + full['simtype'] + '</a>'
              }
          },
          {
              "data": "atag",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  if (data) {
                      return '<a href = "{{ xurl }}atag=' + full['atag'] + '">' + full['atag'] + '</a>'
                  }
                  else {
                      return '---';
                  }
              },
          },
          {
              "data": "inputdatasettype",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                if (data && data !== '') {
                  return '<a href = "{{ xurl }}inputdatasettype=' + full['inputdatasettype'] + '">' + full['inputdatasettype'] + '</a>'
                }
                else {
                  return '<a href = "{{ xurl }}inputdatasettype=Not+specified">---</a>'
                }
              }
          },
          {
              "data": "outputdatasettype",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  if (data && data !== '') {
                  return '<a href = "{{ xurl }}outputdatasettype=' + full['outputdatasettype'] + '">' + full['outputdatasettype'] + '</a>'
                }
                else {
                  return '<a href = "{{ xurl }}outputdatasettype=Not+specified">---</a>'
                }
              }
          },
          {
              "data": "age",
              sDefaultContent: "",
              className: 'num',
          },
          {
              "data": "corecount",
              sDefaultContent: "",
              className: 'num',
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}corecount=' + full['corecount'] + '">' + full['corecount'] + '</a>'
              }
          },
          {
              "data": "workinggroup",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}workinggroup=' + full['workinggroup'] + '">' + full['workinggroup'] + '</a>'
              }
          },
          {
              "data": "username",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}username=' + full['username'] + '">' + full['username'] + '</a>'
              }
          },
          {
              "data": "cputime",
              sDefaultContent: "---",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.'),
          },
          {
              "data": "gshare",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}gshare=' + full['gshare'] + '">' + full['gshare'] + '</a>'
              }
          },
          {
              "data": "hashtags",
              sDefaultContent: "---",
              "render": function ( data, type, row ) {
                  if (data.length > 0) {
                      var xurl = '{{ xurl|safe }}';
                      var prodsysurl = 'https://prodtask-dev.cern.ch/dkb/#/output_stat/?hashtag=|';
                      var hashtaglist = data.split(',');
                      var hashtaglinks = '';
                      for (var i = 0; i < hashtaglist.length; i++) {
                          if (xurl.indexOf('hashtags') > -1) {
                              hashtaglinks += '<a href = "{{ nohashtagurl }}hashtags={{ requestParams.hashtags }},' + hashtaglist[i] + '">' + hashtaglist[i] + '</a> '
                          }
                          else
                          {
                              hashtaglinks += '<a href = "{{ xurl }}hashtags=' + hashtaglist[i] + '">' + hashtaglist[i] + '</a> '
                          }
                      hashtaglinks += '<a href="' + prodsysurl + hashtaglist[i] + '" target="_blank"><i class="fi-link"></i></a> '
                      }
                      return hashtaglinks;
                  }
                  else {
                      return '---'
                  }
              }
          },
          {
              "data": "site",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  if (data) {
                      return '<a href = "{{ xurl }}site=' + full['site'] + '">' + full['site'] + '</a>'
                  }
                  else {
                      return '---';
                  }
              }
          },
          {
              "data": "eventservice",
              sDefaultContent: "---",
              "render": function(data, type, full, meta) {
                  if (data) {
                      return '<a href = "{{ xurl }}eventservice=' + full['eventservice'] + '">' + full['eventservice'] + '</a>'
                  }
                  else {
                      return '---';
                  }
              },
          },
          {
              "data": "jumbo",
              sDefaultContent: "---",
              "render": function(data, type, full, meta) {
                  if (data) {
                      return '<a href = "{{ xurl }}jumbo=' + full['jumbo'] + '">' + full['jumbo'] + '</a>'
                  }
                  else {
                      return '---';
                  }
              },
          },
          {
              "data": "container_name",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  if (data) {
                      return '<a href = "{{ xurl }}container_name=' + full['container_name'] + '">' + full['container_name'] + '</a>'
                  }
                  else {
                      return '---';
                  }
              }
          }
      ],
      "createdRow": function ( row, data, index ) {
          $('td', row).eq(5).addClass(data['superstatus'] + '_fill');
          $('td', row).eq(6).addClass(data['status'] + '_fill');
      }
    });
  }

  function taskListDPDTable(ntasks) {
    $('#tasklist').dataTable({
      //"bRetrieve": true,
      "iDisplayLength": (ntasks < 1000) ? -1 :  1000,
      "lengthMenu": [[20, 50, 100, 1000, -1], [20, 50, 100, 1000,  "All"]],
      "paging": true,
      "scrollX": true,
      "aaSorting": [[16,'desc']],
      "columnDefs": [
          {"type": "num-html", "targets": [1,2,3,4,8,9,10,11,12,13,14,16,17] }
      ],

      "ajax": {
          "processing": true,
          "url": "{% url 'runningProdTasks' %}?tk={{ transKey }}&dt",
          "dataSrc" : ''},
      "aoColumns": [
          {
              "data": "cutcampaign",
              sDefaultContent: "---",
              "render": function(data, type, row, meta) {
                  return '<a href = "{{ xurl }}campaign=' + row['campaign'] + '">'+row['cutcampaign']+'</a>'
               }
          },
          {
              "data": "reqid",
              sDefaultContent: "",
              "render": function ( data, type, full, meta ) {
                  let slice = (full['sliceid'] && full['sliceid'] > 0) ? '#inputList' + full['sliceid'] : '' ;
                  return '<a href = "{{ xurl }}reqid=' + full['reqid'] + '">' + full['reqid'] + '</a> <a href="https://prodtask-dev.cern.ch/prodtask/inputlist_with_request/' + full['reqid'] + '/' + slice + '" target="_blank"><i class="fi-link"></i></a>'
              }
          },
          {
              "data": "inputdataset",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}runnumber=' + full['runnumber'] + '">' + full['inputdataset'] + '</a>'
              }
          },
          {
              "data": "jeditaskid",
              sDefaultContent: "",
              "render": function ( data, type, full, meta ) {
                  return '<a href = "{% url 'taskInfo' %}' + full['jeditaskid'] + '/">' + full['jeditaskid'] + '</a> <a href="https://prodtask-dev.cern.ch/prodtask/task/' + full['jeditaskid'] + '/" target="_blank"><i class="fi-link"></i></a>'
              }
          },
          {
              "data": "rjobs",
              sDefaultContent: "",
              className: 'num',
              "render": function(data, type, full, meta) {
                  if (data > 0) {
                      return '<a href = "{% url 'jobList' %}?jobstatus=running&jeditaskid=' + full['jeditaskid'] + '">' + full['rjobs'] + '</a>'
                  }
                  else {
                      return data;
                  }
              }
          },
          {
              "data": "superstatus",
              sDefaultContent: "",
              className: "state",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}superstatus=' + full['superstatus'] + '">' + full['superstatus'] + '</a>'
              }
          },
          {
              "data": "status",
              sDefaultContent: "",
              className: "state",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}status=' + full['status'] + '">' + full['status'] + '</a>'
              }
          },
          {
              "data": "nevents",
              sDefaultContent: "---",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "neventsdone",
              sDefaultContent: "",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "neventsrunning",
              sDefaultContent: "0",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "neventswaiting",
              sDefaultContent: "---",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "neventsfailed",
              sDefaultContent: "",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "percentage",
              sDefaultContent: "",
              className: 'num',
          },
          {
              "data": "priority",
              sDefaultContent: "",
              className: 'num'
          },
          {
              "data": "ptag",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}ptag=' + full['ptag'] + '">' + full['ptag'] + '</a>'
              }
          },
          {
              "data": "inputdatasettype",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                if (data && data !== '') {
                  return '<a href = "{{ xurl }}inputdatasettype=' + full['inputdatasettype'] + '">' + full['inputdatasettype'] + '</a>'
                }
                else {
                  return '<a href = "{{ xurl }}inputdatasettype=Not+specified">---</a>'
                }
              }
          },
          {
              "data": "outputtypes",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                if (data && data !== '' && data !== 'N/A') {
                  return '<a href = "{{ xurl }}outputdatasettype=' + full['outputdatasettype'] + '">' + full['outputtypes'] + '</a>'
                }
                else {
                  return '<a href = "{{ xurl }}outputdatasettype=Not+specified">---</a>'
                }
              }
          },
          {
              "data": "age",
              sDefaultContent: "",
              className: 'num',
          },
          {
              "data": "corecount",
              sDefaultContent: "",
              className: 'num',
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}corecount=' + full['corecount'] + '">' + full['corecount'] + '</a>'
              }
          },
          {
              "data": "cputime",
              sDefaultContent: "---",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "gshare",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}gshare=' + full['gshare'] + '">' + full['gshare'] + '</a>'
              }
          },
          {
              "data": "hashtags",
              sDefaultContent: "---",
              "render": function ( data, type, row ) {
                  if (data.length > 0) {
                      var xurl = '{{ xurl|safe }}';
                      var prodsysurl = 'https://prodtask-dev.cern.ch/dkb/#/output_stat/?hashtag=|';
                      var hashtaglist = data.split(',');
                      var hashtaglinks = '';
                      for (var i = 0; i < hashtaglist.length; i++) {
                          if (xurl.indexOf('hashtags') > -1) {
                              hashtaglinks += '<a href = "{{ nohashtagurl }}hashtags={{ requestParams.hashtags }},' + hashtaglist[i] + '">' + hashtaglist[i] + '</a> '
                          }
                          else
                          {
                              hashtaglinks += '<a href = "{{ xurl }}hashtags=' + hashtaglist[i] + '">' + hashtaglist[i] + '</a> '
                          }
                      hashtaglinks += '<a href="' + prodsysurl + hashtaglist[i] + '" target="_blank"><i class="fi-link"></i></a> '
                      }
                      return hashtaglinks;
                  }
                  else {
                      return '---'
                  }
              }
          },
          {
              "data": "site",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}site=' + full['site'] + '">' + full['site'] + '</a>'
              }
          },
          {
              "data": "eventservice",
              sDefaultContent: "---",
              "render": function(data, type, full, meta) {
                  if (data) {
                      return '<a href = "{{ xurl }}eventservice=' + full['eventservice'] + '">' + full['eventservice'] + '</a>'
                  }
                  else {
                      return '---';
                  }
              },
          },
          {
              "data": "jumbo",
              sDefaultContent: "---",
              "render": function(data, type, full, meta) {
                  if (data) {
                      return '<a href = "{{ xurl }}jumbo=' + full['jumbo'] + '">' + full['jumbo'] + '</a>'
                  }
                  else {
                      return '---';
                  }
              },
          },
          {
              "data": "container_name",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  if (data) {
                      return '<a href = "{{ xurl }}container_name=' + full['container_name'] + '">' + full['container_name'] + '</a>'
                  }
                  else {
                      return '---';
                  }
              }
          }

      ],
      "createdRow": function ( row, data, index ) {
          $('td', row).eq(5).addClass(data['superstatus'] + '_fill');
          $('td', row).eq(6).addClass(data['status'] + '_fill');
      }
    })
  }

  function taskListDataTable(ntasks) {
    $('#tasklist').dataTable({
      //"bRetrieve": true,
      "iDisplayLength": (ntasks < 1000) ? -1 :  1000,
      "lengthMenu": [[20, 50, 100, 1000, -1], [20, 50, 100, 1000,  "All"]],
      "paging": true,
      "scrollX": true,
      "aaSorting": [[16,'desc']],
      "columnDefs": [
          {"type": "num-html", "targets": [1,2,3,4,8,9,10,11,12,13,14,16,17] }
      ],

      "ajax": {
          "processing": true,
          "url": "{% url 'runningProdTasks' %}?tk={{ transKey }}&dt",
          "dataSrc" : ''},
      "aoColumns": [
          {
              "data": "cutcampaign",
              sDefaultContent: "---",
              "render": function(data, type, row, meta) {
                  return '<a href = "{{ xurl }}campaign=' + row['campaign'] + '">'+row['cutcampaign']+'</a>'
               }
          },
          {
              "data": "reqid",
              sDefaultContent: "",
              "render": function ( data, type, full, meta ) {
                  let slice = (full['sliceid'] && full['sliceid'] > 0) ? '#inputList' + full['sliceid'] : '' ;
                  return '<a href = "{{ xurl }}reqid=' + full['reqid'] + '">' + full['reqid'] + '</a> <a href="https://prodtask-dev.cern.ch/prodtask/inputlist_with_request/' + full['reqid'] + '/' + slice + '" target="_blank"><i class="fi-link"></i></a>'
              }
          },
          {
              "data": "inputdataset",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}runnumber=' + full['runnumber'] + '">' + full['inputdataset'] + '</a>'
              }
          },
          {
              "data": "jeditaskid",
              sDefaultContent: "",
              "render": function ( data, type, full, meta ) {
                  return '<a href = "{% url 'taskInfo' %}' + full['jeditaskid'] + '/">' + full['jeditaskid'] + '</a> <a href="https://prodtask-dev.cern.ch/prodtask/task/' + full['jeditaskid'] + '/" target="_blank"><i class="fi-link"></i></a>'
              }
          },
          {
              "data": "rjobs",
              sDefaultContent: "",
              className: 'num',
              "render": function(data, type, full, meta) {
                  if (data > 0) {
                      return '<a href = "{% url 'jobList' %}?jobstatus=running&jeditaskid=' + full['jeditaskid'] + '">' + full['rjobs'] + '</a>'
                  }
                  else {
                      return data;
                  }
              }
          },
          {
              "data": "superstatus",
              sDefaultContent: "",
              className: "state",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}superstatus=' + full['superstatus'] + '">' + full['superstatus'] + '</a>'
              }
          },
          {
              "data": "status",
              sDefaultContent: "",
              className: "state",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}status=' + full['status'] + '">' + full['status'] + '</a>'
              }
          },
          {
              "data": "processingtype",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}processingtype=' + full['processingtype'] + '">' + full['processingtype'] + '</a>'
              }
          },
          {
              "data": "nevents",
              sDefaultContent: "---",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "neventsdone",
              sDefaultContent: "",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "neventsrunning",
              sDefaultContent: "0",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "neventswaiting",
              sDefaultContent: "---",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "neventsfailed",
              sDefaultContent: "",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "percentage",
              sDefaultContent: "",
              className: 'num'
          },
          {
              "data": "priority",
              sDefaultContent: "",
              className: 'num'
          },
          {
              "data": "rtag",
              sDefaultContent: "",
              className: '',
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}rtag=' + full['rtag'] + '">' + full['rtag'] + '</a>'
              }
          },
          {
              "data": "inputdatasettype",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                if (data && data !== '') {
                  return '<a href = "{{ xurl }}inputdatasettype=' + full['inputdatasettype'] + '">' + full['inputdatasettype'] + '</a>'
                }
                else {
                  return '<a href = "{{ xurl }}inputdatasettype=Not+specified">---</a>'
                }
              }
          },
          {
              "data": "outputdatasettype",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  if (data && data !== '') {
                  return '<a href = "{{ xurl }}outputdatasettype=' + full['outputdatasettype'] + '">' + full['outputdatasettype'] + '</a>'
                }
                else {
                  return '<a href = "{{ xurl }}outputdatasettype=Not+specified">---</a>'
                }
              }
          },
          {
              "data": "age",
              sDefaultContent: "",
              className: 'num',
          },
          {
              "data": "corecount",
              sDefaultContent: "",
              className: 'num',
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}corecount=' + full['corecount'] + '">' + full['corecount'] + '</a>'
              }
          },
          {
              "data": "cputime",
              sDefaultContent: "---",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "gshare",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}gshare=' + full['gshare'] + '">' + full['gshare'] + '</a>'
              }
          },
          {
              "data": "hashtags",
              sDefaultContent: "---",
              "render": function ( data, type, row ) {
                  if (data.length > 0) {
                      var xurl = '{{ xurl|safe }}';
                      var prodsysurl = 'https://prodtask-dev.cern.ch/dkb/#/output_stat/?hashtag=|';
                      var hashtaglist = data.split(',');
                      var hashtaglinks = '';
                      for (var i = 0; i < hashtaglist.length; i++) {
                          if (xurl.indexOf('hashtags') > -1) {
                              hashtaglinks += '<a href = "{{ nohashtagurl }}hashtags={{ requestParams.hashtags }},' + hashtaglist[i] + '">' + hashtaglist[i] + '</a> '
                          }
                          else
                          {
                              hashtaglinks += '<a href = "{{ xurl }}hashtags=' + hashtaglist[i] + '">' + hashtaglist[i] + '</a> '
                          }
                      hashtaglinks += '<a href="' + prodsysurl + hashtaglist[i] + '" target="_blank"><i class="fi-link"></i></a> '
                      }
                      return hashtaglinks;
                  }
                  else {
                      return '---'
                  }
              }
          },
          {
              "data": "site",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}site=' + full['site'] + '">' + full['site'] + '</a>'
              }
          },
          {
              "data": "eventservice",
              sDefaultContent: "---",
              "render": function(data, type, full, meta) {
                  if (data) {
                      return '<a href = "{{ xurl }}eventservice=' + full['eventservice'] + '">' + full['eventservice'] + '</a>'
                  }
                  else {
                      return '---';
                  }
              },
          },
          {
              "data": "jumbo",
              sDefaultContent: "---",
              "render": function(data, type, full, meta) {
                  if (data) {
                      return '<a href = "{{ xurl }}jumbo=' + full['jumbo'] + '">' + full['jumbo'] + '</a>'
                  }
                  else {
                      return '---';
                  }
              },
          },
          {
              "data": "container_name",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  if (data) {
                      return '<a href = "{{ xurl }}container_name=' + full['container_name'] + '">' + full['container_name'] + '</a>'
                  }
                  else {
                      return '---';
                  }
              }
          }

      ],
      "createdRow": function ( row, data, index ) {
          $('td', row).eq(5).addClass(data['superstatus'] + '_fill');
          $('td', row).eq(6).addClass(data['status'] + '_fill');
      }
    })
  }

  function taskListTable(ntasks) {
    $('#tasklist').dataTable({
      //"bRetrieve": true,
      "iDisplayLength": (ntasks < 1000) ? -1 :  1000,
      "lengthMenu": [[20, 50, 100, 1000, -1], [20, 50, 100, 1000,  "All"]],
      "paging": true,
      "scrollX": true,
      "aaSorting": [[15,'desc']],
      "columnDefs": [
          {"type": "num-html", "targets": [1,2,3,4,8,9,10,11,12,13,14,16,17] }
      ],

      "ajax": {
          "processing": true,
          "url": "{% url 'runningProdTasks' %}?tk={{ transKey }}&dt",
          "dataSrc" : ''},
      "aoColumns": [
          {
              "data": "cutcampaign",
              sDefaultContent: "---",
              "render": function(data, type, row, meta) {
                  return '<a href = "{{ xurl }}campaign=' + row['campaign'] + '">'+row['cutcampaign']+'</a>'
               }
          },
          {
              "data": "reqid",
              sDefaultContent: "",
              "render": function ( data, type, full, meta ) {
                  let slice = (full['sliceid'] && full['sliceid'] > 0) ? '#inputList' + full['sliceid'] : '' ;
                  return '<a href = "{{ xurl }}reqid=' + full['reqid'] + '">' + full['reqid'] + '</a> <a href="https://prodtask-dev.cern.ch/prodtask/inputlist_with_request/' + full['reqid'] + '/' + slice + '" target="_blank"><i class="fi-link"></i></a>'
              }
          },
          {
              "data": "inputdataset",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}runnumber=' + full['runnumber'] + '">' + full['inputdataset'] + '</a>'
              }
          },
          {
              "data": "jeditaskid",
              sDefaultContent: "",
              "render": function ( data, type, full, meta ) {
                  return '<a href = "{% url 'taskInfo' %}' + full['jeditaskid'] + '/">' + full['jeditaskid'] + '</a> <a href="https://prodtask-dev.cern.ch/prodtask/task/' + full['jeditaskid'] + '/" target="_blank"><i class="fi-link"></i></a>'
              }
          },
          {
              "data": "rjobs",
              sDefaultContent: "",
              className: 'num',
              "render": function(data, type, full, meta) {
                  if (data > 0) {
                      return '<a href = "{% url 'jobList' %}?jobstatus=running&jeditaskid=' + full['jeditaskid'] + '">' + full['rjobs'] + '</a>'
                  }
                  else {
                      return data;
                  }
              }
          },
          {
              "data": "superstatus",
              sDefaultContent: "",
              className: "state",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}superstatus=' + full['superstatus'] + '">' + full['superstatus'] + '</a>'
              }
          },
          {
              "data": "status",
              sDefaultContent: "",
              className: "state",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}status=' + full['status'] + '">' + full['status'] + '</a>'
              }
          },
          {
              "data": "processingtype",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}processingtype=' + full['processingtype'] + '">' + full['processingtype'] + '</a>'
              }
          },
          {
              "data": "nevents",
              sDefaultContent: "---",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "neventsdone",
              sDefaultContent: "",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "neventsrunning",
              sDefaultContent: "0",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "neventswaiting",
              sDefaultContent: "---",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "neventsfailed",
              sDefaultContent: "",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "percentage",
              sDefaultContent: "",
              className: 'num'
          },
          {
              "data": "priority",
              sDefaultContent: "",
              className: 'num'
          },
          {
              "data": "inputdatasettype",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                if (data && data !== '') {
                  return '<a href = "{{ xurl }}inputdatasettype=' + full['inputdatasettype'] + '">' + full['inputdatasettype'] + '</a>'
                }
                else {
                  return '<a href = "{{ xurl }}inputdatasettype=Not+specified">---</a>'
                }
              }
          },
          {
              "data": "outputdatasettype",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  if (data && data !== '') {
                  return '<a href = "{{ xurl }}outputdatasettype=' + full['outputdatasettype'] + '">' + full['outputdatasettype'] + '</a>'
                }
                else {
                  return '<a href = "{{ xurl }}outputdatasettype=Not+specified">---</a>'
                }
              }
          },
          {
              "data": "age",
              sDefaultContent: "",
              className: 'num',
          },
          {
              "data": "corecount",
              sDefaultContent: "",
              className: 'num',
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}corecount=' + full['corecount'] + '">' + full['corecount'] + '</a>'
              }
          },
          {
              "data": "cputime",
              sDefaultContent: "---",
              className: 'num',
              render: $.fn.dataTable.render.number( ',', '.')
          },
          {
              "data": "gshare",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}gshare=' + full['gshare'] + '">' + full['gshare'] + '</a>'
              }
          },
          {
              "data": "hashtags",
              sDefaultContent: "---",
              "render": function ( data, type, row ) {
                  if (data.length > 0) {
                      var xurl = '{{ xurl|safe }}';
                      var prodsysurl = 'https://prodtask-dev.cern.ch/dkb/#/output_stat/?hashtag=|';
                      var hashtaglist = data.split(',');
                      var hashtaglinks = '';
                      for (var i = 0; i < hashtaglist.length; i++) {
                          if (xurl.indexOf('hashtags') > -1) {
                              hashtaglinks += '<a href = "{{ nohashtagurl }}hashtags={{ requestParams.hashtags }},' + hashtaglist[i] + '">' + hashtaglist[i] + '</a> '
                          }
                          else
                          {
                              hashtaglinks += '<a href = "{{ xurl }}hashtags=' + hashtaglist[i] + '">' + hashtaglist[i] + '</a> '
                          }
                      hashtaglinks += '<a href="' + prodsysurl + hashtaglist[i] + '" target="_blank"><i class="fi-link"></i></a> '
                      }
                      return hashtaglinks;
                  }
                  else {
                      return '---'
                  }
              }
          },
          {
              "data": "site",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  return '<a href = "{{ xurl }}site=' + full['site'] + '">' + full['site'] + '</a>'
              }
          },
          {
              "data": "eventservice",
              sDefaultContent: "---",
              "render": function(data, type, full, meta) {
                  if (data) {
                      return '<a href = "{{ xurl }}eventservice=' + full['eventservice'] + '">' + full['eventservice'] + '</a>'
                  }
                  else {
                      return '---';
                  }
              },
          },
          {
              "data": "jumbo",
              sDefaultContent: "---",
              "render": function(data, type, full, meta) {
                  if (data) {
                      return '<a href = "{{ xurl }}jumbo=' + full['jumbo'] + '">' + full['jumbo'] + '</a>'
                  }
                  else {
                      return '---';
                  }
              },
          },
          {
              "data": "container_name",
              sDefaultContent: "",
              "render": function(data, type, full, meta) {
                  if (data) {
                      return '<a href = "{{ xurl }}container_name=' + full['container_name'] + '">' + full['container_name'] + '</a>'
                  }
                  else {
                      return '---';
                  }
              }
          }

      ],
      "createdRow": function ( row, data, index ) {
          $('td', row).eq(5).addClass(data['superstatus'] + '_fill');
          $('td', row).eq(6).addClass(data['status'] + '_fill');
      }
    })
  }

</script>

{% endblock %}
